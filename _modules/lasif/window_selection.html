

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>lasif.window_selection &mdash; LASIF 0.0.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="LASIF 0.0.1 documentation" href="../../index.html"/>
        <link rel="up" title="lasif" href="../lasif.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="../../index.html" class="icon icon-home"> LASIF
        

        
        </a>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../prerequisites.html">Installation, Testing &amp; DevInfo</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../prerequisites.html#installation">Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../prerequisites.html#requirements">Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../prerequisites.html#installing-lasif">Installing LASIF</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../prerequisites.html#testing">Testing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../prerequisites.html#running-the-tests">Running the Tests</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../prerequisites.html#building-the-documentation">Building the Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../prerequisites.html#developer-information">Developer Information</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../prerequisites.html#terminology">Terminology</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html#further-information">Further Information</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html#to-do-things-that-are-still-missing">TO DO: Things that are still missing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html#supported-data-formats">Supported Data Formats</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html#further-notes">Further Notes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../introduction.html#quakeml-files">QuakeML files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../introduction.html#synthetic-data-files">Synthetic Data Files</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/00_interfaces.html">1. Interfaces</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/00_interfaces.html#command-line-interface">1.1. Command Line Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/00_interfaces.html#web-interface">1.2. Web Interface</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/01_creating_a_new_project.html">2. Creating a New Project</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/01_creating_a_new_project.html#configuration-file">2.1. Configuration File</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/02_seismic_events.html">3. Seismic Events</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/03_station_data.html">4. Station Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/03_station_data.html#naming-scheme">4.1. Naming scheme</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/03_station_data.html#stations-for-tutorial">4.2. Stations for Tutorial</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/04_waveform_data.html">5. Waveform Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/04_waveform_data.html#tutorial-data">5.1. Tutorial Data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/05_download_helpers.html">6. Download Helpers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/05_download_helpers.html#downloading-waveforms">6.1. Downloading Waveforms</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/05_download_helpers.html#downloading-station-metadata">6.2. Downloading Station Metadata</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/06_data_inspection.html">7. Data Inspection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/07_data_validation.html">8. Data Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/08_a_new_iteration.html">9. Defining a New Iteration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/08_a_new_iteration.html#the-iteration-xml-files">9.1. The Iteration XML Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/08_a_new_iteration.html#source-time-functions">9.2. Source Time Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/08_a_new_iteration.html#attenuation">9.3. Attenuation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/08_a_new_iteration.html#data-preprocessing">9.4. Data Preprocessing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/08_a_new_iteration.html#data-rejection">9.5. Data Rejection</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/09_model_handling.html">10. Earth Model Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/10_generating_input_files.html">11. Generating SES3D Input Files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/10_generating_input_files.html#input-file-generation">11.1. Input File Generation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/11_synthetic_waveforms.html">12. Synthetics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/11_synthetic_waveforms.html#recap">12.1. Recap</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/12_misfits_and_adjoint_sources.html">13. Misfit and Adjoint Source Calculation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/12_misfits_and_adjoint_sources.html#weighting-scheme">13.1. Weighting Scheme</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/12_misfits_and_adjoint_sources.html#misfit-gui">13.2. Misfit GUI</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/12_misfits_and_adjoint_sources.html#final-adjoint-source-calculation">13.3. Final Adjoint Source Calculation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/13_model_update.html">14. Model Update</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/14_next_iterations.html">15. Next Iterations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/14_next_iterations.html#create-a-new-iteration-from-scratch">15.1. Create a new iteration from scratch</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/14_next_iterations.html#deriving-from-an-existing-iteration">15.2. Deriving from an existing iteration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/14_next_iterations.html#migrating-the-misfit-windows">15.3. Migrating the misfit windows</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/15_customizing_lasif.html">16. Customizing LASIF</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/15_customizing_lasif.html#common-features-of-the-custom-functions">16.1. Common Features of the Custom Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/15_customizing_lasif.html#custom-preprocessing">16.2. Custom Preprocessing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/15_customizing_lasif.html#custom-synthetic-data-processing">16.3. Custom Synthetic Data Processing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/15_customizing_lasif.html#customize-window-picking">16.4. Customize Window Picking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/15_customizing_lasif.html#customize-the-source-time-function">16.5. Customize the Source Time Function</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">Command Line Interface</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cli.html#mpi">MPI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cli.html#command-documentation">Command Documentation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cli.html#data-acquisition-functions">Data Acquisition Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-download-data">lasif download_data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-add-gcmt-events">lasif add_gcmt_events</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-add-spud-event">lasif add_spud_event</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../cli.html#event-management-functions">Event Management Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-event-info">lasif event_info</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-list-events">lasif list_events</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../cli.html#iteration-management-functions">Iteration Management Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-select-windows">lasif select_windows</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-generate-input-files">lasif generate_input_files</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-calculate-all-adjoint-sources">lasif calculate_all_adjoint_sources</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-finalize-adjoint-sources">lasif finalize_adjoint_sources</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-iteration-status">lasif iteration_status</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-create-successive-iteration">lasif create_successive_iteration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-compare-misfits">lasif compare_misfits</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-preprocess-data">lasif preprocess_data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-list-iterations">lasif list_iterations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-create-new-iteration">lasif create_new_iteration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-migrate-windows">lasif migrate_windows</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-plot-q-model">lasif plot_q_model</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-iteration-info">lasif iteration_info</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-launch-misfit-gui">lasif launch_misfit_gui</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../cli.html#misc-functions">Misc Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-debug">lasif debug</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-shell">lasif shell</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-serve">lasif serve</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-tutorial">lasif tutorial</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-calculate-constant-q-model">lasif calculate_constant_q_model</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../cli.html#plotting-functions">Plotting Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-plot-events">lasif plot_events</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-plot-event">lasif plot_event</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-plot-wavefield">lasif plot_wavefield</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-plot-raydensity">lasif plot_raydensity</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-launch-model-gui">lasif launch_model_gui</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-plot-windows">lasif plot_windows</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-plot-stf">lasif plot_stf</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-plot-domain">lasif plot_domain</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../cli.html#project-management-functions">Project Management Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-info">lasif info</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-list-kernels">lasif list_kernels</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-validate-data">lasif validate_data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-init-project">lasif init_project</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-list-models">lasif list_models</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-remove-empty-coordinate-entries">lasif remove_empty_coordinate_entries</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cli.html#lasif-build-all-caches">lasif build_all_caches</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../webinterface.html">Web Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_doc.html">API Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../iris2quakeml.html">lasif.scripts.iris2quakeml</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ses3d_setup_helper.html">SES3D Setup Assistant</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ses3d_setup_helper.html#module-lasif.scripts.ses3d_setup_helper">Internal Function Documentation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../iteration_xml.html">lasif.iteration_xml</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../rotations.html">lasif.rotations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../window_selection.html">lasif.window_selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tools.html">lasif.tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tools.parallel.html">lasif.tools.parallel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tools.file_info_cache.html">lasif.tools.file_info_cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../components/components.html">API Components</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../components/events.html">EventsComponent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../components/inventory_db.html">InventoryDBComponent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../components/iterations.html">IterationsComponent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../components/stations.html">StationsComponent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../components/waveforms.html">WaveformsComponent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../components/query.html">QueryComponent</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../how_lasif_finds_coordinates.html">How LASIF Finds Coordinates</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">LASIF</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
          <li><a href="../lasif.html">lasif</a> &raquo;</li>
      
    <li>lasif.window_selection</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for lasif.window_selection</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Window selection algorithm.</span>

<span class="sd">This module aims to provide a window selection algorithm suitable for</span>
<span class="sd">calculating phase misfits between two seismic waveforms.</span>

<span class="sd">The main function is the select_windows() function. The selection process is a</span>
<span class="sd">multi-stage process. Initially all time steps are considered to be valid in</span>
<span class="sd">the sense as being suitable for window selection. Then a number of selectors</span>
<span class="sd">is applied, progressively excluding more and more time steps.</span>

<span class="sd">:copyright:</span>
<span class="sd">    Lion Krischer (krischer@geophysik.uni-muenchen.de), 2013</span>

<span class="sd">:license:</span>
<span class="sd">    GNU General Public License, Version 3</span>
<span class="sd">    (http://www.gnu.org/copyleft/gpl.html)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">obspy.core.util</span> <span class="kn">import</span> <span class="n">geodetics</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">argrelextrema</span>


<div class="viewcode-block" id="flatnotmasked_contiguous"><a class="viewcode-back" href="../../window_selection.html#lasif.window_selection.flatnotmasked_contiguous">[docs]</a><span class="k">def</span> <span class="nf">flatnotmasked_contiguous</span><span class="p">(</span><span class="n">time_windows</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function enabling to loop over empty time windows.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">flatnotmasked_contiguous</span><span class="p">(</span><span class="n">time_windows</span><span class="p">)</span>
    <span class="c"># If nothing could be found, set the mask to true (which should already</span>
    <span class="c"># be the case).</span>
    <span class="k">if</span> <span class="n">fc</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fc</span>

</div>
<div class="viewcode-block" id="find_local_extrema"><a class="viewcode-back" href="../../window_selection.html#lasif.window_selection.find_local_extrema">[docs]</a><span class="k">def</span> <span class="nf">find_local_extrema</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function finding local extrema. It can also deal with flat extrema,</span>
<span class="sd">    e.g. a flat top or bottom. In that case the first index of all flat</span>
<span class="sd">    values will be returned.</span>

<span class="sd">    Returns a tuple of maxima and minima indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">flats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">diff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c"># Discard neighbouring flat points.</span>
    <span class="n">new_flats</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">flats</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">flats</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">flats</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">-</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">new_flats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="n">flats</span> <span class="o">=</span> <span class="n">new_flats</span>

    <span class="n">maxima</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">minima</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c"># Go over each flats position and check if its a maxima/minima.</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">flats</span><span class="p">:</span>
        <span class="n">l_type</span> <span class="o">=</span> <span class="s">&quot;left&quot;</span>
        <span class="n">r_type</span> <span class="o">=</span> <span class="s">&quot;right&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
            <span class="n">this_idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">diff</span><span class="p">[</span><span class="n">this_idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">l_type</span> <span class="o">=</span> <span class="s">&quot;minima&quot;</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">diff</span><span class="p">[</span><span class="n">this_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">l_type</span> <span class="o">=</span> <span class="s">&quot;maxima&quot;</span>
                <span class="k">break</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
            <span class="n">this_idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">this_idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">diff</span><span class="p">[</span><span class="n">this_idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">r_type</span> <span class="o">=</span> <span class="s">&quot;maxima&quot;</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">diff</span><span class="p">[</span><span class="n">this_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">r_type</span> <span class="o">=</span> <span class="s">&quot;minima&quot;</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">r_type</span> <span class="o">!=</span> <span class="n">l_type</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">r_type</span> <span class="o">==</span> <span class="s">&quot;maxima&quot;</span><span class="p">:</span>
            <span class="n">maxima</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">minima</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

    <span class="n">maxs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">argrelextrema</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">mins</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">argrelextrema</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="n">peaks</span><span class="p">,</span> <span class="n">troughs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">maxs</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">maxima</span><span class="p">)))),</span>
        <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mins</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">minima</span><span class="p">)))))</span>

    <span class="c"># Special case handling for missing one or the other.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">peaks</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">troughs</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">peaks</span><span class="p">:</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">troughs</span><span class="p">:</span>
            <span class="n">peaks</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">length</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">troughs</span><span class="p">:</span>
            <span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">troughs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">troughs</span><span class="p">:</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">:</span>
            <span class="n">troughs</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">length</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">:</span>
            <span class="n">troughs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">troughs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>

    <span class="c"># Mark the first and last values as well to facilitate the peak and</span>
    <span class="c"># trough marching algorithm</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">peaks</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">troughs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">troughs</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">troughs</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">peaks</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">length</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">peaks</span> <span class="ow">and</span> <span class="n">length</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">troughs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">peaks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">troughs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">troughs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">troughs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="find_closest"><a class="viewcode-back" href="../../window_selection.html#lasif.window_selection.find_closest">[docs]</a><span class="k">def</span> <span class="nf">find_closest</span><span class="p">(</span><span class="n">ref_array</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For every value in target, find the index of ref_array to which</span>
<span class="sd">    the value is closest.</span>

<span class="sd">    from http://stackoverflow.com/a/8929827/1657047</span>

<span class="sd">    :param ref_array: The reference array. Must be sorted!</span>
<span class="sd">    :type ref_array: :class:`numpy.ndarray`</span>
<span class="sd">    :param target: The target array.</span>
<span class="sd">    :type target: :class:`numpy.ndarray`</span>

<span class="sd">    &gt;&gt;&gt; ref_array = np.arange(0, 20.)</span>
<span class="sd">    &gt;&gt;&gt; target = np.array([-2, 100., 2., 2.4, 2.5, 2.6])</span>
<span class="sd">    &gt;&gt;&gt; find_closest(ref_array, target)</span>
<span class="sd">    array([ 0, 19,  2,  2,  3,  3])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># A must be sorted</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">ref_array</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_array</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">left</span> <span class="o">=</span> <span class="n">ref_array</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">ref_array</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">idx</span> <span class="o">-=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">left</span> <span class="o">&lt;</span> <span class="n">right</span> <span class="o">-</span> <span class="n">target</span>
    <span class="k">return</span> <span class="n">idx</span>

</div>
<span class="k">def</span> <span class="nf">_plot_mask</span><span class="p">(</span><span class="n">new_mask</span><span class="p">,</span> <span class="n">old_mask</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function plotting the remaining time segments after an elimination</span>
<span class="sd">    stage.</span>

<span class="sd">    Useful to figure out which stage is responsible for a certain window</span>
<span class="sd">    being picked/rejected.</span>

<span class="sd">    :param new_mask: The mask after the elimination stage.</span>
<span class="sd">    :param old_mask: The mask before the elimination stage.</span>
<span class="sd">    :param name: The name of the elimination stage.</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Lazy imports as not needed by default.</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="kn">as</span> <span class="nn">plt</span>  <span class="c"># NOQA</span>
    <span class="kn">import</span> <span class="nn">matplotlib.patheffects</span> <span class="kn">as</span> <span class="nn">PathEffects</span>  <span class="c"># NOQA</span>

    <span class="n">old_mask</span> <span class="o">=</span> <span class="n">old_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">new_mask</span> <span class="o">=</span> <span class="n">new_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">new_mask</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_xor</span><span class="p">(</span><span class="n">old_mask</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">new_mask</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">old_mask</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">old_mask</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">flatnotmasked_contiguous</span><span class="p">(</span><span class="n">old_mask</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">((</span><span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">stop</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">),</span> <span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span>
                         <span class="n">color</span><span class="o">=</span><span class="s">&quot;gray&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">new_mask</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">new_mask</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">flatnotmasked_contiguous</span><span class="p">(</span><span class="n">new_mask</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">((</span><span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">stop</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">),</span> <span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span>
                         <span class="n">color</span><span class="o">=</span><span class="s">&quot;#fb9a99&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_mask</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">20</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&quot;center&quot;</span><span class="p">,</span>
                 <span class="n">horizontalalignment</span><span class="o">=</span><span class="s">&quot;right&quot;</span><span class="p">,</span>
                 <span class="n">path_effects</span><span class="o">=</span><span class="p">[</span>
                     <span class="n">PathEffects</span><span class="o">.</span><span class="n">withStroke</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s">&quot;white&quot;</span><span class="p">)],</span>
                 <span class="n">fontweight</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_mask</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>


<span class="k">def</span> <span class="nf">_window_generator</span><span class="p">(</span><span class="n">data_length</span><span class="p">,</span> <span class="n">window_width</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple generator yielding start and stop indices for sliding windows.</span>

<span class="sd">    :param data_length: The complete length of the data series over which to</span>
<span class="sd">        slide the window.</span>
<span class="sd">    :param window_width: The desired window width.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">window_start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">window_end</span> <span class="o">=</span> <span class="n">window_start</span> <span class="o">+</span> <span class="n">window_width</span>
        <span class="k">if</span> <span class="n">window_end</span> <span class="o">&gt;</span> <span class="n">data_length</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">window_start</span><span class="p">,</span> <span class="n">window_end</span><span class="p">,</span> <span class="n">window_start</span> <span class="o">+</span> <span class="n">window_width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">window_start</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">_log_window_selection</span><span class="p">(</span><span class="n">tr_id</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function for consistent output during the window selection.</span>

<span class="sd">    :param tr_id: The id of the current trace.</span>
<span class="sd">    :param msg: The message to be printed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;[Window selection for </span><span class="si">%s</span><span class="s">] </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tr_id</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

<span class="c"># Dictionary to cache the TauPyModel so there is no need to reinitialize it</span>
<span class="c"># each time which is a fairly expensive operation.</span>
<span class="n">TAUPY_MODEL_CACHE</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="select_windows"><a class="viewcode-back" href="../../window_selection.html#lasif.window_selection.select_windows">[docs]</a><span class="k">def</span> <span class="nf">select_windows</span><span class="p">(</span><span class="n">data_trace</span><span class="p">,</span> <span class="n">synthetic_trace</span><span class="p">,</span> <span class="n">event_latitude</span><span class="p">,</span>
                   <span class="n">event_longitude</span><span class="p">,</span> <span class="n">event_depth_in_km</span><span class="p">,</span>
                   <span class="n">station_latitude</span><span class="p">,</span> <span class="n">station_longitude</span><span class="p">,</span> <span class="n">minimum_period</span><span class="p">,</span>
                   <span class="n">maximum_period</span><span class="p">,</span>
                   <span class="n">min_cc</span><span class="o">=</span><span class="mf">0.10</span><span class="p">,</span> <span class="n">max_noise</span><span class="o">=</span><span class="mf">0.10</span><span class="p">,</span> <span class="n">max_noise_window</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                   <span class="n">min_velocity</span><span class="o">=</span><span class="mf">2.4</span><span class="p">,</span> <span class="n">threshold_shift</span><span class="o">=</span><span class="mf">0.30</span><span class="p">,</span>
                   <span class="n">threshold_correlation</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">min_length_period</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                   <span class="n">min_peaks_troughs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_energy_ratio</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                   <span class="n">plot</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Window selection algorithm for picking windows suitable for misfit</span>
<span class="sd">    calculation based on phase differences.</span>

<span class="sd">    Returns a list of windows which might be empty due to various reasons.</span>

<span class="sd">    This function is really long and a lot of things. For a more detailed</span>
<span class="sd">    description, please see the LASIF paper.</span>

<span class="sd">    :param data_trace: The data trace.</span>
<span class="sd">    :type data_trace: :class:`~obspy.core.trace.Trace`</span>
<span class="sd">    :param synthetic_trace: The synthetic trace.</span>
<span class="sd">    :type synthetic_trace: :class:`~obspy.core.trace.Trace`</span>
<span class="sd">    :param event_latitude: The event latitude.</span>
<span class="sd">    :type event_latitude: float</span>
<span class="sd">    :param event_longitude: The event longitude.</span>
<span class="sd">    :type event_longitude: float</span>
<span class="sd">    :param event_depth_in_km: The event depth in km.</span>
<span class="sd">    :type event_depth_in_km: float</span>
<span class="sd">    :param station_latitude: The station latitude.</span>
<span class="sd">    :type station_latitude: float</span>
<span class="sd">    :param station_longitude: The station longitude.</span>
<span class="sd">    :type station_longitude: float</span>
<span class="sd">    :param minimum_period: The minimum period of the data in seconds.</span>
<span class="sd">    :type minimum_period: float</span>
<span class="sd">    :param maximum_period: The maximum period of the data in seconds.</span>
<span class="sd">    :type maximum_period: float</span>
<span class="sd">    :param min_cc: Minimum normalised correlation coefficient of the</span>
<span class="sd">        complete traces.</span>
<span class="sd">    :type min_cc: float</span>
<span class="sd">    :param max_noise: Maximum relative noise level for the whole trace.</span>
<span class="sd">        Measured from maximum amplitudes before and after the first arrival.</span>
<span class="sd">    :type max_noise: float</span>
<span class="sd">    :param max_noise_window: Maximum relative noise level for individual</span>
<span class="sd">        windows.</span>
<span class="sd">    :type max_noise_window: float</span>
<span class="sd">    :param min_velocity: All arrivals later than those corresponding to the</span>
<span class="sd">        threshold velocity [km/s] will be excluded.</span>
<span class="sd">    :type min_velocity: float</span>
<span class="sd">    :param threshold_shift: Maximum allowable time shift within a window,</span>
<span class="sd">        as a fraction of the minimum period.</span>
<span class="sd">    :type threshold_shift: float</span>
<span class="sd">    :param threshold_correlation: Minimum normalised correlation coeeficient</span>
<span class="sd">        within a window.</span>
<span class="sd">    :type threshold_correlation: float</span>
<span class="sd">    :param min_length_period: Minimum length of the time windows relative to</span>
<span class="sd">        the minimum period.</span>
<span class="sd">    :type min_length_period: float</span>
<span class="sd">    :param min_peaks_troughs: Minimum number of extrema in an individual</span>
<span class="sd">        time window (excluding the edges).</span>
<span class="sd">    :type min_peaks_troughs: float</span>
<span class="sd">    :param max_energy_ratio: Maximum energy ratio between data and</span>
<span class="sd">        synthetics within a time window. Don&#39;t make this too small!</span>
<span class="sd">    :type max_energy_ratio: float</span>
<span class="sd">    :param verbose: No output by default.</span>
<span class="sd">    :type verbose: bool</span>
<span class="sd">    :param plot: Create a plot of the algortihm while it does its work.</span>
<span class="sd">    :type plot: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Shortcuts to frequently accessed variables.</span>
    <span class="n">data_starttime</span> <span class="o">=</span> <span class="n">data_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
    <span class="n">data_delta</span> <span class="o">=</span> <span class="n">data_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">data_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span>
    <span class="n">npts</span> <span class="o">=</span> <span class="n">data_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span>
    <span class="n">synth</span> <span class="o">=</span> <span class="n">synthetic_trace</span><span class="o">.</span><span class="n">data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data_trace</span><span class="o">.</span><span class="n">data</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">data_trace</span><span class="o">.</span><span class="n">times</span><span class="p">()</span>

    <span class="c"># Fill cache if necessary.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">TAUPY_MODEL_CACHE</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">obspy.taup</span> <span class="kn">import</span> <span class="n">TauPyModel</span>  <span class="c"># NOQA</span>
        <span class="n">TAUPY_MODEL_CACHE</span><span class="p">[</span><span class="s">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TauPyModel</span><span class="p">(</span><span class="s">&quot;AK135&quot;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">TAUPY_MODEL_CACHE</span><span class="p">[</span><span class="s">&quot;model&quot;</span><span class="p">]</span>

    <span class="c"># -------------------------------------------------------------------------</span>
    <span class="c"># Geographical calculations and the time of the first arrival.</span>
    <span class="c"># -------------------------------------------------------------------------</span>
    <span class="n">dist_in_deg</span> <span class="o">=</span> <span class="n">geodetics</span><span class="o">.</span><span class="n">locations2degrees</span><span class="p">(</span><span class="n">station_latitude</span><span class="p">,</span>
                                              <span class="n">station_longitude</span><span class="p">,</span>
                                              <span class="n">event_latitude</span><span class="p">,</span> <span class="n">event_longitude</span><span class="p">)</span>
    <span class="n">dist_in_km</span> <span class="o">=</span> <span class="n">geodetics</span><span class="o">.</span><span class="n">calcVincentyInverse</span><span class="p">(</span>
        <span class="n">station_latitude</span><span class="p">,</span> <span class="n">station_longitude</span><span class="p">,</span> <span class="n">event_latitude</span><span class="p">,</span>
        <span class="n">event_longitude</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1000.0</span>

    <span class="c"># Get only a couple of P phases which should be the first arrival</span>
    <span class="c"># for every epicentral distance. Its quite a bit faster than calculating</span>
    <span class="c"># the arrival times for every phase.</span>
    <span class="c"># Assumes the first sample is the centroid time of the event.</span>
    <span class="n">tts</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_travel_times</span><span class="p">(</span><span class="n">source_depth_in_km</span><span class="o">=</span><span class="n">event_depth_in_km</span><span class="p">,</span>
                                 <span class="n">distance_in_degree</span><span class="o">=</span><span class="n">dist_in_deg</span><span class="p">,</span>
                                 <span class="n">phase_list</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;ttp&quot;</span><span class="p">])</span>
    <span class="c"># Sort just as a safety measure.</span>
    <span class="n">tts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tts</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
    <span class="n">first_tt_arrival</span> <span class="o">=</span> <span class="n">tts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time</span>

    <span class="c"># -------------------------------------------------------------------------</span>
    <span class="c"># Window settings</span>
    <span class="c"># -------------------------------------------------------------------------</span>
    <span class="c"># Number of samples in the sliding window. Currently, the length of the</span>
    <span class="c"># window is set to a multiple of the dominant period of the synthetics.</span>
    <span class="c"># Make sure it is an uneven number; just to have a trivial midpoint</span>
    <span class="c"># definition and one sample does not matter much in any case.</span>
    <span class="n">window_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">minimum_period</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">window_length</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">window_length</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c"># Use a Hanning window. No particular reason for it but its a well-behaved</span>
    <span class="c"># window and has nice spectral properties.</span>
    <span class="n">taper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hanning</span><span class="p">(</span><span class="n">window_length</span><span class="p">)</span>

    <span class="c"># =========================================================================</span>
    <span class="c"># check if whole seismograms are sufficiently correlated and estimate</span>
    <span class="c"># noise level</span>
    <span class="c"># =========================================================================</span>

    <span class="c"># Overall Correlation coefficient.</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">synth</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span> <span class="o">*</span> <span class="n">synth</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">_log_window_selection</span><span class="p">(</span><span class="n">data_trace</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                              <span class="s">&quot;Correlation Coefficient: </span><span class="si">%.4f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cc</span><span class="p">)</span>

    <span class="c"># Estimate noise level from waveforms prior to the first arrival.</span>
    <span class="n">idx_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">first_tt_arrival</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">minimum_period</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span><span class="p">))</span>
    <span class="n">idx_end</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">idx_end</span><span class="p">)</span>
    <span class="n">idx_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">first_tt_arrival</span> <span class="o">-</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">minimum_period</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span><span class="p">))</span>
    <span class="n">idx_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">idx_start</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">idx_start</span> <span class="o">&gt;=</span> <span class="n">idx_end</span><span class="p">:</span>
        <span class="n">idx_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx_end</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>

    <span class="n">noise_absolute</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">idx_start</span><span class="p">:</span><span class="n">idx_end</span><span class="p">]</span><span class="o">.</span><span class="n">ptp</span><span class="p">()</span>
    <span class="n">noise_relative</span> <span class="o">=</span> <span class="n">noise_absolute</span> <span class="o">/</span> <span class="n">data</span><span class="o">.</span><span class="n">ptp</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">_log_window_selection</span><span class="p">(</span><span class="n">data_trace</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                              <span class="s">&quot;Absolute Noise Level: </span><span class="si">%e</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">noise_absolute</span><span class="p">)</span>
        <span class="n">_log_window_selection</span><span class="p">(</span><span class="n">data_trace</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                              <span class="s">&quot;Relative Noise Level: </span><span class="si">%e</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">noise_relative</span><span class="p">)</span>

    <span class="c"># Basic global rejection criteria.</span>
    <span class="n">accept_traces</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cc</span> <span class="o">&lt;</span> <span class="n">min_cc</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">noise_relative</span> <span class="o">&gt;</span> <span class="n">max_noise</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">_log_window_selection</span><span class="p">(</span>
                <span class="n">data_trace</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s">&quot;Correlation </span><span class="si">%.4f</span><span class="s"> is below threshold of </span><span class="si">%.4f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">min_cc</span><span class="p">))</span>
        <span class="n">accept_traces</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">noise_relative</span> <span class="o">&gt;</span> <span class="n">max_noise</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">_log_window_selection</span><span class="p">(</span>
                <span class="n">data_trace</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s">&quot;Noise level </span><span class="si">%e</span><span class="s"> is above threshold of </span><span class="si">%e</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">noise_relative</span><span class="p">,</span>
                                                             <span class="n">max_noise</span><span class="p">))</span>
        <span class="n">accept_traces</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c"># -------------------------------------------------------------------------</span>
    <span class="c"># Initial Plot setup.</span>
    <span class="c"># -------------------------------------------------------------------------</span>
    <span class="c"># All the plot calls are interleaved. I realize this is really ugly but</span>
    <span class="c"># the alternative would be to either have two functions (one with plots,</span>
    <span class="c"># one without) or split the plotting function in various subfunctions,</span>
    <span class="c"># neither of which are acceptable in my opinion. The impact on</span>
    <span class="c"># performance is minimal if plotting is turned off: all imports are lazy</span>
    <span class="c"># and a couple of conditionals are cheap.</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="kn">as</span> <span class="nn">plt</span>  <span class="c"># NOQA</span>
        <span class="kn">import</span> <span class="nn">matplotlib.patheffects</span> <span class="kn">as</span> <span class="nn">PathEffects</span>  <span class="c"># NOQA</span>

        <span class="k">if</span> <span class="n">accept_traces</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
                                <span class="n">wspace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c"># Axes showing the data.</span>
            <span class="n">data_plot</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Only show one axes it the traces are not accepted.</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">synthetic_trace</span><span class="o">.</span><span class="n">times</span><span class="p">(),</span> <span class="n">synth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;#e41a1c&quot;</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="s">&quot;synthetics&quot;</span><span class="p">,</span>  <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

        <span class="c"># Symmetric around y axis.</span>
        <span class="n">middle</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">d_max</span><span class="p">,</span> <span class="n">d_min</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">d_max</span> <span class="o">-</span> <span class="n">middle</span><span class="p">,</span> <span class="n">middle</span> <span class="o">-</span> <span class="n">d_min</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span><span class="n">middle</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="n">middle</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">*</span><span class="n">ylim</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">*</span><span class="n">xlim</span><span class="p">)</span>

        <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.005</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">first_tt_arrival</span><span class="p">,</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s">&quot;#ff7f00&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">first_tt_arrival</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
                 <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.02</span><span class="p">,</span>
                 <span class="s">&quot;first arrival&quot;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&quot;top&quot;</span><span class="p">,</span>
                 <span class="n">horizontalalignment</span><span class="o">=</span><span class="s">&quot;left&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;#ee6e00&quot;</span><span class="p">,</span>
                 <span class="n">path_effects</span><span class="o">=</span><span class="p">[</span>
                     <span class="n">PathEffects</span><span class="o">.</span><span class="n">withStroke</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s">&quot;white&quot;</span><span class="p">)])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">first_tt_arrival</span> <span class="o">-</span> <span class="n">minimum_period</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                   <span class="n">colors</span><span class="o">=</span><span class="s">&quot;#ff7f00&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">first_tt_arrival</span> <span class="o">-</span> <span class="n">minimum_period</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span>
                 <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.02</span><span class="p">,</span>
                 <span class="s">&quot;first arrival - min period / 2&quot;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&quot;bottom&quot;</span><span class="p">,</span>
                 <span class="n">horizontalalignment</span><span class="o">=</span><span class="s">&quot;right&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;#ee6e00&quot;</span><span class="p">,</span>
                 <span class="n">path_effects</span><span class="o">=</span><span class="p">[</span>
                     <span class="n">PathEffects</span><span class="o">.</span><span class="n">withStroke</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s">&quot;white&quot;</span><span class="p">)])</span>

        <span class="k">for</span> <span class="n">velocity</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">min_velocity</span><span class="p">]:</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="n">dist_in_km</span> <span class="o">/</span> <span class="n">velocity</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s">&quot;gray&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">velocity</span> <span class="o">==</span> <span class="n">min_velocity</span><span class="p">:</span>
                <span class="n">hal</span> <span class="o">=</span> <span class="s">&quot;right&quot;</span>
                <span class="n">o_s</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">offset</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hal</span> <span class="o">=</span> <span class="s">&quot;left&quot;</span>
                <span class="n">o_s</span> <span class="o">=</span> <span class="n">offset</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">tt</span> <span class="o">+</span> <span class="n">o_s</span><span class="p">,</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.02</span><span class="p">,</span>
                     <span class="nb">str</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; km/s&quot;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&quot;bottom&quot;</span><span class="p">,</span>
                     <span class="n">horizontalalignment</span><span class="o">=</span><span class="n">hal</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;0.15&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">dist_in_km</span> <span class="o">/</span> <span class="n">min_velocity</span> <span class="o">+</span> <span class="n">minimum_period</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
                   <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s">&quot;gray&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">dist_in_km</span> <span class="o">/</span> <span class="n">min_velocity</span> <span class="o">+</span> <span class="n">minimum_period</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span>
                 <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.02</span><span class="p">,</span>
                 <span class="s">&quot;min surface velocity + min period / 2&quot;</span><span class="p">,</span>
                 <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&quot;top&quot;</span><span class="p">,</span>
                 <span class="n">horizontalalignment</span><span class="o">=</span><span class="s">&quot;right&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;0.15&quot;</span><span class="p">,</span> <span class="n">path_effects</span><span class="o">=</span><span class="p">[</span>
                     <span class="n">PathEffects</span><span class="o">.</span><span class="n">withStroke</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s">&quot;white&quot;</span><span class="p">)])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">noise_absolute</span><span class="p">,</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&quot;--&quot;</span><span class="p">,</span>
                   <span class="n">color</span><span class="o">=</span><span class="s">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="o">-</span><span class="n">noise_absolute</span><span class="p">,</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&quot;--&quot;</span><span class="p">,</span>
                   <span class="n">color</span><span class="o">=</span><span class="s">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">noise_absolute</span> <span class="o">+</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">,</span>
                 <span class="s">&quot;noise level&quot;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&quot;bottom&quot;</span><span class="p">,</span>
                 <span class="n">horizontalalignment</span><span class="o">=</span><span class="s">&quot;left&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;0.15&quot;</span><span class="p">,</span>
                 <span class="n">path_effects</span><span class="o">=</span><span class="p">[</span>
                     <span class="n">PathEffects</span><span class="o">.</span><span class="n">withStroke</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s">&quot;white&quot;</span><span class="p">)])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&quot;lower right&quot;</span><span class="p">,</span> <span class="n">fancybox</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                   <span class="n">fontsize</span><span class="o">=</span><span class="s">&quot;small&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>

        <span class="c"># Plot the basic global information.</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;Total CC Coeff: </span><span class="si">%.4f</span><span class="se">\n</span><span class="s">Absolute Noise: </span><span class="si">%e</span><span class="se">\n</span><span class="s">Relative Noise: </span><span class="si">%e</span><span class="s">&quot;</span> \
            <span class="o">%</span> <span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">noise_absolute</span><span class="p">,</span> <span class="n">noise_relative</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                <span class="n">fontdict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="s">&quot;small&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s">&#39;top&#39;</span><span class="p">),</span>
                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s">&quot;round&quot;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">&quot;Channel </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">data_trace</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s">&quot;larger&quot;</span><span class="p">)</span>

    <span class="c"># Show plot and return if not accepted.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">accept_traces</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">accept_traces</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c"># Initialise masked arrays. The mask will be set to True where no</span>
    <span class="c"># windows are chosen.</span>
    <span class="n">time_windows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">npts</span><span class="p">)</span>
    <span class="n">time_windows</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">old_time_windows</span> <span class="o">=</span> <span class="n">time_windows</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c"># Elimination Stage 1: Eliminate everything half a period before or</span>
    <span class="c"># after the minimum and maximum travel times, respectively.</span>
    <span class="c"># theoretical arrival as positive.</span>
    <span class="n">min_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">first_tt_arrival</span> <span class="o">-</span> <span class="p">(</span><span class="n">minimum_period</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">max_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span>
        <span class="n">dist_in_km</span> <span class="o">/</span> <span class="n">min_velocity</span> <span class="o">+</span> <span class="n">minimum_period</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span><span class="p">))</span>
    <span class="n">time_windows</span><span class="o">.</span><span class="n">mask</span><span class="p">[:</span><span class="n">min_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">time_windows</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">max_idx</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">_plot_mask</span><span class="p">(</span><span class="n">time_windows</span><span class="p">,</span> <span class="n">old_time_windows</span><span class="p">,</span>
                   <span class="n">name</span><span class="o">=</span><span class="s">&quot;TRAVELTIME ELIMINATION&quot;</span><span class="p">)</span>
        <span class="n">old_time_windows</span> <span class="o">=</span> <span class="n">time_windows</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c"># -------------------------------------------------------------------------</span>
    <span class="c"># Compute sliding time shifts and correlation coefficients for time</span>
    <span class="c"># frames that passed the traveltime elimination stage.</span>
    <span class="c"># -------------------------------------------------------------------------</span>
    <span class="c"># Allocate arrays to collect the time dependent values.</span>
    <span class="n">sliding_time_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&quot;float32&quot;</span><span class="p">)</span>
    <span class="n">sliding_time_shift</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">max_cc_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&quot;float32&quot;</span><span class="p">)</span>
    <span class="n">max_cc_coeff</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">for</span> <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span><span class="p">,</span> <span class="n">midpoint_idx</span> <span class="ow">in</span> <span class="n">_window_generator</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span>
                                                              <span class="n">window_length</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">min_idx</span> <span class="o">&lt;</span> <span class="n">midpoint_idx</span> <span class="o">&lt;</span> <span class="n">max_idx</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c"># Slice windows. Create a copy to be able to taper without affecting</span>
        <span class="c"># the original time series.</span>
        <span class="n">data_window</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span> <span class="n">end_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">*</span> <span class="n">taper</span>
        <span class="n">synthetic_window</span> <span class="o">=</span> \
            <span class="n">synth</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span> <span class="n">end_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">*</span> <span class="n">taper</span>

        <span class="c"># Elimination Stage 2: Skip windows that have essentially no energy</span>
        <span class="c"># to avoid instabilities. No windows can be picked in these.</span>
        <span class="k">if</span> <span class="n">synthetic_window</span><span class="o">.</span><span class="n">ptp</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">synth</span><span class="o">.</span><span class="n">ptp</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.001</span><span class="p">:</span>
            <span class="n">time_windows</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">midpoint_idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">continue</span>

        <span class="c"># Calculate the time shift. Here this is defined as the shift of the</span>
        <span class="c"># synthetics relative to the data. So a value of 2, for instance, means</span>
        <span class="c"># that the synthetics are 2 timesteps later then the data.</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">data_window</span><span class="p">,</span> <span class="n">synthetic_window</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;full&quot;</span><span class="p">)</span>

        <span class="n">time_shift</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span> <span class="o">-</span> <span class="n">window_length</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c"># Express the time shift in fraction of the minimum period.</span>
        <span class="n">sliding_time_shift</span><span class="p">[</span><span class="n">midpoint_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time_shift</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span> <span class="o">/</span> <span class="n">minimum_period</span>

        <span class="c"># Normalized cross correlation.</span>
        <span class="n">max_cc_value</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">synthetic_window</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span>
                                          <span class="p">(</span><span class="n">data_window</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">max_cc_coeff</span><span class="p">[</span><span class="n">midpoint_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_cc_value</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">_plot_mask</span><span class="p">(</span><span class="n">time_windows</span><span class="p">,</span> <span class="n">old_time_windows</span><span class="p">,</span>
                   <span class="n">name</span><span class="o">=</span><span class="s">&quot;NO ENERGY IN CC WINDOW&quot;</span><span class="p">)</span>
        <span class="c"># Axes with the CC coeffs</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;lightgray&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="o">-</span><span class="n">threshold_shift</span><span class="p">,</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;gray&quot;</span><span class="p">,</span>
                   <span class="n">linestyle</span><span class="o">=</span><span class="s">&quot;--&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">threshold_shift</span><span class="p">,</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;gray&quot;</span><span class="p">,</span>
                   <span class="n">linestyle</span><span class="o">=</span><span class="s">&quot;--&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="n">threshold_shift</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.03</span><span class="p">,</span>
                 <span class="s">&quot;threshold&quot;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&quot;top&quot;</span><span class="p">,</span>
                 <span class="n">horizontalalignment</span><span class="o">=</span><span class="s">&quot;left&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;0.15&quot;</span><span class="p">,</span>
                 <span class="n">path_effects</span><span class="o">=</span><span class="p">[</span>
                     <span class="n">PathEffects</span><span class="o">.</span><span class="n">withStroke</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s">&quot;white&quot;</span><span class="p">)])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">sliding_time_shift</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;#377eb8&quot;</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="s">&quot;Time shift in fraction of minimum period&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([</span><span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([</span><span class="mi">300</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">1200</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">1800</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&quot;lower right&quot;</span><span class="p">,</span> <span class="n">fancybox</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                   <span class="n">fontsize</span><span class="o">=</span><span class="s">&quot;small&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">threshold_correlation</span><span class="p">,</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;0.15&quot;</span><span class="p">,</span>
                   <span class="n">linestyle</span><span class="o">=</span><span class="s">&quot;--&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;lightgray&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;lightgray&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">threshold_correlation</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.4</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">,</span>
                 <span class="s">&quot;threshold&quot;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&quot;bottom&quot;</span><span class="p">,</span>
                 <span class="n">horizontalalignment</span><span class="o">=</span><span class="s">&quot;left&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;0.15&quot;</span><span class="p">,</span>
                 <span class="n">path_effects</span><span class="o">=</span><span class="p">[</span>
                     <span class="n">PathEffects</span><span class="o">.</span><span class="n">withStroke</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s">&quot;white&quot;</span><span class="p">)])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">max_cc_coeff</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;#4daf4a&quot;</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="s">&quot;Maximum CC coefficient&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([</span><span class="mi">300</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">1200</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">1800</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&quot;lower right&quot;</span><span class="p">,</span> <span class="n">fancybox</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                   <span class="n">fontsize</span><span class="o">=</span><span class="s">&quot;small&quot;</span><span class="p">)</span>

    <span class="c"># Elimination Stage 3: Mark all areas where the normalized cross</span>
    <span class="c"># correlation coefficient is under threshold_correlation as negative</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">old_time_windows</span> <span class="o">=</span> <span class="n">time_windows</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">time_windows</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">max_cc_coeff</span> <span class="o">&lt;</span> <span class="n">threshold_correlation</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">_plot_mask</span><span class="p">(</span><span class="n">time_windows</span><span class="p">,</span> <span class="n">old_time_windows</span><span class="p">,</span>
                   <span class="n">name</span><span class="o">=</span><span class="s">&quot;CORRELATION COEFF THRESHOLD ELIMINATION&quot;</span><span class="p">)</span>

    <span class="c"># Elimination Stage 4: Mark everything with an absolute travel time</span>
    <span class="c"># shift of more than # threshold_shift times the dominant period as</span>
    <span class="c"># negative</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">old_time_windows</span> <span class="o">=</span> <span class="n">time_windows</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">time_windows</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sliding_time_shift</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold_shift</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">_plot_mask</span><span class="p">(</span><span class="n">time_windows</span><span class="p">,</span> <span class="n">old_time_windows</span><span class="p">,</span>
                   <span class="n">name</span><span class="o">=</span><span class="s">&quot;TIME SHIFT THRESHOLD ELIMINATION&quot;</span><span class="p">)</span>

    <span class="c"># Elimination Stage 5: Mark the area around every &quot;travel time shift</span>
    <span class="c"># jump&quot; (based on the traveltime time difference) negative. The width of</span>
    <span class="c"># the area is currently chosen to be a tenth of a dominant period to</span>
    <span class="c"># each side.</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">old_time_windows</span> <span class="o">=</span> <span class="n">time_windows</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">sample_buffer</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">minimum_period</span> <span class="o">/</span> <span class="n">dt</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">))</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">sliding_time_shift</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
        <span class="n">time_windows</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="n">sample_buffer</span><span class="p">:</span> <span class="n">index</span> <span class="o">+</span> <span class="n">sample_buffer</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">_plot_mask</span><span class="p">(</span><span class="n">time_windows</span><span class="p">,</span> <span class="n">old_time_windows</span><span class="p">,</span>
                   <span class="n">name</span><span class="o">=</span><span class="s">&quot;TIME SHIFT JUMPS ELIMINATION&quot;</span><span class="p">)</span>

    <span class="c"># First minimum window length elimination stage. This is cheap and if</span>
    <span class="c"># not done it can easily destabilize the peak-and-trough marching stage</span>
    <span class="c"># which would then have to deal with way more edge cases.</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">old_time_windows</span> <span class="o">=</span> <span class="n">time_windows</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">min_length</span> <span class="o">=</span> \
        <span class="nb">min</span><span class="p">(</span><span class="n">minimum_period</span> <span class="o">/</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">min_length_period</span><span class="p">,</span> <span class="n">maximum_period</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">flatnotmasked_contiguous</span><span class="p">(</span><span class="n">time_windows</span><span class="p">):</span>
        <span class="c"># Step 7: Throw away all windows with a length of less then</span>
        <span class="c"># min_length_period the dominant period.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_length</span><span class="p">:</span>
            <span class="n">time_windows</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">stop</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">_plot_mask</span><span class="p">(</span><span class="n">time_windows</span><span class="p">,</span> <span class="n">old_time_windows</span><span class="p">,</span>
                   <span class="n">name</span><span class="o">=</span><span class="s">&quot;MINIMUM WINDOW LENGTH ELIMINATION 1&quot;</span><span class="p">)</span>

    <span class="c"># -------------------------------------------------------------------------</span>
    <span class="c"># Peak and trough marching algorithm</span>
    <span class="c"># -------------------------------------------------------------------------</span>
    <span class="n">final_windows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">flatnotmasked_contiguous</span><span class="p">(</span><span class="n">time_windows</span><span class="p">):</span>
        <span class="c"># Cut respective windows.</span>
        <span class="n">window_npts</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">i</span><span class="o">.</span><span class="n">start</span>
        <span class="n">synthetic_window</span> <span class="o">=</span> <span class="n">synth</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">stop</span><span class="p">]</span>
        <span class="n">data_window</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">stop</span><span class="p">]</span>

        <span class="c"># Find extrema in the data and the synthetics.</span>
        <span class="n">data_p</span><span class="p">,</span> <span class="n">data_t</span> <span class="o">=</span> <span class="n">find_local_extrema</span><span class="p">(</span><span class="n">data_window</span><span class="p">)</span>
        <span class="n">synth_p</span><span class="p">,</span> <span class="n">synth_t</span> <span class="o">=</span> <span class="n">find_local_extrema</span><span class="p">(</span><span class="n">synthetic_window</span><span class="p">)</span>

        <span class="n">window_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">window_npts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&quot;bool&quot;</span><span class="p">)</span>

        <span class="n">closest_peaks</span> <span class="o">=</span> <span class="n">find_closest</span><span class="p">(</span><span class="n">data_p</span><span class="p">,</span> <span class="n">synth_p</span><span class="p">)</span>
        <span class="n">diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">closest_peaks</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">diffs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">synth_p</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">synth_p</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">synth_p</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">window_mask</span><span class="p">[</span><span class="n">start</span><span class="p">:</span> <span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">closest_troughs</span> <span class="o">=</span> <span class="n">find_closest</span><span class="p">(</span><span class="n">data_t</span><span class="p">,</span> <span class="n">synth_t</span><span class="p">)</span>
        <span class="n">diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">closest_troughs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">diffs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">synth_t</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">synth_t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">synth_t</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">window_mask</span><span class="p">[</span><span class="n">start</span><span class="p">:</span> <span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">window_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">window_mask</span><span class="p">,</span>
                                         <span class="n">mask</span><span class="o">=</span><span class="n">window_mask</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">window_mask</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">flatnotmasked_contiguous</span><span class="p">(</span><span class="n">window_mask</span><span class="p">):</span>
            <span class="n">final_windows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">j</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">j</span><span class="o">.</span><span class="n">stop</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">old_time_windows</span> <span class="o">=</span> <span class="n">time_windows</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">time_windows</span><span class="o">.</span><span class="n">mask</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="ow">in</span> <span class="n">final_windows</span><span class="p">:</span>
        <span class="n">time_windows</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">_plot_mask</span><span class="p">(</span><span class="n">time_windows</span><span class="p">,</span> <span class="n">old_time_windows</span><span class="p">,</span>
                   <span class="n">name</span><span class="o">=</span><span class="s">&quot;PEAK AND TROUGH MARCHING ELIMINATION&quot;</span><span class="p">)</span>

    <span class="c"># Loop through all the time windows, remove windows not satisfying the</span>
    <span class="c"># minimum number of peaks and troughs per window. Acts mainly as a</span>
    <span class="c"># safety guard.</span>
    <span class="n">old_time_windows</span> <span class="o">=</span> <span class="n">time_windows</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">flatnotmasked_contiguous</span><span class="p">(</span><span class="n">old_time_windows</span><span class="p">):</span>
        <span class="n">synthetic_window</span> <span class="o">=</span> <span class="n">synth</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">stop</span><span class="p">]</span>
        <span class="n">data_window</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">stop</span><span class="p">]</span>
        <span class="n">data_p</span><span class="p">,</span> <span class="n">data_t</span> <span class="o">=</span> <span class="n">find_local_extrema</span><span class="p">(</span><span class="n">data_window</span><span class="p">)</span>
        <span class="n">synth_p</span><span class="p">,</span> <span class="n">synth_t</span> <span class="o">=</span> <span class="n">find_local_extrema</span><span class="p">(</span><span class="n">synthetic_window</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">synth_p</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">synth_t</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_p</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_t</span><span class="p">)])</span> <span class="o">&lt;</span> \
                <span class="n">min_peaks_troughs</span><span class="p">:</span>
            <span class="n">time_windows</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">stop</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">_plot_mask</span><span class="p">(</span><span class="n">time_windows</span><span class="p">,</span> <span class="n">old_time_windows</span><span class="p">,</span>
                   <span class="n">name</span><span class="o">=</span><span class="s">&quot;PEAK/TROUGH COUNT ELIMINATION&quot;</span><span class="p">)</span>

    <span class="c"># Second minimum window length elimination stage.</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">old_time_windows</span> <span class="o">=</span> <span class="n">time_windows</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">min_length</span> <span class="o">=</span> \
        <span class="nb">min</span><span class="p">(</span><span class="n">minimum_period</span> <span class="o">/</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">min_length_period</span><span class="p">,</span> <span class="n">maximum_period</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">flatnotmasked_contiguous</span><span class="p">(</span><span class="n">time_windows</span><span class="p">):</span>
        <span class="c"># Step 7: Throw away all windows with a length of less then</span>
        <span class="c"># min_length_period the dominant period.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_length</span><span class="p">:</span>
            <span class="n">time_windows</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">stop</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">_plot_mask</span><span class="p">(</span><span class="n">time_windows</span><span class="p">,</span> <span class="n">old_time_windows</span><span class="p">,</span>
                   <span class="n">name</span><span class="o">=</span><span class="s">&quot;MINIMUM WINDOW LENGTH ELIMINATION 2&quot;</span><span class="p">)</span>

    <span class="c"># Final step, eliminating windows with little energy.</span>
    <span class="n">final_windows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">flatnotmasked_contiguous</span><span class="p">(</span><span class="n">time_windows</span><span class="p">):</span>
        <span class="c"># Again assert a certain minimal length.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">j</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_length</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c"># Compare the energy in the data window and the synthetic window.</span>
        <span class="n">data_energy</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="o">.</span><span class="n">start</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">stop</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">synth_energy</span> <span class="o">=</span> <span class="p">(</span><span class="n">synth</span><span class="p">[</span><span class="n">j</span><span class="o">.</span><span class="n">start</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">stop</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">data_energy</span><span class="p">,</span> <span class="n">synth_energy</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">energies</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_energy_ratio</span> <span class="o">*</span> <span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">_log_window_selection</span><span class="p">(</span>
                    <span class="n">data_trace</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s">&quot;Deselecting window due to energy ratio between &quot;</span>
                    <span class="s">&quot;data and synthetics.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c"># Check that amplitudes in the data are above the noise</span>
        <span class="k">if</span> <span class="n">noise_absolute</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="o">.</span><span class="n">start</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">stop</span><span class="p">]</span><span class="o">.</span><span class="n">ptp</span><span class="p">()</span> <span class="o">&gt;</span> \
                <span class="n">max_noise_window</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">_log_window_selection</span><span class="p">(</span>
                    <span class="n">data_trace</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s">&quot;Deselecting window due having no amplitude above the &quot;</span>
                    <span class="s">&quot;signal to noise ratio.&quot;</span><span class="p">)</span>
        <span class="n">final_windows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">j</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">j</span><span class="o">.</span><span class="n">stop</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">old_time_windows</span> <span class="o">=</span> <span class="n">time_windows</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">time_windows</span><span class="o">.</span><span class="n">mask</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="ow">in</span> <span class="n">final_windows</span><span class="p">:</span>
        <span class="n">time_windows</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">_plot_mask</span><span class="p">(</span><span class="n">time_windows</span><span class="p">,</span> <span class="n">old_time_windows</span><span class="p">,</span>
                   <span class="n">name</span><span class="o">=</span><span class="s">&quot;LITTLE ENERGY ELIMINATION&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">_log_window_selection</span><span class="p">(</span>
            <span class="n">data_trace</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s">&quot;Done, Selected </span><span class="si">%i</span><span class="s"> window(s)&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_windows</span><span class="p">))</span>

    <span class="c"># Final step is to convert the index value windows to actual times.</span>
    <span class="n">windows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="ow">in</span> <span class="n">final_windows</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">data_starttime</span> <span class="o">+</span> <span class="n">start</span> <span class="o">*</span> <span class="n">data_delta</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">data_starttime</span> <span class="o">+</span> <span class="n">stop</span> <span class="o">*</span> <span class="n">data_delta</span>
        <span class="n">windows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="c"># Plot the final windows to the data axes.</span>
        <span class="kn">import</span> <span class="nn">matplotlib.transforms</span> <span class="kn">as</span> <span class="nn">mtransforms</span>  <span class="c"># NOQA</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">data_plot</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">mtransforms</span><span class="o">.</span><span class="n">blended_transform_factory</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="p">,</span>
                                                      <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="ow">in</span> <span class="n">final_windows</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">([</span><span class="n">start</span> <span class="o">*</span> <span class="n">data_delta</span><span class="p">,</span> <span class="n">stop</span> <span class="o">*</span> <span class="n">data_delta</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">facecolor</span><span class="o">=</span><span class="s">&quot;#CDDC39&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">windows</span>

</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">doctest</span>
    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Lion Krischer &amp; Andreas Fichtner.
    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>