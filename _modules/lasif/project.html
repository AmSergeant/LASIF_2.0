

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>lasif.project &mdash; LASIF 0.0.1 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="LASIF 0.0.1 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../index.html" class="fa fa-home"> LASIF</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../prerequisites.html">Installation, Testing &amp; DevInfo</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../prerequisites.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../prerequisites.html#testing">Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../prerequisites.html#developer-information">Developer Information</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html#further-information">Further Information</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html#to-do-things-that-are-still-missing">TO DO: Things that are still missing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html#supported-data-formats">Supported Data Formats</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html#further-notes">Further Notes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#command-line-interface">Command Line Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#creating-a-new-project">Creating a New Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#adding-seismic-events">Adding Seismic Events</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#adding-waveform-data">Adding Waveform Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#station-data">Station Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#download-helpers">Download Helpers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#inspecting-the-data">Inspecting the Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#interlude-validating-the-data">Interlude: Validating the data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#defining-a-new-iteration">Defining a New Iteration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#generating-ses3d-input-files">Generating SES3D Input Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#organizing-the-models">Organizing the Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#synthetics">Synthetics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#misfit-and-adjoint-source-calculation">Misfit and Adjoint Source Calculation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">Command Line Interface</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cli.html#data-acquisition-functions">Data Acquisition Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cli.html#event-management-functions">Event Management Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cli.html#iteration-management-functions">Iteration Management Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cli.html#misc-functions">Misc Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cli.html#plotting-functions">Plotting Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cli.html#project-management-functions">Project Management Functions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api_doc.html">API Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../project.html">lasif.project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../rotations.html">lasif.rotations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../iris2quakeml.html">lasif.scripts.iris2quakeml</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tools.html">lasif.tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tools.parallel.html">lasif.tools.parallel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tools.file_info_cache.html">lasif.tools.file_info_cache</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">LASIF</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>lasif.project</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <h1>Source code for lasif.project</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Project management class.</span>

<span class="sd">It is important to not import necessary things at the method level to make</span>
<span class="sd">importing this file as fast as possible. Otherwise using the command line</span>
<span class="sd">interface feels sluggish and slow. Import things only the functions they are</span>
<span class="sd">needed.</span>

<span class="sd">:copyright: Lion Krischer (krischer@geophysik.uni-muenchen.de), 2013</span>

<span class="sd">:license: GNU General Public License, Version 3</span>
<span class="sd">    (http://www.gnu.org/copyleft/gpl.html)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">colorama</span>
<span class="kn">import</span> <span class="nn">cPickle</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">lasif</span> <span class="kn">import</span> <span class="n">LASIFException</span>
<span class="kn">from</span> <span class="nn">lasif.tools.event_pseudo_dict</span> <span class="kn">import</span> <span class="n">EventPseudoDict</span>


<span class="c"># SES3D currently only identifies synthetics  via the filename. Use this</span>
<span class="c"># template to get the name of a certain file.</span>
<span class="n">SYNTHETIC_FILENAME_TEMPLATE</span> <span class="o">=</span> \
    <span class="s">&quot;{network:_&lt;2}.{station:_&lt;5}.{location:_&lt;3}.{component}&quot;</span>


<div class="viewcode-block" id="Project"><a class="viewcode-back" href="../../project.html#lasif.project.Project">[docs]</a><span class="k">class</span> <span class="nc">Project</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class managing LASIF projects.</span>

<span class="sd">    It represents the heart of LASIF.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_root_path</span><span class="p">,</span> <span class="n">init_project</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Upon intialization, set the paths and read the config file.</span>

<span class="sd">        :type project_root_path: str</span>
<span class="sd">        :param project_root_path: The root path of the project.</span>
<span class="sd">        :type init_project: str</span>
<span class="sd">        :param init_project: Determines whether or not to initialize a new</span>
<span class="sd">            project, e.g. create the necessary folder structure. If a string is</span>
<span class="sd">            passed, the project will be given this name. Otherwise a default</span>
<span class="sd">            name will be chosen. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__setup_paths</span><span class="p">(</span><span class="n">project_root_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">init_project</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__init_new_project</span><span class="p">(</span><span class="n">init_project</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;config_file&quot;</span><span class="p">]):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;Could not find the project&#39;s config file. Wrong project &quot;</span>
                   <span class="s">&quot;path or uninitialized project?&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c"># Easy event access.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">EventPseudoDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;events&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__update_folder_structure</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_config_file</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__setup_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Central place to define all paths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Every key containing the string &quot;file&quot; denotes a file, all others</span>
        <span class="c"># should denote directories.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;root&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;events&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="s">&quot;EVENTS&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="s">&quot;DATA&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;cache&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="s">&quot;CACHE&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;logs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="s">&quot;LOGS&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;models&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="s">&quot;MODELS&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;wavefields&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="s">&quot;WAVEFIELDS&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;iterations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="s">&quot;ITERATIONS&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;synthetics&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="s">&quot;SYNTHETICS&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;kernels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="s">&quot;KERNELS&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;stations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="s">&quot;STATIONS&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="s">&quot;OUTPUT&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;windows&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">root_path</span><span class="p">,</span> <span class="s">&quot;ADJOINT_SOURCES_AND_WINDOWS&quot;</span><span class="p">,</span> <span class="s">&quot;WINDOWS&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;adjoint_sources&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">root_path</span><span class="p">,</span> <span class="s">&quot;ADJOINT_SOURCES_AND_WINDOWS&quot;</span><span class="p">,</span> <span class="s">&quot;ADJOINT_SOURCES&quot;</span><span class="p">)</span>

        <span class="c"># Station file subfolders.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;dataless_seed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;stations&quot;</span><span class="p">],</span>
                                                   <span class="s">&quot;SEED&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;station_xml&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;stations&quot;</span><span class="p">],</span>
                                                 <span class="s">&quot;StationXML&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;resp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;stations&quot;</span><span class="p">],</span>
                                          <span class="s">&quot;RESP&quot;</span><span class="p">)</span>

        <span class="c"># Paths for various files.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;config_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span>
                                                 <span class="s">&quot;config.xml&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;config_file_cache&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;cache&quot;</span><span class="p">],</span> <span class="s">&quot;config.xml_cache.pickle&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;inv_db_file&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;cache&quot;</span><span class="p">],</span> <span class="s">&quot;inventory_db.sqlite&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__update_folder_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the folder structure of the project.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="s">&quot;file&quot;</span> <span class="ow">in</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">folders</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;synthetics&quot;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
                <span class="n">event_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">event_folder</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">event_folder</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init_new_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a new project. This currently just means that it creates a</span>
<span class="sd">        default config file. The folder structure is checked and rebuilt every</span>
<span class="sd">        time the project is initialized anyways.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
        <span class="kn">from</span> <span class="nn">lxml.builder</span> <span class="kn">import</span> <span class="n">E</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">project_name</span><span class="p">:</span>
            <span class="n">project_name</span> <span class="o">=</span> <span class="s">&quot;LASIFProject&quot;</span>

        <span class="n">doc</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">lasif_project</span><span class="p">(</span>
            <span class="n">E</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="n">project_name</span><span class="p">),</span>
            <span class="n">E</span><span class="o">.</span><span class="n">description</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">),</span>
            <span class="n">E</span><span class="o">.</span><span class="n">download_settings</span><span class="p">(</span>
                <span class="n">E</span><span class="o">.</span><span class="n">arclink_username</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">),</span>
                <span class="n">E</span><span class="o">.</span><span class="n">seconds_before_event</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mi">300</span><span class="p">)),</span>
                <span class="n">E</span><span class="o">.</span><span class="n">seconds_after_event</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mi">3600</span><span class="p">))),</span>
            <span class="n">E</span><span class="o">.</span><span class="n">domain</span><span class="p">(</span>
                <span class="n">E</span><span class="o">.</span><span class="n">domain_bounds</span><span class="p">(</span>
                    <span class="n">E</span><span class="o">.</span><span class="n">minimum_longitude</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">)),</span>
                    <span class="n">E</span><span class="o">.</span><span class="n">maximum_longitude</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mi">20</span><span class="p">)),</span>
                    <span class="n">E</span><span class="o">.</span><span class="n">minimum_latitude</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">)),</span>
                    <span class="n">E</span><span class="o">.</span><span class="n">maximum_latitude</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mi">20</span><span class="p">)),</span>
                    <span class="n">E</span><span class="o">.</span><span class="n">minimum_depth_in_km</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)),</span>
                    <span class="n">E</span><span class="o">.</span><span class="n">maximum_depth_in_km</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mf">200.0</span><span class="p">)),</span>
                    <span class="n">E</span><span class="o">.</span><span class="n">boundary_width_in_degree</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mf">3.0</span><span class="p">))),</span>
                <span class="n">E</span><span class="o">.</span><span class="n">domain_rotation</span><span class="p">(</span>
                    <span class="n">E</span><span class="o">.</span><span class="n">rotation_axis_x</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)),</span>
                    <span class="n">E</span><span class="o">.</span><span class="n">rotation_axis_y</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)),</span>
                    <span class="n">E</span><span class="o">.</span><span class="n">rotation_axis_z</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)),</span>
                    <span class="n">E</span><span class="o">.</span><span class="n">rotation_angle_in_degree</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="mf">45.0</span><span class="p">)))))</span>

        <span class="n">string_doc</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                    <span class="n">xml_declaration</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;config_file&quot;</span><span class="p">],</span> <span class="s">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">open_file</span><span class="p">:</span>
            <span class="n">open_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string_doc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pretty string representation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">lasif.utils</span> <span class="kn">import</span> <span class="n">sizeof_fmt</span>
        <span class="c"># Count all files and sizes.</span>

        <span class="n">raw_data_file_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">processed_data_file_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">synthetic_data_file_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">station_file_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">project_filesize</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;root&quot;</span><span class="p">]):</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">_i</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">])</span>
            <span class="n">project_filesize</span> <span class="o">+=</span> <span class="n">size</span>
            <span class="k">if</span> <span class="n">dirpath</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">dirpath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;raw&quot;</span><span class="p">):</span>
                    <span class="n">raw_data_file_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s">&quot;processed&quot;</span> <span class="ow">in</span> <span class="n">dirpath</span><span class="p">:</span>
                    <span class="n">processed_data_file_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dirpath</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;synthetics&quot;</span><span class="p">]):</span>
                <span class="n">synthetic_data_file_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dirpath</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;stations&quot;</span><span class="p">]):</span>
                <span class="n">station_file_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>

        <span class="n">ret_str</span> <span class="o">=</span> <span class="s">&quot;LASIF project </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">ret_str</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Description: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;description&quot;</span><span class="p">]</span>
        <span class="n">ret_str</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Project root: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;root&quot;</span><span class="p">]</span>
        <span class="n">ret_str</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Content:</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="n">ret_str</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="si">%i</span><span class="s"> events</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">)</span>
        <span class="n">ret_str</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="si">%i</span><span class="s"> station files</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">station_file_count</span>
        <span class="n">ret_str</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="si">%i</span><span class="s"> raw waveform files</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">raw_data_file_count</span>
        <span class="n">ret_str</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="si">%i</span><span class="s"> processed waveform files </span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> \
            <span class="n">processed_data_file_count</span>
        <span class="n">ret_str</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="si">%i</span><span class="s"> synthetic waveform files</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> \
            <span class="n">synthetic_data_file_count</span>

        <span class="n">ret_str</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Total project size: </span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span> \
            <span class="n">sizeof_fmt</span><span class="p">(</span><span class="n">project_filesize</span><span class="p">)</span>

        <span class="c"># Add information about the domain.</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">domain</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;bounds&quot;</span><span class="p">])</span>
        <span class="n">domain</span><span class="p">[</span><span class="s">&quot;latitude_extend&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">domain</span><span class="p">[</span><span class="s">&quot;maximum_latitude&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">domain</span><span class="p">[</span><span class="s">&quot;minimum_latitude&quot;</span><span class="p">]</span>
        <span class="n">domain</span><span class="p">[</span><span class="s">&quot;latitude_extend_in_km&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">domain</span><span class="p">[</span><span class="s">&quot;latitude_extend&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">111.32</span>
        <span class="n">domain</span><span class="p">[</span><span class="s">&quot;longitude_extend&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">domain</span><span class="p">[</span><span class="s">&quot;maximum_longitude&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">domain</span><span class="p">[</span><span class="s">&quot;minimum_longitude&quot;</span><span class="p">]</span>
        <span class="n">domain</span><span class="p">[</span><span class="s">&quot;longitude_extend_in_km&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">domain</span><span class="p">[</span><span class="s">&quot;longitude_extend&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">111.32</span>
        <span class="n">domain</span><span class="p">[</span><span class="s">&quot;depth_extend_in_km&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">domain</span><span class="p">[</span><span class="s">&quot;maximum_depth_in_km&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">domain</span><span class="p">[</span><span class="s">&quot;minimum_depth_in_km&quot;</span><span class="p">]</span>
        <span class="n">ret_str</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="s">u&quot;</span><span class="se">\t</span><span class="s">Latitude: {minimum_latitude:.2f}° - {maximum_latitude:.2f}°&quot;</span>
            <span class="s">u&quot; (total of {latitude_extend:.2f}° &quot;</span>
            <span class="s">u&quot;≅ {latitude_extend_in_km} km)</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="s">u&quot;</span><span class="se">\t</span><span class="s">Longitude: {minimum_longitude:.2f}° - {maximum_longitude:.2f}°&quot;</span>
            <span class="s">u&quot; (total of {longitude_extend:.2f}° &quot;</span>
            <span class="s">u&quot;≅ {longitude_extend_in_km} km)</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="s">u&quot;</span><span class="se">\t</span><span class="s">Depth: {minimum_depth_in_km}km - {maximum_depth_in_km}km&quot;</span>
            <span class="s">u&quot; (total of {depth_extend_in_km}km)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">domain</span><span class="p">)</span>

        <span class="c"># Add information about rotation axis.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_angle&quot;</span><span class="p">]:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_axis&quot;</span><span class="p">]</span>
            <span class="n">ret_str</span> <span class="o">+=</span> \
                <span class="s">u&quot;</span><span class="se">\t</span><span class="s">Domain rotated around axis </span><span class="si">%.1f</span><span class="s">/</span><span class="si">%.1f</span><span class="s">/</span><span class="si">%.1f</span><span class="s"> for </span><span class="si">%.2f</span><span class="s">°&quot;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_angle&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret_str</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Domain is not rotated.&quot;</span>

        <span class="k">return</span> <span class="n">ret_str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Project.get_station_filename"><a class="viewcode-back" href="../../project.html#lasif.project.Project.get_station_filename">[docs]</a>    <span class="k">def</span> <span class="nf">get_station_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
                             <span class="n">file_format</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function returning the filename a station file of a certain format</span>
<span class="sd">        should be written to. Only useful as a callback function.</span>

<span class="sd">        :type file_format: str</span>
<span class="sd">        :param file_format: &#39;datalessSEED&#39;, &#39;StationXML&#39;, or &#39;RESP&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">file_format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;datalessSEED&quot;</span><span class="p">,</span> <span class="s">&quot;StationXML&quot;</span><span class="p">,</span> <span class="s">&quot;RESP&quot;</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Unknown format &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">file_format</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s">&quot;datalessSEED&quot;</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">seed_filename_generator</span><span class="p">():</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;dataless_seed&quot;</span><span class="p">],</span>
                        <span class="s">&quot;dataless.{network}_{station}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">network</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">i</span><span class="p">:</span>
                        <span class="n">filename</span> <span class="o">+=</span> <span class="s">&quot;.</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">i</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">yield</span> <span class="n">filename</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">seed_filename_generator</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                    <span class="k">break</span>
            <span class="k">return</span> <span class="n">filename</span>
        <span class="k">if</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s">&quot;RESP&quot;</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">resp_filename_generator</span><span class="p">():</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;resp&quot;</span><span class="p">],</span>
                        <span class="s">&quot;RESP.{network}.{station}.{location}.{channel}&quot;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">network</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">,</span>
                                <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">i</span><span class="p">:</span>
                        <span class="n">filename</span> <span class="o">+=</span> <span class="s">&quot;.</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">i</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">yield</span> <span class="n">filename</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">resp_filename_generator</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                    <span class="k">break</span>
            <span class="k">return</span> <span class="n">filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="Project._read_config_file"><a class="viewcode-back" href="../../project.html#lasif.project.Project._read_config_file">[docs]</a>    <span class="k">def</span> <span class="nf">_read_config_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the config file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Attempt to read the cached config file. This might seem excessive but</span>
        <span class="c"># since this file is read every single time a LASIF command is used it</span>
        <span class="c"># makes difference at least in the perceived speed of LASIF.</span>
        <span class="n">cfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;config_file_cache&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cfile</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cfile</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">cf_cache</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="n">last_m_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;config_file&quot;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">last_m_time</span> <span class="o">==</span> <span class="n">cf_cache</span><span class="p">[</span><span class="s">&quot;last_m_time&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">cf_cache</span><span class="p">[</span><span class="s">&quot;config&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">cf_cache</span><span class="p">[</span><span class="s">&quot;domain&quot;</span><span class="p">]</span>
                <span class="k">return</span>

        <span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;config_file&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;description&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="c"># The description field is the only field allowed to be empty.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;description&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;download_settings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dl_settings</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;download_settings&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;download_settings&quot;</span><span class="p">][</span><span class="s">&quot;arclink_username&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">dl_settings</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;arclink_username&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;download_settings&quot;</span><span class="p">][</span><span class="s">&quot;seconds_before_event&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="nb">float</span><span class="p">(</span><span class="n">dl_settings</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;seconds_before_event&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;download_settings&quot;</span><span class="p">][</span><span class="s">&quot;seconds_after_event&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="nb">float</span><span class="p">(</span><span class="n">dl_settings</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;seconds_after_event&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="c"># Read the domain.</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;domain&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;bounds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">bounds</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;domain_bounds&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;bounds&quot;</span><span class="p">][</span><span class="s">&quot;minimum_latitude&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="nb">float</span><span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;minimum_latitude&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;bounds&quot;</span><span class="p">][</span><span class="s">&quot;maximum_latitude&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="nb">float</span><span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;maximum_latitude&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;bounds&quot;</span><span class="p">][</span><span class="s">&quot;minimum_longitude&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="nb">float</span><span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;minimum_longitude&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;bounds&quot;</span><span class="p">][</span><span class="s">&quot;maximum_longitude&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="nb">float</span><span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;maximum_longitude&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;bounds&quot;</span><span class="p">][</span><span class="s">&quot;minimum_depth_in_km&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="nb">float</span><span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;minimum_depth_in_km&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;bounds&quot;</span><span class="p">][</span><span class="s">&quot;maximum_depth_in_km&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="nb">float</span><span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;maximum_depth_in_km&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;bounds&quot;</span><span class="p">][</span><span class="s">&quot;boundary_width_in_degree&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="nb">float</span><span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;boundary_width_in_degree&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="n">rotation</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;domain_rotation&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_axis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">rotation</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;rotation_axis_x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">),</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">rotation</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;rotation_axis_y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">),</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">rotation</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;rotation_axis_z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_angle&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="nb">float</span><span class="p">(</span><span class="n">rotation</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;rotation_angle_in_degree&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="c"># Write cache file.</span>
        <span class="n">cf_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cf_cache</span><span class="p">[</span><span class="s">&quot;config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="n">cf_cache</span><span class="p">[</span><span class="s">&quot;domain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span>
        <span class="n">cf_cache</span><span class="p">[</span><span class="s">&quot;last_m_time&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;config_file&quot;</span><span class="p">]))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cfile</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cf_cache</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Project.get_model_dict"><a class="viewcode-back" href="../../project.html#lasif.project.Project.get_model_dict">[docs]</a>    <span class="k">def</span> <span class="nf">get_model_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictonary with all models in the project, the keys are the</span>
<span class="sd">        model names and the values the full paths to each model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;models&quot;</span><span class="p">],</span> <span class="n">_i</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;models&quot;</span><span class="p">])]</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">_i</span><span class="p">)</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">contents</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">_i</span><span class="p">)]</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">_i</span><span class="p">):</span> <span class="n">_i</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">models</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">models</span>
</div>
<div class="viewcode-block" id="Project.plot_domain"><a class="viewcode-back" href="../../project.html#lasif.project.Project.plot_domain">[docs]</a>    <span class="k">def</span> <span class="nf">plot_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the simulation domain and the actual physical domain.</span>

<span class="sd">        Wrapper around one of the visualization routines.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">lasif</span> <span class="kn">import</span> <span class="n">visualization</span>

        <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;bounds&quot;</span><span class="p">]</span>
        <span class="n">visualization</span><span class="o">.</span><span class="n">plot_domain</span><span class="p">(</span>
            <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;minimum_latitude&quot;</span><span class="p">],</span>
            <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;maximum_latitude&quot;</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;minimum_longitude&quot;</span><span class="p">],</span>
            <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;maximum_longitude&quot;</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;boundary_width_in_degree&quot;</span><span class="p">],</span>
            <span class="n">rotation_axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_axis&quot;</span><span class="p">],</span>
            <span class="n">rotation_angle_in_degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_angle&quot;</span><span class="p">],</span>
            <span class="n">plot_simulation_domain</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Project.plot_Q_model"><a class="viewcode-back" href="../../project.html#lasif.project.Project.plot_Q_model">[docs]</a>    <span class="k">def</span> <span class="nf">plot_Q_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the Q model for a given iteration. Will only work if the</span>
<span class="sd">        iteration uses SES3D as its solver.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">lasif.tools.Q_discrete</span> <span class="kn">import</span> <span class="n">plot</span>

        <span class="n">iteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_iteration</span><span class="p">(</span><span class="n">iteration_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iteration</span><span class="o">.</span><span class="n">solver_settings</span><span class="p">[</span><span class="s">&quot;solver&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&quot;ses3d 4.1&quot;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Only works for SES3D 4.1&quot;</span>
            <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">proc_params</span> <span class="o">=</span> <span class="n">iteration</span><span class="o">.</span><span class="n">get_process_params</span><span class="p">()</span>
        <span class="n">f_min</span> <span class="o">=</span> <span class="n">proc_params</span><span class="p">[</span><span class="s">&quot;highpass&quot;</span><span class="p">]</span>
        <span class="n">f_max</span> <span class="o">=</span> <span class="n">proc_params</span><span class="p">[</span><span class="s">&quot;lowpass&quot;</span><span class="p">]</span>

        <span class="n">relax</span> <span class="o">=</span> <span class="n">iteration</span><span class="o">.</span><span class="n">solver_settings</span><span class="p">[</span><span class="s">&quot;solver_settings&quot;</span><span class="p">][</span>
            <span class="s">&quot;relaxation_parameter_list&quot;</span><span class="p">]</span>
        <span class="n">tau_p</span> <span class="o">=</span> <span class="n">relax</span><span class="p">[</span><span class="s">&quot;tau&quot;</span><span class="p">]</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">relax</span><span class="p">[</span><span class="s">&quot;w&quot;</span><span class="p">]</span>

        <span class="n">plot</span><span class="p">(</span><span class="n">D_p</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">tau_p</span><span class="o">=</span><span class="n">tau_p</span><span class="p">,</span> <span class="n">f_min</span><span class="o">=</span><span class="n">f_min</span><span class="p">,</span> <span class="n">f_max</span><span class="o">=</span><span class="n">f_max</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Project.get_kernel_dir"><a class="viewcode-back" href="../../project.html#lasif.project.Project.get_kernel_dir">[docs]</a>    <span class="k">def</span> <span class="nf">get_kernel_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration_name</span><span class="p">,</span> <span class="n">event_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;kernels&quot;</span><span class="p">],</span> <span class="n">event_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span>
                            <span class="n">_get_long_iteration_name</span><span class="p">(</span><span class="n">iteration_name</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Project.create_new_iteration"><a class="viewcode-back" href="../../project.html#lasif.project.Project.create_new_iteration">[docs]</a>    <span class="k">def</span> <span class="nf">create_new_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration_name</span><span class="p">,</span> <span class="n">solver_name</span><span class="p">,</span> <span class="n">min_period</span><span class="o">=</span><span class="mf">8.0</span><span class="p">,</span>
                             <span class="n">max_period</span><span class="o">=</span><span class="mf">100.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new iteration file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">lasif</span> <span class="kn">import</span> <span class="n">iteration_xml</span>

        <span class="n">iteration_name</span> <span class="o">=</span> <span class="n">iteration_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_long_iteration_name</span><span class="p">(</span><span class="n">iteration_name</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_long_iteration_name</span><span class="p">(</span><span class="n">iteration_name</span><span class="p">)</span> <span class="o">+</span> \
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">extsep</span> <span class="o">+</span> <span class="s">&quot;xml&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;iterations&quot;</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Iteration already exists.&quot;</span>
            <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c"># Get a dictionary containing the event names as keys and a list of</span>
        <span class="c"># stations per event as values.</span>
        <span class="n">events_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stations_for_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">LASIFException</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">events_dict</span><span class="p">[</span><span class="n">event</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>

        <span class="n">xml_string</span> <span class="o">=</span> <span class="n">iteration_xml</span><span class="o">.</span><span class="n">create_iteration_xml_string</span><span class="p">(</span>
            <span class="n">iteration_name</span><span class="p">,</span> <span class="n">solver_name</span><span class="p">,</span> <span class="n">events_dict</span><span class="p">,</span> <span class="n">min_period</span><span class="o">=</span><span class="n">min_period</span><span class="p">,</span>
            <span class="n">max_period</span><span class="o">=</span><span class="n">max_period</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">xml_string</span><span class="p">)</span>

        <span class="k">print</span> <span class="s">&quot;Created iteration </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">iteration_name</span>
</div>
<div class="viewcode-block" id="Project.get_iteration_dict"><a class="viewcode-back" href="../../project.html#lasif.project.Project.get_iteration_dict">[docs]</a>    <span class="k">def</span> <span class="nf">get_iteration_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictonary with all iterations in the project, the keys are</span>
<span class="sd">        the iteration names and the values the full paths to each iteration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">iterations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;iterations&quot;</span><span class="p">],</span>
                                                 <span class="s">&quot;*</span><span class="si">%s</span><span class="s">xml&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">extsep</span><span class="p">)):</span>
            <span class="n">iteration</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span>
            <span class="n">iteration_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">iteration</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">iteration_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;ITERATION_&quot;</span><span class="p">):</span>
                <span class="n">iteration_name</span> <span class="o">=</span> <span class="n">iteration_name</span><span class="p">[</span><span class="mi">10</span><span class="p">:]</span>
            <span class="n">iterations</span><span class="p">[</span><span class="n">iteration_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">iteration</span>
        <span class="k">return</span> <span class="n">iterations</span>
</div>
<div class="viewcode-block" id="Project._get_iteration"><a class="viewcode-back" href="../../project.html#lasif.project.Project._get_iteration">[docs]</a>    <span class="k">def</span> <span class="nf">_get_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method to read a certain iteration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">lasif.iteration_xml</span> <span class="kn">import</span> <span class="n">Iteration</span>

        <span class="n">iterations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_iteration_dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">iteration_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">iterations</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Could not find iteration &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="n">iteration_name</span>
            <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Iteration</span><span class="p">(</span><span class="n">iterations</span><span class="p">[</span><span class="n">iteration_name</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="Project.preprocess_data"><a class="viewcode-back" href="../../project.html#lasif.project.Project.preprocess_data">[docs]</a>    <span class="k">def</span> <span class="nf">preprocess_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration_name</span><span class="p">,</span> <span class="n">event_ids</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                        <span class="n">waiting_time</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preprocesses all data for a given iteration.</span>

<span class="sd">        :param waiting_time: The time spent sleeping after the initial message</span>
<span class="sd">            has been printed. Useful if the user should be given the chance to</span>
<span class="sd">            cancel the processing.</span>
<span class="sd">        :param event_ids: event_ids is a list of events to process in this run.</span>
<span class="sd">            It will process all events if not given.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">lasif</span> <span class="kn">import</span> <span class="n">preprocessing</span>
        <span class="kn">import</span> <span class="nn">obspy</span>

        <span class="n">iteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_iteration</span><span class="p">(</span><span class="n">iteration_name</span><span class="p">)</span>

        <span class="n">process_params</span> <span class="o">=</span> <span class="n">iteration</span><span class="o">.</span><span class="n">get_process_params</span><span class="p">()</span>
        <span class="n">processing_tag</span> <span class="o">=</span> <span class="n">iteration</span><span class="o">.</span><span class="n">get_processing_tag</span><span class="p">()</span>

        <span class="c"># =====================================================================</span>
        <span class="c"># Waveform information generator for event information</span>
        <span class="c"># =====================================================================</span>

        <span class="k">def</span> <span class="nf">processing_data_generator</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Generate a dictionary with information for processing for each</span>
<span class="sd">            waveform.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c"># Loop over the chosen events.</span>
            <span class="k">for</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">iteration</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="c"># None means to process all events, otherwise it will be a list</span>
                <span class="c"># of events.</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">event_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">event_name</span> <span class="ow">in</span> <span class="n">event_ids</span><span class="p">):</span>

                    <span class="n">event_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">event_name</span><span class="p">]</span>

                    <span class="c"># The folder where all preprocessed data for this event</span>
                    <span class="c"># will go.</span>
                    <span class="n">event_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">],</span>
                                                   <span class="n">event_name</span><span class="p">,</span> <span class="n">processing_tag</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">event_data_path</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">event_data_path</span><span class="p">)</span>

                    <span class="c"># Folder for processing logfiles. Logfile.</span>
                    <span class="n">logfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;logs&quot;</span><span class="p">],</span>
                                                <span class="s">&quot;PROCESSING&quot;</span><span class="p">,</span> <span class="n">event_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">logfile_path</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">logfile_path</span><span class="p">)</span>

                    <span class="n">logfile_name</span> <span class="o">=</span> <span class="n">logfile_path</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">processing_tag</span> <span class="o">+</span> \
                        <span class="s">&quot;.at.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">())</span>

                    <span class="c"># All stations that will be processed for this iteration</span>
                    <span class="c"># and event.</span>
                    <span class="n">stations</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s">&quot;stations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="n">waveforms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_waveform_cache_file</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span>
                                                              <span class="s">&quot;raw&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">waveforms</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;Could not find any waveforms for event &quot;</span>
                               <span class="s">&quot;{event}. Will be skipped.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                   <span class="n">event</span><span class="o">=</span><span class="n">event_name</span><span class="p">))</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c"># loop over waveforms in the event =======================</span>
                    <span class="k">for</span> <span class="n">waveform</span> <span class="ow">in</span> <span class="n">waveforms</span><span class="o">.</span><span class="n">get_values</span><span class="p">():</span>
                        <span class="n">station_id</span> <span class="o">=</span> <span class="s">&quot;{network}.{station}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">waveform</span><span class="p">)</span>

                        <span class="c"># Only process data from stations needed for the</span>
                        <span class="c"># current iteration.</span>
                        <span class="k">if</span> <span class="n">station_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="c"># Generate the new filename for the waveform. If it</span>
                        <span class="c"># already exists, continue.</span>
                        <span class="n">processed_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">event_data_path</span><span class="p">,</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">waveform</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">]))</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">processed_filename</span><span class="p">):</span>
                            <span class="k">continue</span>

                        <span class="n">ret_dict</span> <span class="o">=</span> <span class="n">process_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">ret_dict</span><span class="p">[</span><span class="s">&quot;data_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">waveform</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">]</span>
                        <span class="n">ret_dict</span><span class="p">[</span><span class="s">&quot;processed_data_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_filename</span>
                        <span class="n">ret_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">event_info</span><span class="p">)</span>
                        <span class="n">ret_dict</span><span class="p">[</span><span class="s">&quot;station_filename&quot;</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">station_cache</span><span class="o">.</span><span class="n">get_station_filename</span><span class="p">(</span>
                                <span class="n">waveform</span><span class="p">[</span><span class="s">&quot;channel_id&quot;</span><span class="p">],</span>
                                <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span>
                                    <span class="n">waveform</span><span class="p">[</span><span class="s">&quot;starttime_timestamp&quot;</span><span class="p">]))</span>
                        <span class="n">ret_dict</span><span class="p">[</span><span class="s">&quot;logfile_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">logfile_name</span>

                        <span class="k">yield</span> <span class="n">ret_dict</span>

        <span class="n">logfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_output_folder</span><span class="p">(</span><span class="s">&quot;data_preprocessing&quot;</span><span class="p">),</span>
                               <span class="s">&quot;log.txt&quot;</span><span class="p">)</span>
        <span class="n">file_count</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">launch_processing</span><span class="p">(</span>
            <span class="n">processing_data_generator</span><span class="p">(),</span> <span class="n">log_filename</span><span class="o">=</span><span class="n">logfile</span><span class="p">,</span>
            <span class="n">waiting_time</span><span class="o">=</span><span class="n">waiting_time</span><span class="p">,</span> <span class="n">process_params</span><span class="o">=</span><span class="n">process_params</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Finished processing </span><span class="si">%i</span><span class="s"> files.&quot;</span> <span class="o">%</span>
              <span class="n">file_count</span><span class="p">[</span><span class="s">&quot;total_file_count&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">file_count</span><span class="p">[</span><span class="s">&quot;failed_file_count&quot;</span><span class="p">]:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="si">%s%i</span><span class="s"> files failed being processed.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span><span class="p">,</span> <span class="n">file_count</span><span class="p">[</span><span class="s">&quot;failed_file_count&quot;</span><span class="p">],</span>
                   <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">file_count</span><span class="p">[</span><span class="s">&quot;warning_file_count&quot;</span><span class="p">]:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="si">%s%i</span><span class="s"> files raised warnings while being processed.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">YELLOW</span><span class="p">,</span> <span class="n">file_count</span><span class="p">[</span><span class="s">&quot;warning_file_count&quot;</span><span class="p">],</span>
                   <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="si">%s%i</span><span class="s"> files have been processed without errors or warnings</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
              <span class="p">(</span><span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span><span class="p">,</span> <span class="n">file_count</span><span class="p">[</span><span class="s">&quot;successful_file_count&quot;</span><span class="p">],</span>
               <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="p">))</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Logfile written to &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">logfile</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Project.get_waveform_data"><a class="viewcode-back" href="../../project.html#lasif.project.Project.get_waveform_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_waveform_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">station_id</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                          <span class="n">iteration_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get an ObsPy :class:`~obspy.core.stream.Stream` representing the</span>
<span class="sd">        requested waveform data.</span>

<span class="sd">        **This is the only interface that should ever be used to read waveform</span>
<span class="sd">        data.** This assures a consistent handling of various issues.</span>

<span class="sd">        Synthetic data will be properly rotated in case the project is defined</span>
<span class="sd">        for a rotated domain.</span>

<span class="sd">        :type event_name: str</span>
<span class="sd">        :param event_name: The name of the event.</span>
<span class="sd">        :type station_id: str</span>
<span class="sd">        :param station_id: The id of the station in question.</span>
<span class="sd">        :type data_type: str</span>
<span class="sd">        :param data_type: The type of data to retrieve. Can be either `raw`,</span>
<span class="sd">            `processed`, or `synthetic`.</span>
<span class="sd">        :type tag: str</span>
<span class="sd">        :param tag: If requesting `processed` data, the processing tag must be</span>
<span class="sd">            given.</span>
<span class="sd">        :type iteration_name: str</span>
<span class="sd">        :param iteration_name: If requesting `synthetic` data, the iteration</span>
<span class="sd">            name must be given.</span>

<span class="sd">        :rtype: :class:`obspy.core.stream.Stream`</span>
<span class="sd">        :return: An up to three-component Stream object containing the</span>
<span class="sd">            requested data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">lasif</span> <span class="kn">import</span> <span class="n">rotations</span>
        <span class="kn">import</span> <span class="nn">obspy</span>

        <span class="c"># Basic sanity checks.</span>
        <span class="k">if</span> <span class="n">data_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;raw&quot;</span><span class="p">,</span> <span class="s">&quot;processed&quot;</span><span class="p">,</span> <span class="s">&quot;synthetic&quot;</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Invalid data_type.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Event &#39;</span><span class="si">%s</span><span class="s">&#39; not found in project.&quot;</span> <span class="o">%</span> <span class="n">event_name</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s">&quot;processed&quot;</span> <span class="ow">and</span> <span class="n">tag</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Tag must be given for requesting processed data.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s">&quot;synthetic&quot;</span> <span class="ow">and</span> <span class="n">iteration_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;iteration_name must be given for requesting synthetic data.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c"># Get some station information. This essentially assures the</span>
        <span class="c"># availability of the raw data.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_stations_for_event</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">station_id</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;No raw data found for event &#39;</span><span class="si">%s</span><span class="s">&#39; and station &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">event_name</span><span class="p">,</span> <span class="n">station_id</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">network</span><span class="p">,</span> <span class="n">station</span> <span class="o">=</span> <span class="n">station_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span>

        <span class="c"># Diverge to handle the different data types. Raw and processed can be</span>
        <span class="c"># handled almost the same.</span>
        <span class="k">if</span> <span class="n">data_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;raw&quot;</span><span class="p">,</span> <span class="s">&quot;processed&quot;</span><span class="p">):</span>
            <span class="n">waveforms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_waveform_cache_file</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">waveforms</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;No suitable data found.&quot;</span>
                <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">waveforms</span> <span class="o">=</span> <span class="n">waveforms</span><span class="o">.</span><span class="n">get_files_for_station</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">)</span>
            <span class="c"># Make sure only one location and channel type component is used.</span>
            <span class="n">channel_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">waveform</span> <span class="ow">in</span> <span class="n">waveforms</span><span class="p">:</span>
                <span class="n">channel_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">waveform</span><span class="p">[</span><span class="s">&quot;channel_id&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">channel_set</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;More than one combination of location and channel type&quot;</span>
                       <span class="s">&quot; found for event &#39;</span><span class="si">%s</span><span class="s">&#39; and station &#39;</span><span class="si">%s</span><span class="s">&#39;. The first one &quot;</span>
                       <span class="s">&quot;will be chosen. Please run the data validation to &quot;</span>
                       <span class="s">&quot;identify any problems.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">station_id</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">channel_set</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">_i</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">waveforms</span>
                         <span class="k">if</span> <span class="n">waveform</span><span class="p">[</span><span class="s">&quot;channel_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">channel</span><span class="p">)]</span>

            <span class="c"># If processed, one wants to get the processed files.</span>
            <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s">&quot;processed&quot;</span><span class="p">:</span>
                <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">],</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span>
                                          <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">_i</span><span class="p">))</span>
                             <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">]</span>
                <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">_i</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">filenames</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_i</span><span class="p">)]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">filenames</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;Failed to find processed files. Did you &quot;</span>
                           <span class="s">&quot;preprocess the data?&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                <span class="n">st</span> <span class="o">+=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">st</span>

        <span class="c"># Synthetics are different.</span>
        <span class="k">elif</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s">&quot;synthetic&quot;</span><span class="p">:</span>
            <span class="c"># First step is to get the folder.</span>
            <span class="n">folder_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;synthetics&quot;</span><span class="p">],</span> <span class="n">event_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_long_iteration_name</span><span class="p">(</span><span class="n">iteration_name</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder_name</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Could not find suitable synthetics.&quot;</span>
                <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c"># Find all files.</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;X&quot;</span><span class="p">,</span> <span class="s">&quot;Y&quot;</span><span class="p">,</span> <span class="s">&quot;Z&quot;</span><span class="p">):</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">folder_name</span><span class="p">,</span> <span class="n">SYNTHETIC_FILENAME_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">network</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span>
                        <span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Could not find suitable synthetics.&quot;</span>
                <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c"># This maps the synthetic channels to ZNE.</span>
            <span class="n">synthetic_coordinates_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;X&quot;</span><span class="p">:</span> <span class="s">&quot;N&quot;</span><span class="p">,</span> <span class="s">&quot;Y&quot;</span><span class="p">:</span> <span class="s">&quot;E&quot;</span><span class="p">,</span> <span class="s">&quot;Z&quot;</span><span class="p">:</span> <span class="s">&quot;Z&quot;</span><span class="p">}</span>

            <span class="n">synthetics</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c"># Assign network and station codes.</span>
                <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">network</span>
                <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span> <span class="o">=</span> <span class="n">station</span>
                <span class="c"># Flip South and downwards pointing data. We want North and Up.</span>
                <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;X&quot;</span><span class="p">]:</span>
                    <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.0</span>
                <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> \
                    <span class="n">synthetic_coordinates_mapping</span><span class="p">[</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">]</span>
                <span class="c"># Set the correct starttime.</span>
                <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">event_name</span><span class="p">][</span><span class="s">&quot;origin_time&quot;</span><span class="p">]</span>
                <span class="n">synthetics</span> <span class="o">+=</span> <span class="n">tr</span>

            <span class="c"># Only three-channel synthetics can be read.</span>
            <span class="k">if</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">_i</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">synthetics</span><span class="p">])</span> \
                    <span class="o">!=</span> <span class="p">[</span><span class="s">&quot;E&quot;</span><span class="p">,</span> <span class="s">&quot;N&quot;</span><span class="p">,</span> <span class="s">&quot;Z&quot;</span><span class="p">]:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;Could not find all three required components for the &quot;</span>
                       <span class="s">&quot;synthetics for event &#39;</span><span class="si">%s</span><span class="s">&#39; at station &#39;</span><span class="si">%s</span><span class="s">&#39; for &quot;</span>
                       <span class="s">&quot;iteration &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">station_id</span><span class="p">,</span>
                                            <span class="n">iteration_name</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">synthetics</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

            <span class="c"># Finished if no rotation is required.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_angle&quot;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">synthetics</span>

            <span class="n">coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_coordinates_for_waveform_file</span><span class="p">(</span>
                <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;synthetic&quot;</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">event_name</span><span class="p">)</span>

            <span class="c"># First rotate the station back to see, where it was</span>
            <span class="c"># recorded.</span>
            <span class="n">lat</span><span class="p">,</span> <span class="n">lng</span> <span class="o">=</span> <span class="n">rotations</span><span class="o">.</span><span class="n">rotate_lat_lon</span><span class="p">(</span>
                <span class="n">coordinates</span><span class="p">[</span><span class="s">&quot;latitude&quot;</span><span class="p">],</span> <span class="n">coordinates</span><span class="p">[</span><span class="s">&quot;longitude&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_axis&quot;</span><span class="p">],</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_angle&quot;</span><span class="p">])</span>
            <span class="c"># Rotate the synthetics.</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">rotations</span><span class="o">.</span><span class="n">rotate_data</span><span class="p">(</span>
                <span class="n">synthetics</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s">&quot;N&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="n">synthetics</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s">&quot;E&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="n">synthetics</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s">&quot;Z&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="n">lat</span><span class="p">,</span> <span class="n">lng</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_axis&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_angle&quot;</span><span class="p">])</span>
            <span class="n">synthetics</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s">&quot;N&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">n</span>
            <span class="n">synthetics</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s">&quot;E&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">e</span>
            <span class="n">synthetics</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s">&quot;Z&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">z</span>

            <span class="k">return</span> <span class="n">synthetics</span>
        <span class="c"># This should never be reached.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span>
</div>
<div class="viewcode-block" id="Project.discover_available_data"><a class="viewcode-back" href="../../project.html#lasif.project.Project.discover_available_data">[docs]</a>    <span class="k">def</span> <span class="nf">discover_available_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">station_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Discovers the available data for one event at a certain station.</span>

<span class="sd">        Will raise a :exc:`~lasif.project.LASIFException` if no raw data is</span>
<span class="sd">        found for the given event and station combination.</span>

<span class="sd">        :type event_name: str</span>
<span class="sd">        :param event_name: The name of the event.</span>
<span class="sd">        :type station_id: str</span>
<span class="sd">        :param station_id: The id of the station in question.</span>

<span class="sd">        :rtype: dict</span>
<span class="sd">        :returns: Return a dictionary with &quot;processed&quot; and &quot;synthetic&quot; keys.</span>
<span class="sd">            Both values will be a list of strings. In the case of &quot;processed&quot;</span>
<span class="sd">            it will be a list of all available preprocessing tags. In the case</span>
<span class="sd">            of the synthetics it will be a list of all iterations for which</span>
<span class="sd">            synthetics are available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">event_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Event &#39;</span><span class="si">%s</span><span class="s">&#39; not found in project.&quot;</span> <span class="o">%</span> <span class="n">event_name</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c"># Get some station information. This essentially assures the</span>
        <span class="c"># availability of the raw data.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_stations_for_event</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">station_id</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;No raw data found for event &#39;</span><span class="si">%s</span><span class="s">&#39; and station &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">event_name</span><span class="p">,</span> <span class="n">station_id</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c"># Collect all tags and iteration names.</span>
        <span class="n">all_files</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;processed&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s">&quot;synthetic&quot;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="c"># Get the processed tags.</span>
        <span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">],</span> <span class="n">event_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
            <span class="c"># Only interested in preprocessed data.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;preprocessed&quot;</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;_cache.sqlite&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">waveforms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_waveform_cache_file</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">waveforms</span><span class="o">.</span><span class="n">get_files_for_station</span><span class="p">(</span><span class="o">*</span><span class="n">station_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)):</span>
                <span class="n">all_files</span><span class="p">[</span><span class="s">&quot;processed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>

        <span class="c"># Get all synthetic files for the current iteration and event.</span>
        <span class="n">iterations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_iteration_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iteration_name</span> <span class="ow">in</span> <span class="n">iterations</span><span class="p">:</span>
            <span class="n">synthetic_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_synthetic_waveform_filenames</span><span class="p">(</span>
                <span class="n">event_name</span><span class="p">,</span> <span class="n">iteration_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">station_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">synthetic_files</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">all_files</span><span class="p">[</span><span class="s">&quot;synthetic&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iteration_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">all_files</span>
</div>
<div class="viewcode-block" id="Project.plot_station"><a class="viewcode-back" href="../../project.html#lasif.project.Project.plot_station">[docs]</a>    <span class="k">def</span> <span class="nf">plot_station</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">station_id</span><span class="p">,</span> <span class="n">event_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots data for a single station and event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">lasif.visualization</span> <span class="kn">import</span> <span class="n">plot_data_for_station</span>

        <span class="k">if</span> <span class="n">event_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Event &#39;</span><span class="si">%s</span><span class="s">&#39; not found in project.&quot;</span> <span class="o">%</span> <span class="n">event_name</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c"># Get information about the station.</span>
        <span class="n">station</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stations_for_event</span><span class="p">(</span>
            <span class="n">event_name</span><span class="p">,</span> <span class="n">station_id</span><span class="o">=</span><span class="n">station_id</span><span class="p">)</span>
        <span class="n">station</span><span class="p">[</span><span class="s">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station_id</span>

        <span class="n">available_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discover_available_data</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">station_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">available_data</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;No data available for the chosen event - station &quot;</span>
                   <span class="s">&quot;combination&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c"># Callback for dynamic data plotting.</span>
        <span class="k">def</span> <span class="nf">get_data_callback</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">tag_or_iteration</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s">&quot;raw&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_waveform_data</span><span class="p">(</span>
                    <span class="n">event_name</span><span class="p">,</span> <span class="n">station_id</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="s">&quot;raw&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s">&quot;processed&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_waveform_data</span><span class="p">(</span>
                    <span class="n">event_name</span><span class="p">,</span> <span class="n">station_id</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="s">&quot;processed&quot;</span><span class="p">,</span>
                    <span class="n">tag</span><span class="o">=</span><span class="n">tag_or_iteration</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s">&quot;synthetic&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_waveform_data</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">station_id</span><span class="p">,</span>
                                              <span class="n">data_type</span><span class="o">=</span><span class="s">&quot;synthetic&quot;</span><span class="p">,</span>
                                              <span class="n">iteration_name</span><span class="o">=</span><span class="n">tag_or_iteration</span><span class="p">)</span>

        <span class="c"># Plot it.</span>
        <span class="n">plot_data_for_station</span><span class="p">(</span>
            <span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">,</span>
            <span class="n">available_data</span><span class="o">=</span><span class="n">available_data</span><span class="p">,</span>
            <span class="n">event</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">event_name</span><span class="p">],</span>
            <span class="n">get_data_callback</span><span class="o">=</span><span class="n">get_data_callback</span><span class="p">,</span>
            <span class="n">domain_bounds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Project.plot_event"><a class="viewcode-back" href="../../project.html#lasif.project.Project.plot_event">[docs]</a>    <span class="k">def</span> <span class="nf">plot_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots information about one event on the map.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">event_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Event &#39;</span><span class="si">%s</span><span class="s">&#39; not found in project.&quot;</span> <span class="o">%</span> <span class="n">event_name</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">lasif</span> <span class="kn">import</span> <span class="n">visualization</span>

        <span class="c"># Plot the domain.</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;bounds&quot;</span><span class="p">]</span>
        <span class="nb">map</span> <span class="o">=</span> <span class="n">visualization</span><span class="o">.</span><span class="n">plot_domain</span><span class="p">(</span>
            <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;minimum_latitude&quot;</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;maximum_latitude&quot;</span><span class="p">],</span>
            <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;minimum_longitude&quot;</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;maximum_longitude&quot;</span><span class="p">],</span>
            <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;boundary_width_in_degree&quot;</span><span class="p">],</span>
            <span class="n">rotation_axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_axis&quot;</span><span class="p">],</span>
            <span class="n">rotation_angle_in_degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_angle&quot;</span><span class="p">],</span>
            <span class="n">plot_simulation_domain</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># Get the event and extract information from it.</span>
        <span class="n">event_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">event_name</span><span class="p">]</span>

        <span class="c"># Get a dictionary containing all stations that have data for the</span>
        <span class="c"># current event.</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stations_for_event</span><span class="p">(</span><span class="n">event_name</span><span class="p">)</span>

        <span class="c"># Plot the stations. This will also plot raypaths.</span>
        <span class="n">visualization</span><span class="o">.</span><span class="n">plot_stations_for_event</span><span class="p">(</span>
            <span class="n">map_object</span><span class="o">=</span><span class="nb">map</span><span class="p">,</span> <span class="n">station_dict</span><span class="o">=</span><span class="n">stations</span><span class="p">,</span> <span class="n">event_info</span><span class="o">=</span><span class="n">event_info</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="c"># Plot the beachball for one event.</span>
        <span class="n">visualization</span><span class="o">.</span><span class="n">plot_events</span><span class="p">([</span><span class="n">event_info</span><span class="p">],</span> <span class="n">map_object</span><span class="o">=</span><span class="nb">map</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Project.plot_events"><a class="viewcode-back" href="../../project.html#lasif.project.Project.plot_events">[docs]</a>    <span class="k">def</span> <span class="nf">plot_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="s">&quot;map&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the domain and beachballs for all events on the map.</span>

<span class="sd">        :param plot_type: Determines the type of plot created.</span>
<span class="sd">            * ``map`` (default) - a map view of the events</span>
<span class="sd">            * ``depth`` - a depth distribution histogram</span>
<span class="sd">            * ``time`` - a time distribution histogram</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">lasif</span> <span class="kn">import</span> <span class="n">visualization</span>

        <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s">&quot;map&quot;</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;bounds&quot;</span><span class="p">]</span>
            <span class="nb">map</span> <span class="o">=</span> <span class="n">visualization</span><span class="o">.</span><span class="n">plot_domain</span><span class="p">(</span>
                <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;minimum_latitude&quot;</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;maximum_latitude&quot;</span><span class="p">],</span>
                <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;minimum_longitude&quot;</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;maximum_longitude&quot;</span><span class="p">],</span>
                <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;boundary_width_in_degree&quot;</span><span class="p">],</span>
                <span class="n">rotation_axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_axis&quot;</span><span class="p">],</span>
                <span class="n">rotation_angle_in_degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_angle&quot;</span><span class="p">],</span>
                <span class="n">plot_simulation_domain</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">visualization</span><span class="o">.</span><span class="n">plot_events</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">map_object</span><span class="o">=</span><span class="nb">map</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s">&quot;depth&quot;</span><span class="p">:</span>
            <span class="n">visualization</span><span class="o">.</span><span class="n">plot_event_histogram</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="s">&quot;depth&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s">&quot;time&quot;</span><span class="p">:</span>
            <span class="n">visualization</span><span class="o">.</span><span class="n">plot_event_histogram</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="s">&quot;time&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Unknown plot_type&quot;</span>
            <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Project.plot_raydensity"><a class="viewcode-back" href="../../project.html#lasif.project.Project.plot_raydensity">[docs]</a>    <span class="k">def</span> <span class="nf">plot_raydensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_plot</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the raydensity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">lasif</span> <span class="kn">import</span> <span class="n">visualization</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">))</span>

        <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;bounds&quot;</span><span class="p">]</span>
        <span class="n">map_object</span> <span class="o">=</span> <span class="n">visualization</span><span class="o">.</span><span class="n">plot_domain</span><span class="p">(</span>
            <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;minimum_latitude&quot;</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;maximum_latitude&quot;</span><span class="p">],</span>
            <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;minimum_longitude&quot;</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;maximum_longitude&quot;</span><span class="p">],</span>
            <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;boundary_width_in_degree&quot;</span><span class="p">],</span>
            <span class="n">rotation_axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_axis&quot;</span><span class="p">],</span>
            <span class="n">rotation_angle_in_degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_angle&quot;</span><span class="p">],</span>
            <span class="n">plot_simulation_domain</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">resolution</span><span class="o">=</span><span class="s">&quot;l&quot;</span><span class="p">)</span>

        <span class="n">event_stations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">event_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stations_for_event</span><span class="p">(</span><span class="n">event_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">LASIFException</span><span class="p">:</span>
                <span class="n">stations</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">event_stations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">event_info</span><span class="p">,</span> <span class="n">stations</span><span class="p">))</span>

        <span class="n">visualization</span><span class="o">.</span><span class="n">plot_raydensity</span><span class="p">(</span>
            <span class="n">map_object</span><span class="p">,</span> <span class="n">event_stations</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;minimum_latitude&quot;</span><span class="p">],</span>
            <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;maximum_latitude&quot;</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;minimum_longitude&quot;</span><span class="p">],</span>
            <span class="n">bounds</span><span class="p">[</span><span class="s">&quot;maximum_longitude&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_axis&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_angle&quot;</span><span class="p">])</span>

        <span class="n">visualization</span><span class="o">.</span><span class="n">plot_events</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">map_object</span><span class="o">=</span><span class="n">map_object</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save_plot</span><span class="p">:</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_output_folder</span><span class="p">(</span><span class="s">&quot;raydensity_plot&quot;</span><span class="p">),</span>
                                   <span class="s">&quot;raydensity.png&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;Saved picture at </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">outfile</span>
</div>
<div class="viewcode-block" id="Project.get_filecounts_for_event"><a class="viewcode-back" href="../../project.html#lasif.project.Project.get_filecounts_for_event">[docs]</a>    <span class="k">def</span> <span class="nf">get_filecounts_for_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the number of files associated with the current event.</span>

<span class="sd">        :type event_name: str</span>
<span class="sd">        :param event_name: The name of the event.</span>

<span class="sd">        :rtype: dict</span>
<span class="sd">        :returns: A dictionary with the following self-explaining keys:</span>
<span class="sd">            * raw_waveform_file_count</span>
<span class="sd">            * synthetic_waveform_file_count</span>
<span class="sd">            * preprocessed_waveform_file_count</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Make sure the event exists.</span>
        <span class="k">if</span> <span class="n">event_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Event &#39;</span><span class="si">%s</span><span class="s">&#39; not found in project.&quot;</span> <span class="o">%</span> <span class="n">event_name</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">],</span> <span class="n">event_name</span><span class="p">)</span>
        <span class="n">synth_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;synthetics&quot;</span><span class="p">],</span> <span class="n">event_name</span><span class="p">)</span>
        <span class="n">raw_data_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">processed_data_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">synthetic_data_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dirpath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;raw&quot;</span><span class="p">):</span>
                <span class="n">raw_data_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s">&quot;preprocessed&quot;</span> <span class="ow">in</span> <span class="n">dirpath</span><span class="p">:</span>
                <span class="n">processed_data_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">synth_path</span><span class="p">):</span>
            <span class="n">synthetic_data_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&quot;raw_waveform_file_count&quot;</span><span class="p">:</span> <span class="n">raw_data_count</span><span class="p">,</span>
            <span class="s">&quot;synthetic_waveform_file_count&quot;</span><span class="p">:</span> <span class="n">synthetic_data_count</span><span class="p">,</span>
            <span class="s">&quot;preprocessed_waveform_file_count&quot;</span><span class="p">:</span> <span class="n">processed_data_count</span><span class="p">}</span>
</div>
<div class="viewcode-block" id="Project.generate_input_files"><a class="viewcode-back" href="../../project.html#lasif.project.Project.generate_input_files">[docs]</a>    <span class="k">def</span> <span class="nf">generate_input_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration_name</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span>
                             <span class="n">simulation_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the input files for one event.</span>

<span class="sd">        :param iteration_name: The name of the iteration.</span>
<span class="sd">        :param event_name: The name of the event for which to generate the</span>
<span class="sd">            input files.</span>
<span class="sd">        :param simulation_type: The type of simulation to perform. Possible</span>
<span class="sd">            values are: &#39;normal simulation&#39;, &#39;adjoint forward&#39;, &#39;adjoint</span>
<span class="sd">            reverse&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">wfs_input_generator</span> <span class="kn">import</span> <span class="n">InputFileGenerator</span>

        <span class="c"># =====================================================================</span>
        <span class="c"># read iteration xml file, get event and list of stations</span>
        <span class="c"># =====================================================================</span>

        <span class="n">iteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_iteration</span><span class="p">(</span><span class="n">iteration_name</span><span class="p">)</span>

        <span class="c"># Check that the event is part of the iterations.</span>
        <span class="k">if</span> <span class="n">event_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">iteration</span><span class="o">.</span><span class="n">events</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;Event &#39;</span><span class="si">%s</span><span class="s">&#39; not part of iteration &#39;</span><span class="si">%s</span><span class="s">&#39;.</span><span class="se">\n</span><span class="s">Events available &quot;</span>
                   <span class="s">&quot;in iteration:</span><span class="se">\n\t</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                   <span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">iteration_name</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="nb">sorted</span><span class="p">(</span><span class="n">iteration</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">event_name</span><span class="p">]</span>
        <span class="n">stations_for_event</span> <span class="o">=</span> <span class="n">iteration</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">event_name</span><span class="p">][</span><span class="s">&quot;stations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="c"># Get all stations and create a dictionary for the input file</span>
        <span class="c"># generator.</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stations_for_event</span><span class="p">(</span><span class="n">event_name</span><span class="p">)</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="p">[{</span>
            <span class="s">&quot;id&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s">&quot;latitude&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="s">&quot;latitude&quot;</span><span class="p">],</span>
            <span class="s">&quot;longitude&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="s">&quot;longitude&quot;</span><span class="p">],</span>
            <span class="s">&quot;elevation_in_m&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="s">&quot;elevation_in_m&quot;</span><span class="p">],</span>
            <span class="s">&quot;local_depth_in_m&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="s">&quot;local_depth_in_m&quot;</span><span class="p">]}</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span>
            <span class="n">stations</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">stations_for_event</span><span class="p">]</span>

        <span class="c"># =====================================================================</span>
        <span class="c"># set solver options</span>
        <span class="c"># =====================================================================</span>

        <span class="n">solver</span> <span class="o">=</span> <span class="n">iteration</span><span class="o">.</span><span class="n">solver_settings</span>

        <span class="c"># Currently only SES3D 4.1 is supported</span>
        <span class="n">solver_format</span> <span class="o">=</span> <span class="n">solver</span><span class="p">[</span><span class="s">&quot;solver&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">solver_format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;ses3d 4.1&quot;</span><span class="p">,</span> <span class="s">&quot;ses3d 2.0&quot;</span><span class="p">,</span>
                                 <span class="s">&quot;specfem3d cartesian&quot;</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;Currently only SES3D 4.1, SES3D 2.0, and SPECFEM3D &quot;</span>
                   <span class="s">&quot;CARTESIAN are supported.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">solver_format</span> <span class="o">=</span> <span class="n">solver_format</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">solver_format</span> <span class="o">=</span> <span class="n">solver_format</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span>

        <span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span><span class="p">[</span><span class="s">&quot;solver_settings&quot;</span><span class="p">]</span>

        <span class="c"># =====================================================================</span>
        <span class="c"># create the input file generator, add event and stations,</span>
        <span class="c"># populate the configuration items</span>
        <span class="c"># =====================================================================</span>

        <span class="c"># Add the event and the stations to the input file generator.</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="n">InputFileGenerator</span><span class="p">()</span>
        <span class="n">gen</span><span class="o">.</span><span class="n">add_events</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">])</span>
        <span class="n">gen</span><span class="o">.</span><span class="n">add_stations</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">solver_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;ses3d_4_1&quot;</span><span class="p">,</span> <span class="s">&quot;ses3d_2_0&quot;</span><span class="p">]:</span>
            <span class="c"># event tag</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">event_tag</span> <span class="o">=</span> <span class="n">event_name</span>

            <span class="c"># Time configuration.</span>
            <span class="n">npts</span> <span class="o">=</span> <span class="n">solver</span><span class="p">[</span><span class="s">&quot;simulation_parameters&quot;</span><span class="p">][</span><span class="s">&quot;number_of_time_steps&quot;</span><span class="p">]</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">solver</span><span class="p">[</span><span class="s">&quot;simulation_parameters&quot;</span><span class="p">][</span><span class="s">&quot;time_increment&quot;</span><span class="p">]</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">number_of_time_steps</span> <span class="o">=</span> <span class="n">npts</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">time_increment_in_s</span> <span class="o">=</span> <span class="n">delta</span>

            <span class="c"># SES3D specific configuration</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_folder</span> <span class="o">=</span> <span class="n">solver</span><span class="p">[</span><span class="s">&quot;output_directory&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s">&quot;{{EVENT_NAME}}&quot;</span><span class="p">,</span> <span class="n">event_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">))</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">simulation_type</span> <span class="o">=</span> <span class="n">simulation_type</span>

            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">adjoint_forward_wavefield_output_folder</span> <span class="o">=</span> \
                <span class="n">solver</span><span class="p">[</span><span class="s">&quot;adjoint_output_parameters&quot;</span><span class="p">][</span>
                    <span class="s">&quot;forward_field_output_directory&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="s">&quot;{{EVENT_NAME}}&quot;</span><span class="p">,</span> <span class="n">event_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">))</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">adjoint_forward_sampling_rate</span> <span class="o">=</span> \
                <span class="n">solver</span><span class="p">[</span><span class="s">&quot;adjoint_output_parameters&quot;</span><span class="p">][</span>
                    <span class="s">&quot;sampling_rate_of_forward_field&quot;</span><span class="p">]</span>

            <span class="c"># Visco-elastic dissipation</span>
            <span class="n">diss</span> <span class="o">=</span> <span class="n">solver</span><span class="p">[</span><span class="s">&quot;simulation_parameters&quot;</span><span class="p">][</span><span class="s">&quot;is_dissipative&quot;</span><span class="p">]</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">is_dissipative</span> <span class="o">=</span> <span class="n">diss</span>

            <span class="c"># Only SES3D 4.1 has the relaxation parameters.</span>
            <span class="k">if</span> <span class="n">solver_format</span> <span class="o">==</span> <span class="s">&quot;ses3d_4_1&quot;</span><span class="p">:</span>
                <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Q_model_relaxation_times</span> <span class="o">=</span> \
                    <span class="n">solver</span><span class="p">[</span><span class="s">&quot;relaxation_parameter_list&quot;</span><span class="p">][</span><span class="s">&quot;tau&quot;</span><span class="p">]</span>
                <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Q_model_weights_of_relaxation_mechanisms</span> <span class="o">=</span> \
                    <span class="n">solver</span><span class="p">[</span><span class="s">&quot;relaxation_parameter_list&quot;</span><span class="p">][</span><span class="s">&quot;w&quot;</span><span class="p">]</span>

            <span class="c"># Discretization</span>
            <span class="n">disc</span> <span class="o">=</span> <span class="n">solver</span><span class="p">[</span><span class="s">&quot;computational_setup&quot;</span><span class="p">]</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">nx_global</span> <span class="o">=</span> <span class="n">disc</span><span class="p">[</span><span class="s">&quot;nx_global&quot;</span><span class="p">]</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ny_global</span> <span class="o">=</span> <span class="n">disc</span><span class="p">[</span><span class="s">&quot;ny_global&quot;</span><span class="p">]</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">nz_global</span> <span class="o">=</span> <span class="n">disc</span><span class="p">[</span><span class="s">&quot;nz_global&quot;</span><span class="p">]</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">px</span> <span class="o">=</span> <span class="n">disc</span><span class="p">[</span><span class="s">&quot;px_processors_in_theta_direction&quot;</span><span class="p">]</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">py</span> <span class="o">=</span> <span class="n">disc</span><span class="p">[</span><span class="s">&quot;py_processors_in_phi_direction&quot;</span><span class="p">]</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pz</span> <span class="o">=</span> <span class="n">disc</span><span class="p">[</span><span class="s">&quot;pz_processors_in_r_direction&quot;</span><span class="p">]</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lagrange_polynomial_degree</span> <span class="o">=</span> \
                <span class="n">disc</span><span class="p">[</span><span class="s">&quot;lagrange_polynomial_degree&quot;</span><span class="p">]</span>

            <span class="c"># Configure the mesh.</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">mesh_min_latitude</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;bounds&quot;</span><span class="p">][</span><span class="s">&quot;minimum_latitude&quot;</span><span class="p">]</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">mesh_max_latitude</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;bounds&quot;</span><span class="p">][</span><span class="s">&quot;maximum_latitude&quot;</span><span class="p">]</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">mesh_min_longitude</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;bounds&quot;</span><span class="p">][</span><span class="s">&quot;minimum_longitude&quot;</span><span class="p">]</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">mesh_max_longitude</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;bounds&quot;</span><span class="p">][</span><span class="s">&quot;maximum_longitude&quot;</span><span class="p">]</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">mesh_min_depth_in_km</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;bounds&quot;</span><span class="p">][</span><span class="s">&quot;minimum_depth_in_km&quot;</span><span class="p">]</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">mesh_max_depth_in_km</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;bounds&quot;</span><span class="p">][</span><span class="s">&quot;maximum_depth_in_km&quot;</span><span class="p">]</span>

            <span class="c"># Set the rotation parameters.</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rotation_angle_in_degree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_angle&quot;</span><span class="p">]</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rotation_axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_axis&quot;</span><span class="p">]</span>

            <span class="c"># Make source time function</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">source_time_function</span> <span class="o">=</span> \
                <span class="n">iteration</span><span class="o">.</span><span class="n">get_source_time_function</span><span class="p">()[</span><span class="s">&quot;data&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">solver_format</span> <span class="o">==</span> <span class="s">&quot;specfem3d_cartesian&quot;</span><span class="p">:</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">NSTEP</span> <span class="o">=</span> \
                <span class="n">solver</span><span class="p">[</span><span class="s">&quot;simulation_parameters&quot;</span><span class="p">][</span><span class="s">&quot;number_of_time_steps&quot;</span><span class="p">]</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">DT</span> <span class="o">=</span> \
                <span class="n">solver</span><span class="p">[</span><span class="s">&quot;simulation_parameters&quot;</span><span class="p">][</span><span class="s">&quot;time_increment&quot;</span><span class="p">]</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">NPROC</span> <span class="o">=</span> \
                <span class="n">solver</span><span class="p">[</span><span class="s">&quot;computational_setup&quot;</span><span class="p">][</span><span class="s">&quot;number_of_processors&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">simulation_type</span> <span class="o">==</span> <span class="s">&quot;normal simulation&quot;</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;&#39;normal_simulation&#39; not supported for SPECFEM3D &quot;</span>
                       <span class="s">&quot;Cartesian. Please choose either &#39;adjoint_forward&#39; or &quot;</span>
                       <span class="s">&quot;&#39;adjoint_reverse&#39;.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">simulation_type</span> <span class="o">==</span> <span class="s">&quot;adjoint forward&quot;</span><span class="p">:</span>
                <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">SIMULATION_TYPE</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">simulation_type</span> <span class="o">==</span> <span class="s">&quot;adjoint reverse&quot;</span><span class="p">:</span>
                <span class="n">gen</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">SIMULATION_TYPE</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="n">solver_format</span> <span class="o">=</span> <span class="n">solver_format</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Unknown solver.&quot;</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c"># =================================================================</span>
        <span class="c"># output</span>
        <span class="c"># =================================================================</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_folder</span><span class="p">(</span>
            <span class="s">&quot;input_files___ITERATION_</span><span class="si">%s</span><span class="s">__</span><span class="si">%s</span><span class="s">__EVENT_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">iteration_name</span><span class="p">,</span> <span class="n">simulation_type</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">),</span>
                <span class="n">event_name</span><span class="p">))</span>

        <span class="n">gen</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="n">solver_format</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;Written files to &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="n">output_dir</span>
</div>
<div class="viewcode-block" id="Project.get_output_folder"><a class="viewcode-back" href="../../project.html#lasif.project.Project.get_output_folder">[docs]</a>    <span class="k">def</span> <span class="nf">get_output_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a output folder in a unified way.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">obspy</span> <span class="kn">import</span> <span class="n">UTCDateTime</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">___</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">UTCDateTime</span><span class="p">),</span> <span class="n">tag</span><span class="p">))</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;output&quot;</span><span class="p">],</span> <span class="n">output_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_dir</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Project.station_cache"><a class="viewcode-back" href="../../project.html#lasif.project.Project.station_cache">[docs]</a>    <span class="k">def</span> <span class="nf">station_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The station cache. Will only be initialized once.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__update_station_cache</span><span class="p">(</span><span class="n">show_progress</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__update_station_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function actually updating the station cache.</span>

<span class="sd">        Separate function from the property so it can be accessed separately if</span>
<span class="sd">        the need arises.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">lasif.tools.station_cache</span> <span class="kn">import</span> <span class="n">StationCache</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;_station_cache&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_station_cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_station_cache</span> <span class="o">=</span> <span class="n">StationCache</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;cache&quot;</span><span class="p">],</span> <span class="s">&quot;station_cache.sqlite&quot;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;dataless_seed&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;resp&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;station_xml&quot;</span><span class="p">],</span>
            <span class="n">show_progress</span><span class="o">=</span><span class="n">show_progress</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_station_cache</span>

<div class="viewcode-block" id="Project._get_waveform_cache_file"><a class="viewcode-back" href="../../project.html#lasif.project.Project._get_waveform_cache_file">[docs]</a>    <span class="k">def</span> <span class="nf">_get_waveform_cache_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">waveform_type</span><span class="o">=</span><span class="s">&quot;data&quot;</span><span class="p">,</span>
                                 <span class="n">show_progress</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function returning the waveform cache file for the data from a</span>
<span class="sd">        specific event and a certain tag.</span>
<span class="sd">        Example to return the cache for the original data for &#39;event_1&#39;:</span>
<span class="sd">        _get_waveform_cache_file(&quot;event_1&quot;, &quot;raw&quot;, waveform_type=&quot;data&quot;)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># If already loaded, simply load the cached one.</span>
        <span class="n">cache_tag</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">waveform_type</span><span class="p">,</span>
                                     <span class="n">show_progress</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;_Project__cache_waveform_cache_objects&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__cache_waveform_cache_objects</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">use_cache</span> <span class="ow">and</span> <span class="n">cache_tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cache_waveform_cache_objects</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cache_waveform_cache_objects</span><span class="p">[</span><span class="n">cache_tag</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">waveform_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="s">&quot;synthetics&quot;</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;waveform_type must be either &#39;data&#39; or &#39;synthetics&#39;.&quot;</span>
            <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">lasif.tools.waveform_cache</span> <span class="kn">import</span> <span class="n">WaveformCache</span>

        <span class="n">waveform_db_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="n">waveform_type</span><span class="p">],</span> <span class="n">event_name</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">_cache.sqlite&quot;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>
        <span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="n">waveform_type</span><span class="p">],</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">cache</span> <span class="o">=</span> <span class="n">WaveformCache</span><span class="p">(</span><span class="n">waveform_db_file</span><span class="p">,</span> <span class="n">data_path</span><span class="p">,</span> <span class="n">show_progress</span><span class="p">)</span>
        <span class="c"># Store in cache.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cache_waveform_cache_objects</span><span class="p">[</span><span class="n">cache_tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="k">return</span> <span class="n">cache</span>
</div>
<div class="viewcode-block" id="Project.get_stations_for_event"><a class="viewcode-back" href="../../project.html#lasif.project.Project.get_stations_for_event">[docs]</a>    <span class="k">def</span> <span class="nf">get_stations_for_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">station_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary containing a little bit of information about all</span>
<span class="sd">        stations available for a given event.</span>

<span class="sd">        An available station is defined as a station with an existing station</span>
<span class="sd">        file and an existing waveform file.</span>

<span class="sd">        Will return an empty dictionary if nothing is found.</span>

<span class="sd">        Example return value:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            {&quot;BW.ROTZ&quot;: {&quot;latitude&quot;: 10, &quot;longitude&quot;: 11, &quot;elevation_in_m&quot;: 12,</span>
<span class="sd">                         &quot;local_depth_in_m&quot;: 13},</span>
<span class="sd">             &quot;BW.ROTZ2&quot;: ...,</span>
<span class="sd">             ...}</span>

<span class="sd">        :type event_name: str</span>
<span class="sd">        :param event_name: The name of the event.</span>
<span class="sd">        :type station_id: str</span>
<span class="sd">        :param station_id: The station id (NET.STA) of the station in</span>
<span class="sd">            question. If given, only this station will be returned, otherwise</span>
<span class="sd">            all will. Defaults to None. Optional</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">event_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Event &#39;</span><span class="si">%s</span><span class="s">&#39; not found in project.&quot;</span> <span class="o">%</span> <span class="n">event_name</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">],</span> <span class="n">event_name</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;No raw data found.&quot;</span>
            <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">waveforms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_waveform_cache_file</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">)</span>

        <span class="c"># Single station.</span>
        <span class="k">if</span> <span class="n">station_id</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">waveforms</span><span class="o">.</span><span class="n">get_files_for_station</span><span class="p">(</span><span class="o">*</span><span class="n">station_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Station &#39;</span><span class="si">%s</span><span class="s">&#39; could not be found for the given event.&quot;</span> \
                    <span class="o">%</span> <span class="n">station_id</span>
                <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c"># Assert that a station file exists for the current station.</span>
            <span class="c"># Otherwise the station does not exists for the current event.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_cache</span><span class="o">.</span><span class="n">station_info_available</span><span class="p">(</span>
                    <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;channel_id&quot;</span><span class="p">],</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;starttime_timestamp&quot;</span><span class="p">]):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;No station file found for the station.&quot;</span>
                <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_coordinates_for_waveform_file</span><span class="p">(</span>
                <span class="n">waveform_filename</span><span class="o">=</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;filename&quot;</span><span class="p">],</span>
                <span class="n">waveform_type</span><span class="o">=</span><span class="s">&quot;raw&quot;</span><span class="p">,</span>
                <span class="n">network_code</span><span class="o">=</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;network&quot;</span><span class="p">],</span>
                <span class="n">station_code</span><span class="o">=</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;station&quot;</span><span class="p">],</span>
                <span class="n">event_name</span><span class="o">=</span><span class="n">event_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s">&quot;latitude&quot;</span><span class="p">:</span> <span class="n">coordinates</span><span class="p">[</span><span class="s">&quot;latitude&quot;</span><span class="p">],</span>
                <span class="s">&quot;longitude&quot;</span><span class="p">:</span> <span class="n">coordinates</span><span class="p">[</span><span class="s">&quot;longitude&quot;</span><span class="p">],</span>
                <span class="s">&quot;elevation_in_m&quot;</span><span class="p">:</span> <span class="n">coordinates</span><span class="p">[</span><span class="s">&quot;elevation_in_m&quot;</span><span class="p">],</span>
                <span class="s">&quot;local_depth_in_m&quot;</span><span class="p">:</span> <span class="n">coordinates</span><span class="p">[</span><span class="s">&quot;local_depth_in_m&quot;</span><span class="p">]}</span>

        <span class="c"># Query the station cache for a list of all channels.</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">waveform</span> <span class="ow">in</span> <span class="n">waveforms</span><span class="o">.</span><span class="n">get_values</span><span class="p">():</span>
            <span class="n">station</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">waveform</span><span class="p">[</span><span class="s">&quot;network&quot;</span><span class="p">],</span> <span class="n">waveform</span><span class="p">[</span><span class="s">&quot;station&quot;</span><span class="p">])</span>
            <span class="c"># Do not add if already exists.</span>
            <span class="k">if</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c"># Assert that a station file exists for the current station.</span>
            <span class="c"># Otherwise continue.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_cache</span><span class="o">.</span><span class="n">station_info_available</span><span class="p">(</span>
                    <span class="n">waveform</span><span class="p">[</span><span class="s">&quot;channel_id&quot;</span><span class="p">],</span> <span class="n">waveform</span><span class="p">[</span><span class="s">&quot;starttime_timestamp&quot;</span><span class="p">]):</span>
                <span class="k">continue</span>

            <span class="n">coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_coordinates_for_waveform_file</span><span class="p">(</span>
                <span class="n">waveform_filename</span><span class="o">=</span><span class="n">waveform</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">],</span>
                <span class="n">waveform_type</span><span class="o">=</span><span class="s">&quot;raw&quot;</span><span class="p">,</span>
                <span class="n">network_code</span><span class="o">=</span><span class="n">waveform</span><span class="p">[</span><span class="s">&quot;network&quot;</span><span class="p">],</span>
                <span class="n">station_code</span><span class="o">=</span><span class="n">waveform</span><span class="p">[</span><span class="s">&quot;station&quot;</span><span class="p">],</span>
                <span class="n">event_name</span><span class="o">=</span><span class="n">event_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">coordinates</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;No coordinates available for waveform file &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> \
                    <span class="n">waveform</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">]</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">stations</span><span class="p">[</span><span class="n">station</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&quot;latitude&quot;</span><span class="p">:</span> <span class="n">coordinates</span><span class="p">[</span><span class="s">&quot;latitude&quot;</span><span class="p">],</span>
                <span class="s">&quot;longitude&quot;</span><span class="p">:</span> <span class="n">coordinates</span><span class="p">[</span><span class="s">&quot;longitude&quot;</span><span class="p">],</span>
                <span class="s">&quot;elevation_in_m&quot;</span><span class="p">:</span> <span class="n">coordinates</span><span class="p">[</span><span class="s">&quot;elevation_in_m&quot;</span><span class="p">],</span>
                <span class="s">&quot;local_depth_in_m&quot;</span><span class="p">:</span> <span class="n">coordinates</span><span class="p">[</span><span class="s">&quot;local_depth_in_m&quot;</span><span class="p">]}</span>
        <span class="k">return</span> <span class="n">stations</span>
</div>
<div class="viewcode-block" id="Project._get_coordinates_for_waveform_file"><a class="viewcode-back" href="../../project.html#lasif.project.Project._get_coordinates_for_waveform_file">[docs]</a>    <span class="k">def</span> <span class="nf">_get_coordinates_for_waveform_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">waveform_filename</span><span class="p">,</span>
                                           <span class="n">waveform_type</span><span class="p">,</span> <span class="n">network_code</span><span class="p">,</span>
                                           <span class="n">station_code</span><span class="p">,</span> <span class="n">event_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal function used to grab station coordinates from the various</span>
<span class="sd">        sources.</span>

<span class="sd">        Used to make sure the same functionality is used everywhere.</span>

<span class="sd">        :param waveform_filename: The absolute filename of the waveform.</span>
<span class="sd">        :param waveform_type: The type of waveform file. Could be deduced from</span>
<span class="sd">            the pathname but probably not necessary as the information is</span>
<span class="sd">            likely readily available in situations where this method is called.</span>
<span class="sd">            One of &quot;raw&quot;, &quot;processed&quot;, and &quot;synthetic&quot;</span>
<span class="sd">        :param network_code: The network id of the file. Same reasoning as for</span>
<span class="sd">            the waveform_type.</span>
<span class="sd">        :param station_code: The station id of the file. Same reasoning as for</span>
<span class="sd">            the waveform_type.</span>
<span class="sd">        :param event_name: The name of the event. Same reasoning as for the</span>
<span class="sd">            waveform_type.</span>

<span class="sd">        Returns a dictionary containing &quot;latitude&quot;, &quot;longitude&quot;,</span>
<span class="sd">        &quot;elevation_in_m&quot;, &quot;local_depth_in_m&quot;. Returns None if no coordinates</span>
<span class="sd">        could be found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">waveform_filename</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Could not find the file &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">waveform_filename</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c"># Attempt to first retrieve the coordinates from the station files.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_cache</span><span class="o">.</span><span class="n">get_coordinates_for_station</span><span class="p">(</span>
                <span class="n">network_code</span><span class="p">,</span> <span class="n">station_code</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">coordinates</span>

        <span class="c"># The next step is to check for coordinates in sac files. For raw data</span>
        <span class="c"># files, this is easy. For processed and synthetic data, the</span>
        <span class="c"># corresponding raw data files will be attempted to be retrieved.</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_waveform_cache_file</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">waveform_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;synthetic&quot;</span><span class="p">,</span> <span class="s">&quot;processed&quot;</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_files_for_station</span><span class="p">(</span><span class="n">network_code</span><span class="p">,</span> <span class="n">station_code</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">waveform_cache_entry</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">waveform_cache_entry</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">waveform_cache_entry</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_details</span><span class="p">(</span><span class="n">waveform_filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">waveform_cache_entry</span><span class="p">:</span>
                <span class="n">waveform_cache_entry</span> <span class="o">=</span> <span class="n">waveform_cache_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">waveform_cache_entry</span> <span class="ow">and</span> <span class="n">waveform_cache_entry</span><span class="p">[</span><span class="s">&quot;latitude&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s">&quot;latitude&quot;</span><span class="p">:</span> <span class="n">waveform_cache_entry</span><span class="p">[</span><span class="s">&quot;latitude&quot;</span><span class="p">],</span>
                <span class="s">&quot;longitude&quot;</span><span class="p">:</span> <span class="n">waveform_cache_entry</span><span class="p">[</span><span class="s">&quot;longitude&quot;</span><span class="p">],</span>
                <span class="s">&quot;elevation_in_m&quot;</span><span class="p">:</span> <span class="n">waveform_cache_entry</span><span class="p">[</span><span class="s">&quot;elevation_in_m&quot;</span><span class="p">],</span>
                <span class="s">&quot;local_depth_in_m&quot;</span><span class="p">:</span> <span class="n">waveform_cache_entry</span><span class="p">[</span><span class="s">&quot;local_depth_in_m&quot;</span><span class="p">]}</span>

        <span class="c"># Last but not least resort to the Inventory Database.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">lasif.tools.inventory_db</span> <span class="kn">import</span> <span class="n">get_station_coordinates</span>
            <span class="c"># Now check if the station_coordinates are available in the</span>
            <span class="c"># inventory DB and use those.</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">get_station_coordinates</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;inv_db_file&quot;</span><span class="p">],</span>
                <span class="s">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">network_code</span><span class="p">,</span> <span class="n">station_code</span><span class="p">)),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;cache&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;download_settings&quot;</span><span class="p">][</span><span class="s">&quot;arclink_username&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">coords</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">coords</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="Project.validate_data"><a class="viewcode-back" href="../../project.html#lasif.project.Project.validate_data">[docs]</a>    <span class="k">def</span> <span class="nf">validate_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">station_file_availability</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">raypaths</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                      <span class="n">waveforms</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates all data of the current project.</span>

<span class="sd">        This commands walks through all available data and checks it for</span>
<span class="sd">        validity.  It furthermore does some sanity checks to detect common</span>
<span class="sd">        problems. These should be fixed.</span>

<span class="sd">        Event files:</span>
<span class="sd">            * Validate against QuakeML 1.2 scheme.</span>
<span class="sd">            * Make sure they contain at least one origin, magnitude and focal</span>
<span class="sd">              mechanism object.</span>
<span class="sd">            * Check for duplicate ids amongst all QuakeML files.</span>
<span class="sd">            * Some simply sanity checks so that the event depth is reasonable</span>
<span class="sd">              and the moment tensor values as well. This is rather fragile and</span>
<span class="sd">              mainly intended to detect values specified in wrong units.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Shared formatting for all.</span>
        <span class="n">ok_string</span> <span class="o">=</span> <span class="s">&quot; </span><span class="si">%s</span><span class="s">[</span><span class="si">%s</span><span class="s">OK</span><span class="si">%s</span><span class="s">]</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">BRIGHT</span><span class="p">,</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">NORMAL</span> <span class="o">+</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span><span class="p">,</span>
            <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span> <span class="o">+</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">BRIGHT</span><span class="p">,</span>
            <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
        <span class="n">fail_string</span> <span class="o">=</span> <span class="s">&quot; </span><span class="si">%s</span><span class="s">[</span><span class="si">%s</span><span class="s">FAIL</span><span class="si">%s</span><span class="s">]</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">BRIGHT</span><span class="p">,</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">NORMAL</span> <span class="o">+</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span><span class="p">,</span>
            <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span> <span class="o">+</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">BRIGHT</span><span class="p">,</span>
            <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">flush_point</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Helper function just flushing a point to stdout to indicate</span>
<span class="sd">            progress.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c"># Collect all reports and error counts.</span>
        <span class="n">reports</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_error_count</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">add_report</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">error_count</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Helper method adding a new error message.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">reports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">total_error_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">error_count</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_event_files</span><span class="p">(</span><span class="n">ok_string</span><span class="p">,</span> <span class="n">fail_string</span><span class="p">,</span>
                                   <span class="n">flush_point</span><span class="p">,</span> <span class="n">add_report</span><span class="p">)</span>

        <span class="c"># Update all caches so the rest can work faster.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_all_waveform_caches</span><span class="p">(</span><span class="n">ok_string</span><span class="p">,</span> <span class="n">fail_string</span><span class="p">,</span>
                                         <span class="n">flush_point</span><span class="p">,</span> <span class="n">add_report</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__update_station_cache</span><span class="p">(</span><span class="n">show_progress</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># Assert that all waveform files have a corresponding station file.</span>
        <span class="k">if</span> <span class="n">station_file_availability</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_station_files_availability</span><span class="p">(</span><span class="n">ok_string</span><span class="p">,</span> <span class="n">fail_string</span><span class="p">,</span>
                                                      <span class="n">flush_point</span><span class="p">,</span> <span class="n">add_report</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">Skipping station files availability check.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">YELLOW</span><span class="p">,</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="p">))</span>

        <span class="c"># Assert that all waveform files have a corresponding station file.</span>
        <span class="k">if</span> <span class="n">waveforms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_waveform_files</span><span class="p">(</span><span class="n">ok_string</span><span class="p">,</span> <span class="n">fail_string</span><span class="p">,</span> <span class="n">flush_point</span><span class="p">,</span>
                                          <span class="n">add_report</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">Skipping waveform file validation.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">YELLOW</span><span class="p">,</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="p">))</span>

        <span class="c"># self._validate_coordinate_deduction(ok_string, fail_string,</span>
        <span class="c"># flush_point, add_report)</span>

        <span class="k">if</span> <span class="n">raypaths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_raypaths_in_domain</span><span class="p">(</span><span class="n">ok_string</span><span class="p">,</span> <span class="n">fail_string</span><span class="p">,</span>
                                              <span class="n">flush_point</span><span class="p">,</span> <span class="n">add_report</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">Skipping raypath check.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">YELLOW</span><span class="p">,</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="p">))</span>

        <span class="c"># Depending on whether or not the tests passed, report it accordingly.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reports</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s">ALL CHECKS PASSED</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span>
                  <span class="s">&quot;The data seems to be valid. If we missed something please &quot;</span>
                  <span class="s">&quot;contact the developers.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span><span class="p">,</span>
                                               <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_output_folder</span><span class="p">(</span>
                <span class="s">&quot;DATA_INTEGRITY_REPORT&quot;</span><span class="p">),</span> <span class="s">&quot;report.txt&quot;</span><span class="p">)</span>
            <span class="n">seperator_string</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="mi">80</span> <span class="o">*</span> <span class="s">&quot;=&quot;</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="mi">80</span> <span class="o">*</span> <span class="s">&quot;=&quot;</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">report</span> <span class="ow">in</span> <span class="n">reports</span><span class="p">:</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">seperator_string</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s">FAILED</span><span class="si">%s</span><span class="se">\n</span><span class="s">Encountered </span><span class="si">%i</span><span class="s"> errors!</span><span class="se">\n</span><span class="s">&quot;</span>
                  <span class="s">&quot;A report has been created at &#39;</span><span class="si">%s</span><span class="s">&#39;.</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span><span class="p">,</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="p">,</span>
                   <span class="n">total_error_count</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">filename</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="Project._validate_raypaths_in_domain"><a class="viewcode-back" href="../../project.html#lasif.project.Project._validate_raypaths_in_domain">[docs]</a>    <span class="k">def</span> <span class="nf">_validate_raypaths_in_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ok_string</span><span class="p">,</span> <span class="n">fail_string</span><span class="p">,</span> <span class="n">flush_point</span><span class="p">,</span>
                                     <span class="n">add_report</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks that all raypaths are within the specified domain boundaries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">print</span> <span class="s">&quot;Making sure raypaths are within boundaries &quot;</span><span class="p">,</span>

        <span class="n">all_good</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
            <span class="n">waveform_files_for_event</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_waveform_cache_file</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_values</span><span class="p">()</span>
            <span class="n">flush_point</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">station_id</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_stations_for_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">network_code</span><span class="p">,</span> <span class="n">station_code</span> <span class="o">=</span> <span class="n">station_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span>
                <span class="c"># Check if the whole path of the event-station pair is within</span>
                <span class="c"># the domain boundaries.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_event_station_raypath_within_boundaries</span><span class="p">(</span>
                        <span class="n">event</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="s">&quot;latitude&quot;</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="s">&quot;longitude&quot;</span><span class="p">],</span>
                        <span class="n">raypath_steps</span><span class="o">=</span><span class="mi">12</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="c"># Otherwise get all waveform files for that station.</span>
                <span class="n">waveform_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">_i</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">]</span>
                                  <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">waveform_files_for_event</span>
                                  <span class="k">if</span> <span class="p">(</span><span class="n">_i</span><span class="p">[</span><span class="s">&quot;network&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">network_code</span><span class="p">)</span> <span class="ow">and</span>
                                  <span class="p">(</span><span class="n">_i</span><span class="p">[</span><span class="s">&quot;station&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">station_code</span><span class="p">)]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">waveform_files</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">all_good</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">waveform_files</span><span class="p">:</span>
                    <span class="n">add_report</span><span class="p">(</span>
                        <span class="s">&quot;WARNING: &quot;</span>
                        <span class="s">&quot;The event-station raypath for the file</span><span class="se">\n\t</span><span class="s">&#39;{f}&#39;</span><span class="se">\n</span><span class="s"> &quot;</span>
                        <span class="s">&quot;does not fully lay within the domain. You might want &quot;</span>
                        <span class="s">&quot;to remove the file or change the domain &quot;</span>
                        <span class="s">&quot;specifications.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">filename</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">all_good</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">ok_string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">fail_string</span>
</div>
<div class="viewcode-block" id="Project._update_all_waveform_caches"><a class="viewcode-back" href="../../project.html#lasif.project.Project._update_all_waveform_caches">[docs]</a>    <span class="k">def</span> <span class="nf">_update_all_waveform_caches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ok_string</span><span class="p">,</span> <span class="n">fail_string</span><span class="p">,</span>
                                    <span class="n">flush_point</span><span class="p">,</span> <span class="n">add_report</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update all waveform caches.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">print</span> <span class="s">&quot;Updating all raw waveform caches &quot;</span><span class="p">,</span>
        <span class="k">for</span> <span class="n">event_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
            <span class="n">flush_point</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_waveform_cache_file</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">,</span>
                                          <span class="n">show_progress</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">ok_string</span>
</div>
<div class="viewcode-block" id="Project._validate_station_files_availability"><a class="viewcode-back" href="../../project.html#lasif.project.Project._validate_station_files_availability">[docs]</a>    <span class="k">def</span> <span class="nf">_validate_station_files_availability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ok_string</span><span class="p">,</span> <span class="n">fail_string</span><span class="p">,</span>
                                             <span class="n">flush_point</span><span class="p">,</span> <span class="n">add_report</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks that all waveform files have an associated station file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">obspy</span> <span class="kn">import</span> <span class="n">UTCDateTime</span>

        <span class="k">print</span> <span class="p">(</span><span class="s">&quot;Confirming that station metainformation files exist for &quot;</span>
               <span class="s">&quot;all waveforms &quot;</span><span class="p">),</span>

        <span class="n">station_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_cache</span>
        <span class="n">all_good</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># Loop over all events.</span>
        <span class="k">for</span> <span class="n">event_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
            <span class="n">flush_point</span><span class="p">()</span>
            <span class="c"># Get all waveform files for the current event.</span>
            <span class="n">waveform_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_waveform_cache_file</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">,</span>
                                                           <span class="n">show_progress</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="c"># If there are none, skip.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">waveform_cache</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c"># Now loop over all channels.</span>
            <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">waveform_cache</span><span class="o">.</span><span class="n">get_values</span><span class="p">():</span>
                <span class="c"># Check if a station file is in the station file cache.</span>
                <span class="n">station_file</span> <span class="o">=</span> <span class="n">station_cache</span><span class="o">.</span><span class="n">get_station_filename</span><span class="p">(</span>
                    <span class="n">channel</span><span class="p">[</span><span class="s">&quot;channel_id&quot;</span><span class="p">],</span>
                    <span class="n">UTCDateTime</span><span class="p">(</span><span class="n">channel</span><span class="p">[</span><span class="s">&quot;starttime_timestamp&quot;</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">station_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">add_report</span><span class="p">(</span>
                    <span class="s">&quot;WARNING: &quot;</span>
                    <span class="s">&quot;No station metainformation available for the waveform &quot;</span>
                    <span class="s">&quot;file</span><span class="se">\n\t</span><span class="s">&#39;{waveform_file}&#39;</span><span class="se">\n</span><span class="s">&quot;</span>
                    <span class="s">&quot;If you have a station file for that channel make sure &quot;</span>
                    <span class="s">&quot;it actually covers the time span of the data.</span><span class="se">\n</span><span class="s">&quot;</span>
                    <span class="s">&quot;Otherwise contact the developers...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">waveform_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">channel</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">])))</span>
                <span class="n">all_good</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">all_good</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">ok_string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">fail_string</span>
</div>
<div class="viewcode-block" id="Project._validate_waveform_files"><a class="viewcode-back" href="../../project.html#lasif.project.Project._validate_waveform_files">[docs]</a>    <span class="k">def</span> <span class="nf">_validate_waveform_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ok_string</span><span class="p">,</span> <span class="n">fail_string</span><span class="p">,</span> <span class="n">flush_point</span><span class="p">,</span>
                                 <span class="n">add_report</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes sure all waveform files are acceptable.</span>

<span class="sd">        It checks that:</span>

<span class="sd">        * each station only has data from one location for each event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">print</span> <span class="s">&quot;Checking all waveform files &quot;</span><span class="p">,</span>
        <span class="kn">import</span> <span class="nn">collections</span>

        <span class="n">all_good</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># Loop over all events.</span>
        <span class="k">for</span> <span class="n">event_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
            <span class="n">flush_point</span><span class="p">()</span>
            <span class="c"># Get all waveform files for the current event.</span>
            <span class="n">waveform_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_waveform_cache_file</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">,</span>
                                                           <span class="n">show_progress</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="n">waveform_cache</span><span class="o">.</span><span class="n">get_values</span><span class="p">()</span>

            <span class="n">stations</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">cha</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
                <span class="n">stations</span><span class="p">[</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cha</span><span class="p">[</span><span class="s">&quot;network&quot;</span><span class="p">],</span> <span class="n">cha</span><span class="p">[</span><span class="s">&quot;station&quot;</span><span class="p">])]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                    <span class="n">cha</span><span class="p">[</span><span class="s">&quot;channel_id&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="c"># Loop and warn for duplicate ones.</span>
            <span class="k">for</span> <span class="n">station_id</span><span class="p">,</span> <span class="n">combinations</span> <span class="ow">in</span> <span class="n">stations</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">combinations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">all_good</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="c"># Otherwise get all files for the faulty station.</span>
                <span class="n">files</span> <span class="o">=</span> <span class="n">waveform_cache</span><span class="o">.</span><span class="n">get_files_for_station</span><span class="p">(</span>
                    <span class="o">*</span><span class="n">station_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">))</span>
                <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">_i</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">files</span><span class="p">])</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;The station &#39;{station}&#39; has more then one combination &quot;</span>
                       <span class="s">&quot;of location and channel type for event {event}. &quot;</span>
                       <span class="s">&quot;Please assure that only one combination is present. &quot;</span>
                       <span class="s">&quot;The offending files are: </span><span class="se">\n\t</span><span class="s">{files}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">station</span><span class="o">=</span><span class="n">station_id</span><span class="p">,</span>
                    <span class="n">event</span><span class="o">=</span><span class="n">event_name</span><span class="p">,</span>
                    <span class="n">files</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">_i</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]))</span>
                <span class="n">add_report</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">all_good</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">ok_string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">fail_string</span>
</div>
<div class="viewcode-block" id="Project._validate_event_files"><a class="viewcode-back" href="../../project.html#lasif.project.Project._validate_event_files">[docs]</a>    <span class="k">def</span> <span class="nf">_validate_event_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ok_string</span><span class="p">,</span> <span class="n">fail_string</span><span class="p">,</span> <span class="n">flush_point</span><span class="p">,</span>
                              <span class="n">add_report</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates all event files in the currently active project.</span>

<span class="sd">        The following tasks are performed:</span>
<span class="sd">            * Validate against QuakeML 1.2 scheme.</span>
<span class="sd">            * Check for duplicate ids amongst all QuakeML files.</span>
<span class="sd">            * Make sure they contain at least one origin, magnitude and focal</span>
<span class="sd">              mechanism object.</span>
<span class="sd">            * Some simply sanity checks so that the event depth is reasonable</span>
<span class="sd">              and the moment tensor values as well. This is rather fragile and</span>
<span class="sd">              mainly intended to detect values specified in wrong units.</span>
<span class="sd">            * Events that are too close in time. Events that are less then one</span>
<span class="sd">              hour apart can in general not be used for adjoint tomography.</span>
<span class="sd">              This will naturally also detect duplicate events.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">collections</span>
        <span class="kn">import</span> <span class="nn">itertools</span>
        <span class="kn">import</span> <span class="nn">math</span>
        <span class="kn">from</span> <span class="nn">obspy</span> <span class="kn">import</span> <span class="n">readEvents</span>
        <span class="kn">from</span> <span class="nn">obspy.core.event</span> <span class="kn">import</span> <span class="n">ResourceIdentifier</span>
        <span class="kn">from</span> <span class="nn">obspy.core.quakeml</span> <span class="kn">import</span> <span class="n">_validate</span> <span class="k">as</span> <span class="n">validate_quakeml</span>
        <span class="kn">from</span> <span class="nn">lasif</span> <span class="kn">import</span> <span class="n">utils</span>
        <span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>

        <span class="k">print</span> <span class="s">&quot;Validating </span><span class="si">%i</span><span class="s"> event files ...&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">)</span>

        <span class="c"># Start with the schema validation.</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Validating against QuakeML 1.2 schema &quot;</span><span class="p">,</span>
        <span class="n">all_valid</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">]</span>
            <span class="n">flush_point</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">validate_quakeml</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">all_valid</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s">&quot;ERROR: &quot;</span>
                    <span class="s">&quot;The QuakeML file &#39;{basename}&#39; did not validate against &quot;</span>
                    <span class="s">&quot;the QuakeML 1.2 schema. Unfortunately the error messages &quot;</span>
                    <span class="s">&quot;delivered by lxml are not useful at all. To get useful &quot;</span>
                    <span class="s">&quot;error messages make sure jing is installed &quot;</span>
                    <span class="s">&quot;(&#39;brew install jing&#39; (OSX) or &quot;</span>
                    <span class="s">&quot;&#39;sudo apt-get install jing&#39; (Debian/Ubuntu)) and &quot;</span>
                    <span class="s">&quot;execute the following command:</span><span class="se">\n\n</span><span class="s">&quot;</span>
                    <span class="s">&quot;</span><span class="se">\t</span><span class="s">jing http://quake.ethz.ch/schema/rng/QuakeML-1.2.rng &quot;</span>
                    <span class="s">&quot;{filename}</span><span class="se">\n\n</span><span class="s">&quot;</span>
                    <span class="s">&quot;Alternatively you could also use the &quot;</span>
                    <span class="s">&quot;&#39;lasif add_spud_event&#39; command to redownload the event &quot;</span>
                    <span class="s">&quot;if it is in the GCMT &quot;</span>
                    <span class="s">&quot;catalog.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">basename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
                    <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
                <span class="n">add_report</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">all_valid</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">ok_string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">fail_string</span>

        <span class="c"># Now check for duplicate public IDs.</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Checking for duplicate public IDs &quot;</span><span class="p">,</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">]</span>
            <span class="n">flush_point</span><span class="p">()</span>
            <span class="c"># Now walk all files and collect all public ids. Each should be</span>
            <span class="c"># unique!</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">event</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">etree</span><span class="o">.</span><span class="n">iterparse</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">events</span><span class="o">=</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">,)):</span>
                    <span class="k">if</span> <span class="s">&quot;publicID&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">elem</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> \
                            <span class="n">elem</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;eventParameters&quot;</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">ids</span><span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;publicID&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ids</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span>
               <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">ok_string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">fail_string</span>
            <span class="n">add_report</span><span class="p">(</span>
                <span class="s">&quot;Found the following duplicate publicIDs:</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span>
                <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="s"> in files: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">id_string</span><span class="p">,</span>
                    <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">faulty_files</span><span class="p">]))</span>
                    <span class="k">for</span> <span class="n">id_string</span><span class="p">,</span> <span class="n">faulty_files</span> <span class="ow">in</span> <span class="n">ids</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()]),</span>
                <span class="n">error_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">print_warning</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
            <span class="n">add_report</span><span class="p">(</span><span class="s">&quot;WARNING: File &#39;{event_name}&#39; &quot;</span>
                       <span class="s">&quot;contains {msg}.</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                           <span class="n">event_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
                           <span class="n">msg</span><span class="o">=</span><span class="n">message</span><span class="p">))</span>

        <span class="c"># Performing simple sanity checks.</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Performing some basic sanity checks &quot;</span><span class="p">,</span>
        <span class="n">all_good</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">]</span>
            <span class="n">flush_point</span><span class="p">()</span>
            <span class="n">cat</span> <span class="o">=</span> <span class="n">readEvents</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="c"># Check that all files contain exactly one event!</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">all_good</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">print_warning</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%i</span><span class="s"> events instead of only one.&quot;</span> <span class="o">%</span>
                              <span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">))</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c"># Sanity checks related to the origin.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">origins</span><span class="p">:</span>
                <span class="n">all_good</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">print_warning</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;no origin&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">preferred_origin</span><span class="p">()</span> <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">origins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">origin</span><span class="o">.</span><span class="n">depth</span> <span class="o">%</span> <span class="mf">100.0</span><span class="p">):</span>
                <span class="n">all_good</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">print_warning</span><span class="p">(</span>
                    <span class="n">filename</span><span class="p">,</span> <span class="s">&quot;a depth of </span><span class="si">%.1f</span><span class="s"> meters. This kind of &quot;</span>
                    <span class="s">&quot;accuracy seems unrealistic. The depth in the QuakeML &quot;</span>
                    <span class="s">&quot;file has to be specified in meters. Checking all other &quot;</span>
                    <span class="s">&quot;QuakeML files for the correct units might be a good idea&quot;</span>
                    <span class="o">%</span> <span class="n">origin</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">origin</span><span class="o">.</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">800.0</span> <span class="o">*</span> <span class="mf">1000.0</span><span class="p">)):</span>
                <span class="n">all_good</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">print_warning</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;a depth of more than 800 km. This is&quot;</span>
                              <span class="s">&quot; likely wrong.&quot;</span><span class="p">)</span>

            <span class="c"># Sanity checks related to the magnitude.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">magnitudes</span><span class="p">:</span>
                <span class="n">all_good</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">print_warning</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;no magnitude&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c"># Sanity checks related to the focal mechanism.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">focal_mechanisms</span><span class="p">:</span>
                <span class="n">all_good</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">print_warning</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;no focal mechanism&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">focmec</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">preferred_focal_mechanism</span><span class="p">()</span> <span class="ow">or</span> \
                <span class="n">event</span><span class="o">.</span><span class="n">focal_mechanisms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">focmec</span><span class="p">,</span> <span class="s">&quot;moment_tensor&quot;</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="ow">not</span> <span class="n">focmec</span><span class="o">.</span><span class="n">moment_tensor</span><span class="p">:</span>
                <span class="n">all_good</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">print_warning</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;no moment tensor&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">mt</span> <span class="o">=</span> <span class="n">focmec</span><span class="o">.</span><span class="n">moment_tensor</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="s">&quot;tensor&quot;</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="ow">not</span> <span class="n">mt</span><span class="o">.</span><span class="n">tensor</span><span class="p">:</span>
                <span class="n">all_good</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">print_warning</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;no actual moment tensor&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">tensor</span> <span class="o">=</span> <span class="n">mt</span><span class="o">.</span><span class="n">tensor</span>

            <span class="c"># Convert the moment tensor to a magnitude and see if it is</span>
            <span class="c"># reasonable.</span>
            <span class="n">mag_in_file</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">preferred_magnitude</span><span class="p">()</span> <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">magnitudes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mag_in_file</span> <span class="o">=</span> <span class="n">mag_in_file</span><span class="o">.</span><span class="n">mag</span>
            <span class="n">M_0</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="n">tensor</span><span class="o">.</span><span class="n">m_rr</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">tensor</span><span class="o">.</span><span class="n">m_tt</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">tensor</span><span class="o">.</span><span class="n">m_pp</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">magnitude</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">M_0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">6.0</span>
            <span class="c"># Use some buffer to account for different magnitudes.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">mag_in_file</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">magnitude</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mag_in_file</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">):</span>
                <span class="n">all_good</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">print_warning</span><span class="p">(</span>
                    <span class="n">filename</span><span class="p">,</span> <span class="s">&quot;a moment tensor that would result in &quot;</span>
                    <span class="s">&quot;a moment magnitude of </span><span class="si">%.2f</span><span class="s">. The magnitude specified in &quot;</span>
                    <span class="s">&quot;the file is </span><span class="si">%.2f</span><span class="s">. &quot;</span>
                    <span class="s">&quot;Please check that all components of the tensor are in &quot;</span>
                    <span class="s">&quot;Newton * meter&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">mag_in_file</span><span class="p">))</span>

        <span class="c"># HACKISH! Reset the dictionary collecting the id references! This is</span>
        <span class="c"># done to be able to read the same file twice.</span>
        <span class="n">ResourceIdentifier</span><span class="o">.</span><span class="n">_ResourceIdentifier__resource_id_weak_dict</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">all_good</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">ok_string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">fail_string</span>

        <span class="c"># Collect event times</span>
        <span class="n">event_infos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

        <span class="c"># Now check the time distribution of events.</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Checking for duplicates and events too close in time </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">)</span> <span class="o">*</span> <span class="s">&quot;.&quot;</span><span class="p">),</span>
        <span class="n">all_good</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c"># Sort the events by time.</span>
        <span class="n">event_infos</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">event_infos</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s">&quot;origin_time&quot;</span><span class="p">])</span>
        <span class="c"># Loop over adjacent indices.</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">tee</span><span class="p">(</span><span class="n">event_infos</span><span class="p">)</span>
        <span class="nb">next</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">event_1</span><span class="p">,</span> <span class="n">event_2</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">izip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="n">time_diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">event_2</span><span class="p">[</span><span class="s">&quot;origin_time&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">event_1</span><span class="p">[</span><span class="s">&quot;origin_time&quot;</span><span class="p">])</span>
            <span class="c"># If time difference is under one hour, it could be either a</span>
            <span class="c"># duplicate event or interfering events.</span>
            <span class="k">if</span> <span class="n">time_diff</span> <span class="o">&lt;=</span> <span class="mf">3600.0</span><span class="p">:</span>
                <span class="n">all_good</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">add_report</span><span class="p">(</span>
                    <span class="s">&quot;WARNING: &quot;</span>
                    <span class="s">&quot;The time difference between events &#39;{file_1}&#39; and &quot;</span>
                    <span class="s">&quot;&#39;{file_2}&#39; is only {diff:.1f} minutes. This could &quot;</span>
                    <span class="s">&quot;be either due to a duplicate event or events that have &quot;</span>
                    <span class="s">&quot;interfering waveforms.</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">file_1</span><span class="o">=</span><span class="n">event_1</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">],</span>
                        <span class="n">file_2</span><span class="o">=</span><span class="n">event_2</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">],</span>
                        <span class="n">diff</span><span class="o">=</span><span class="n">time_diff</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">all_good</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">ok_string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">fail_string</span>

        <span class="c"># Check that all events fall within the chosen boundaries.</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Assure all events are in chosen domain </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">)</span> <span class="o">*</span> <span class="s">&quot;.&quot;</span><span class="p">),</span>
        <span class="n">all_good</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">event_infos</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">point_in_domain</span><span class="p">(</span>
                    <span class="n">event</span><span class="p">[</span><span class="s">&quot;latitude&quot;</span><span class="p">],</span>
                    <span class="n">event</span><span class="p">[</span><span class="s">&quot;longitude&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;bounds&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_axis&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_angle&quot;</span><span class="p">])</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">all_good</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">add_report</span><span class="p">(</span>
                <span class="s">&quot;</span><span class="se">\n</span><span class="s">WARNING: &quot;</span>
                <span class="s">&quot;Event &#39;{filename}&#39; is out of bounds of the chosen domain.&quot;</span>
                <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">all_good</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">ok_string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">fail_string</span>
</div>
<div class="viewcode-block" id="Project.is_event_station_raypath_within_boundaries"><a class="viewcode-back" href="../../project.html#lasif.project.Project.is_event_station_raypath_within_boundaries">[docs]</a>    <span class="k">def</span> <span class="nf">is_event_station_raypath_within_boundaries</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">station_latitude</span><span class="p">,</span> <span class="n">station_longitude</span><span class="p">,</span>
            <span class="n">raypath_steps</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the full station-event raypath is within the project&#39;s domain</span>
<span class="sd">        boundaries.</span>

<span class="sd">        Returns True if this is the case, False if not.</span>

<span class="sd">        :type event_name: string</span>
<span class="sd">        :param event_name: The project internal event name.</span>
<span class="sd">        :type station_latitude: float</span>
<span class="sd">        :param station_latitude: The station latitude.</span>
<span class="sd">        :type station_longitude: float</span>
<span class="sd">        :param station_longitude: The station longitude.</span>
<span class="sd">        :type raypath_steps: int</span>
<span class="sd">        :param raypath_steps: The number of discrete points along the raypath</span>
<span class="sd">            that will be checked. Optional.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">lasif.utils</span> <span class="kn">import</span> <span class="n">greatcircle_points</span><span class="p">,</span> <span class="n">Point</span><span class="p">,</span> <span class="n">point_in_domain</span>

        <span class="c"># Get the event information.</span>
        <span class="n">ev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">event_name</span><span class="p">]</span>
        <span class="n">event_latitude</span> <span class="o">=</span> <span class="n">ev</span><span class="p">[</span><span class="s">&quot;latitude&quot;</span><span class="p">]</span>
        <span class="n">event_longitude</span> <span class="o">=</span> <span class="n">ev</span><span class="p">[</span><span class="s">&quot;longitude&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">greatcircle_points</span><span class="p">(</span>
                <span class="n">Point</span><span class="p">(</span><span class="n">station_latitude</span><span class="p">,</span> <span class="n">station_longitude</span><span class="p">),</span>
                <span class="n">Point</span><span class="p">(</span><span class="n">event_latitude</span><span class="p">,</span> <span class="n">event_longitude</span><span class="p">),</span>
                <span class="n">max_npts</span><span class="o">=</span><span class="n">raypath_steps</span><span class="p">):</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">point_in_domain</span><span class="p">(</span>
                    <span class="n">point</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">point</span><span class="o">.</span><span class="n">lng</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;bounds&quot;</span><span class="p">],</span>
                    <span class="n">rotation_axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_axis&quot;</span><span class="p">],</span>
                    <span class="n">rotation_angle_in_degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_angle&quot;</span><span class="p">]):</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Project.finalize_adjoint_sources"><a class="viewcode-back" href="../../project.html#lasif.project.Project.finalize_adjoint_sources">[docs]</a>    <span class="k">def</span> <span class="nf">finalize_adjoint_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration_name</span><span class="p">,</span> <span class="n">event_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finalizes the adjoint sources.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">izip</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

        <span class="kn">from</span> <span class="nn">lasif</span> <span class="kn">import</span> <span class="n">rotations</span>
        <span class="kn">from</span> <span class="nn">lasif.window_manager</span> <span class="kn">import</span> <span class="n">MisfitWindowManager</span>
        <span class="kn">from</span> <span class="nn">lasif.adjoint_src_manager</span> <span class="kn">import</span> <span class="n">AdjointSourceManager</span>

        <span class="c"># ====================================================================</span>
        <span class="c"># initialisations</span>
        <span class="c"># ====================================================================</span>

        <span class="n">iteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_iteration</span><span class="p">(</span><span class="n">iteration_name</span><span class="p">)</span>
        <span class="n">long_iteration_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_long_iteration_name</span><span class="p">(</span><span class="n">iteration_name</span><span class="p">)</span>

        <span class="n">window_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;windows&quot;</span><span class="p">],</span> <span class="n">event_name</span><span class="p">,</span>
                                        <span class="n">long_iteration_name</span><span class="p">)</span>
        <span class="n">ad_src_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;adjoint_sources&quot;</span><span class="p">],</span>
                                        <span class="n">event_name</span><span class="p">,</span> <span class="n">long_iteration_name</span><span class="p">)</span>
        <span class="n">window_manager</span> <span class="o">=</span> <span class="n">MisfitWindowManager</span><span class="p">(</span><span class="n">window_directory</span><span class="p">,</span>
                                             <span class="n">long_iteration_name</span><span class="p">,</span> <span class="n">event_name</span><span class="p">)</span>
        <span class="n">adj_src_manager</span> <span class="o">=</span> <span class="n">AdjointSourceManager</span><span class="p">(</span><span class="n">ad_src_directory</span><span class="p">)</span>

        <span class="n">this_event</span> <span class="o">=</span> <span class="n">iteration</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">event_name</span><span class="p">]</span>

        <span class="n">event_weight</span> <span class="o">=</span> <span class="n">this_event</span><span class="p">[</span><span class="s">&quot;event_weight&quot;</span><span class="p">]</span>
        <span class="n">all_stations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stations_for_event</span><span class="p">(</span><span class="n">event_name</span><span class="p">)</span>

        <span class="n">all_coordinates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">_i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">output_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_folder</span><span class="p">(</span>
            <span class="s">&quot;adjoint_sources__ITERATION_</span><span class="si">%s</span><span class="s">__</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iteration_name</span><span class="p">,</span> <span class="n">event_name</span><span class="p">))</span>

        <span class="c"># =====================================================================</span>
        <span class="c"># loop through all the stations of this event</span>
        <span class="c"># =====================================================================</span>

        <span class="k">for</span> <span class="n">station_id</span><span class="p">,</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">this_event</span><span class="p">[</span><span class="s">&quot;stations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">this_station</span> <span class="o">=</span> <span class="n">all_stations</span><span class="p">[</span><span class="n">station_id</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">station_weight</span> <span class="o">=</span> <span class="n">station</span><span class="p">[</span><span class="s">&quot;station_weight&quot;</span><span class="p">]</span>
            <span class="n">windows</span> <span class="o">=</span> <span class="n">window_manager</span><span class="o">.</span><span class="n">get_windows_for_station</span><span class="p">(</span><span class="n">station_id</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">windows</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;No adjoint sources for station &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="n">station_id</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">all_channels</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c"># loop through all channels for that station --------------------</span>
            <span class="k">for</span> <span class="n">channel_windows</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">:</span>

                <span class="n">channel_id</span> <span class="o">=</span> <span class="n">channel_windows</span><span class="p">[</span><span class="s">&quot;channel_id&quot;</span><span class="p">]</span>
                <span class="n">cumulative_weight</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">all_data</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c"># loop through all windows of one channel -------------------</span>
                <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="n">channel_windows</span><span class="p">[</span><span class="s">&quot;windows&quot;</span><span class="p">]:</span>

                    <span class="c"># get window properties</span>
                    <span class="n">window_weight</span> <span class="o">=</span> <span class="n">window</span><span class="p">[</span><span class="s">&quot;weight&quot;</span><span class="p">]</span>
                    <span class="n">starttime</span> <span class="o">=</span> <span class="n">window</span><span class="p">[</span><span class="s">&quot;starttime&quot;</span><span class="p">]</span>
                    <span class="n">endtime</span> <span class="o">=</span> <span class="n">window</span><span class="p">[</span><span class="s">&quot;endtime&quot;</span><span class="p">]</span>
                    <span class="c"># load previously stored adjoint source</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">adj_src_manager</span><span class="o">.</span><span class="n">get_adjoint_src</span><span class="p">(</span><span class="n">channel_id</span><span class="p">,</span>
                                                           <span class="n">starttime</span><span class="p">,</span> <span class="n">endtime</span><span class="p">)</span>
                    <span class="c"># lump all adjoint sources together</span>
                    <span class="n">all_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">window_weight</span> <span class="o">*</span> <span class="n">data</span><span class="p">)</span>
                    <span class="c"># compute cumulative weight of all windows for that channel</span>
                    <span class="n">cumulative_weight</span> <span class="o">+=</span> <span class="n">window_weight</span>

                <span class="c"># apply weights for that channel -----------------------------</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">all_data</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_data</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">+=</span> <span class="n">d</span>
                <span class="n">data</span> <span class="o">/=</span> <span class="n">cumulative_weight</span>
                <span class="n">data</span> <span class="o">*=</span> <span class="n">station_weight</span> <span class="o">*</span> <span class="n">event_weight</span>
                <span class="n">all_channels</span><span class="p">[</span><span class="n">channel_id</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">data</span>

            <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_channels</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c"># Use zero for empty ones.</span>
            <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;N&quot;</span><span class="p">,</span> <span class="s">&quot;E&quot;</span><span class="p">,</span> <span class="s">&quot;Z&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">all_channels</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">all_channels</span><span class="p">[</span><span class="n">component</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>

            <span class="c"># Rotate. if needed ----------------------------------------------</span>

            <span class="n">rec_lat</span> <span class="o">=</span> <span class="n">this_station</span><span class="p">[</span><span class="s">&quot;latitude&quot;</span><span class="p">]</span>
            <span class="n">rec_lng</span> <span class="o">=</span> <span class="n">this_station</span><span class="p">[</span><span class="s">&quot;longitude&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_angle&quot;</span><span class="p">]:</span>
                <span class="c"># Rotate the adjoint source location.</span>
                <span class="n">r_rec_lat</span><span class="p">,</span> <span class="n">r_rec_lng</span> <span class="o">=</span> <span class="n">rotations</span><span class="o">.</span><span class="n">rotate_lat_lon</span><span class="p">(</span>
                    <span class="n">rec_lat</span><span class="p">,</span> <span class="n">rec_lng</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_axis&quot;</span><span class="p">],</span>
                    <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_angle&quot;</span><span class="p">])</span>
                <span class="c"># Rotate the adjoint sources.</span>
                <span class="n">all_channels</span><span class="p">[</span><span class="s">&quot;N&quot;</span><span class="p">],</span> <span class="n">all_channels</span><span class="p">[</span><span class="s">&quot;E&quot;</span><span class="p">],</span> <span class="n">all_channels</span><span class="p">[</span><span class="s">&quot;Z&quot;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">rotations</span><span class="o">.</span><span class="n">rotate_data</span><span class="p">(</span>
                        <span class="n">all_channels</span><span class="p">[</span><span class="s">&quot;N&quot;</span><span class="p">],</span> <span class="n">all_channels</span><span class="p">[</span><span class="s">&quot;E&quot;</span><span class="p">],</span>
                        <span class="n">all_channels</span><span class="p">[</span><span class="s">&quot;Z&quot;</span><span class="p">],</span> <span class="n">rec_lat</span><span class="p">,</span> <span class="n">rec_lng</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_axis&quot;</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="s">&quot;rotation_angle&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r_rec_lat</span> <span class="o">=</span> <span class="n">rec_lat</span>
                <span class="n">r_rec_lng</span> <span class="o">=</span> <span class="n">rec_lng</span>
            <span class="n">r_rec_depth</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">r_rec_colat</span> <span class="o">=</span> <span class="n">rotations</span><span class="o">.</span><span class="n">lat2colat</span><span class="p">(</span><span class="n">r_rec_lat</span><span class="p">)</span>

            <span class="n">CHANNEL_MAPPING</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;X&quot;</span><span class="p">:</span> <span class="s">&quot;N&quot;</span><span class="p">,</span> <span class="s">&quot;Y&quot;</span><span class="p">:</span> <span class="s">&quot;E&quot;</span><span class="p">,</span> <span class="s">&quot;Z&quot;</span><span class="p">:</span> <span class="s">&quot;Z&quot;</span><span class="p">}</span>

            <span class="n">_i</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">adjoint_src_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span>
                                                <span class="s">&quot;ad_src_</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">_i</span><span class="p">)</span>

            <span class="n">all_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">r_rec_colat</span><span class="p">,</span> <span class="n">r_rec_lng</span><span class="p">,</span> <span class="n">r_rec_depth</span><span class="p">))</span>

            <span class="c"># Actually write the adjoint source file in SES3D specific format.</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">adjoint_src_filename</span><span class="p">,</span> <span class="s">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">open_file</span><span class="p">:</span>
                <span class="n">open_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;-- adjoint source ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">open_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;-- source coordinates (colat,lon,depth)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">open_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%f</span><span class="s"> </span><span class="si">%f</span><span class="s"> </span><span class="si">%f</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r_rec_colat</span><span class="p">,</span> <span class="n">r_rec_lng</span><span class="p">,</span>
                                                <span class="n">r_rec_depth</span><span class="p">))</span>
                <span class="n">open_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;-- source time function (x, y, z) --</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">all_channels</span><span class="p">[</span><span class="n">CHANNEL_MAPPING</span><span class="p">[</span><span class="s">&quot;X&quot;</span><span class="p">]],</span>
                                    <span class="n">all_channels</span><span class="p">[</span><span class="n">CHANNEL_MAPPING</span><span class="p">[</span><span class="s">&quot;Y&quot;</span><span class="p">]],</span>
                                    <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">all_channels</span><span class="p">[</span><span class="n">CHANNEL_MAPPING</span><span class="p">[</span><span class="s">&quot;Z&quot;</span><span class="p">]]):</span>
                    <span class="n">open_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%e</span><span class="s"> </span><span class="si">%e</span><span class="s"> </span><span class="si">%e</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
                <span class="n">open_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="c"># Write the final file.</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s">&quot;ad_srcfile&quot;</span><span class="p">),</span> <span class="s">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%i</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">_i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">all_coordinates</span><span class="p">:</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.6f</span><span class="s"> </span><span class="si">%.6f</span><span class="s"> </span><span class="si">%.6f</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="k">print</span> <span class="s">&quot;Wrote </span><span class="si">%i</span><span class="s"> adjoint sources to </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_i</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Project.data_synthetic_iterator"><a class="viewcode-back" href="../../project.html#lasif.project.Project.data_synthetic_iterator">[docs]</a>    <span class="k">def</span> <span class="nf">data_synthetic_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">iteration_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an iterator that returns processed data and synthetic files for</span>
<span class="sd">        one event and iteration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">lasif.tools.two_way_data_synthetics_iterator</span> <span class="kn">import</span> <span class="n">TwoWayIter</span>

        <span class="c"># Retrieve information on the event, iteration and waveforms</span>
        <span class="n">iteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_iteration</span><span class="p">(</span><span class="n">iteration_name</span><span class="p">)</span>
        <span class="c"># This are all stations in the current iteration.</span>
        <span class="n">iteration_stations</span> <span class="o">=</span> <span class="n">iteration</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">event_name</span><span class="p">][</span><span class="s">&quot;stations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="c"># List of all stations for the given event that are also specified in</span>
        <span class="c"># the iterations files. This result in a dictionary with additional</span>
        <span class="c"># metadata per station.</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_stations_for_event</span><span class="p">(</span><span class="n">event_name</span><span class="p">)</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">iteration_stations</span><span class="p">}</span>

        <span class="c"># Get all processed waveforms including metadata for the current event</span>
        <span class="c"># and iteration.</span>
        <span class="n">processed_waveforms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_waveform_cache_file</span><span class="p">(</span>
            <span class="n">event_name</span><span class="p">,</span> <span class="n">iteration</span><span class="o">.</span><span class="n">get_processing_tag</span><span class="p">())</span><span class="o">.</span><span class="n">get_values</span><span class="p">()</span>

        <span class="c"># All synthetic files.</span>
        <span class="n">synthetic_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_synthetic_waveform_filenames</span><span class="p">(</span>
            <span class="n">event_name</span><span class="p">,</span> <span class="n">iteration_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">synthetic_files</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Could not find suitable synthetic files.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_synthetics_callback</span><span class="p">(</span><span class="n">station_id</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_waveform_data</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">station_id</span><span class="p">,</span>
                                          <span class="n">data_type</span><span class="o">=</span><span class="s">&quot;synthetic&quot;</span><span class="p">,</span>
                                          <span class="n">iteration_name</span><span class="o">=</span><span class="n">iteration_name</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_data_callback</span><span class="p">(</span><span class="n">station_id</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_waveform_data</span><span class="p">(</span>
                <span class="n">event_name</span><span class="p">,</span> <span class="n">station_id</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="s">&quot;processed&quot;</span><span class="p">,</span>
                <span class="n">tag</span><span class="o">=</span><span class="n">iteration</span><span class="o">.</span><span class="n">get_processing_tag</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">TwoWayIter</span><span class="p">(</span><span class="n">get_data_callback</span><span class="o">=</span><span class="n">get_data_callback</span><span class="p">,</span>
                          <span class="n">get_synthetics_callback</span><span class="o">=</span><span class="n">get_synthetics_callback</span><span class="p">,</span>
                          <span class="n">stations</span><span class="o">=</span><span class="n">stations</span><span class="p">,</span>
                          <span class="n">processed_waveforms</span><span class="o">=</span><span class="n">processed_waveforms</span><span class="p">,</span>
                          <span class="n">event_name</span><span class="o">=</span><span class="n">event_name</span><span class="p">,</span>
                          <span class="n">iteration_name</span><span class="o">=</span><span class="n">iteration_name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Project.get_debug_information_for_file"><a class="viewcode-back" href="../../project.html#lasif.project.Project.get_debug_information_for_file">[docs]</a>    <span class="k">def</span> <span class="nf">get_debug_information_for_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function returning a string with information LASIF knows about</span>
<span class="sd">        the file.</span>

<span class="sd">        Currently only works with waveform and station files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">obspy</span> <span class="kn">import</span> <span class="n">read</span><span class="p">,</span> <span class="n">UTCDateTime</span>

        <span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;LASIF cannot gather any information from the file.&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c"># Data file.</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonprefix</span><span class="p">([</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">]])</span> <span class="o">==</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">]:</span>
            <span class="c"># Now split the path in event_name, tag, and filename. Any deeper</span>
            <span class="c"># paths should not be allowed.</span>
            <span class="n">rest</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">]))</span>
            <span class="n">event_name</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span>
            <span class="n">rest</span><span class="p">,</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span>
            <span class="c"># Now rest should not be existant anymore</span>
            <span class="k">if</span> <span class="n">rest</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;File is nested too deep in the data directory.&quot;</span>
                <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;preprocessed_&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="s">&quot;The waveform file is a preprocessed file. LASIF will &quot;</span>
                        <span class="s">&quot;not use it to extract any metainformation.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&quot;raw&quot;</span><span class="p">:</span>
                <span class="c"># Get the corresponding waveform cache file.</span>
                <span class="n">waveforms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_waveform_cache_file</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">,</span>
                                                          <span class="n">use_cache</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">waveforms</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;LASIF could not read the waveform file.&quot;</span>
                    <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">details</span> <span class="o">=</span> <span class="n">waveforms</span><span class="o">.</span><span class="n">get_details</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">details</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;LASIF could not read the waveform file.&quot;</span>
                    <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">filetype</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">_format</span>
                <span class="c"># Now assemble the final return string.</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="s">&quot;The {typ} file contains {c} channel{p}:</span><span class="se">\n</span><span class="s">&quot;</span>
                    <span class="s">&quot;{channels}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">typ</span><span class="o">=</span><span class="n">filetype</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">details</span><span class="p">),</span>
                        <span class="n">p</span><span class="o">=</span><span class="s">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">details</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
                        <span class="n">channels</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                            <span class="s">&quot;</span><span class="se">\t</span><span class="s">{chan} | {start} - {end} | &quot;</span>
                            <span class="s">&quot;Lat/Lng/Ele/Dep: {lat}/{lng}/&quot;</span>
                            <span class="s">&quot;{ele}/{dep}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">chan</span><span class="o">=</span><span class="n">_i</span><span class="p">[</span><span class="s">&quot;channel_id&quot;</span><span class="p">],</span>
                                <span class="n">start</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">UTCDateTime</span><span class="p">(</span>
                                    <span class="n">_i</span><span class="p">[</span><span class="s">&quot;starttime_timestamp&quot;</span><span class="p">])),</span>
                                <span class="n">end</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">_i</span><span class="p">[</span><span class="s">&quot;endtime_timestamp&quot;</span><span class="p">])),</span>
                                <span class="n">lat</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">_i</span><span class="p">[</span><span class="s">&quot;latitude&quot;</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">_i</span><span class="p">[</span><span class="s">&quot;latitude&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="s">&quot;--&quot;</span><span class="p">,</span>
                                <span class="n">lng</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">_i</span><span class="p">[</span><span class="s">&quot;longitude&quot;</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">_i</span><span class="p">[</span><span class="s">&quot;longitude&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="s">&quot;--&quot;</span><span class="p">,</span>
                                <span class="n">ele</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">_i</span><span class="p">[</span><span class="s">&quot;elevation_in_m&quot;</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">_i</span><span class="p">[</span><span class="s">&quot;elevation_in_m&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="s">&quot;--&quot;</span><span class="p">,</span>
                                <span class="n">dep</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">_i</span><span class="p">[</span><span class="s">&quot;local_depth_in_m&quot;</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">_i</span><span class="p">[</span><span class="s">&quot;local_depth_in_m&quot;</span><span class="p">]</span>
                                <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="s">&quot;--&quot;</span><span class="p">,</span>
                            <span class="p">)</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">details</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;The waveform tag &#39;</span><span class="si">%s</span><span class="s">&#39; is not used by LASIF.&quot;</span> <span class="o">%</span> <span class="n">tag</span>
                <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c"># Station files.</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonprefix</span><span class="p">([</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;stations&quot;</span><span class="p">]])</span> <span class="o">==</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;stations&quot;</span><span class="p">]:</span>
            <span class="c"># Get the station cache</span>
            <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_cache</span><span class="o">.</span><span class="n">get_details</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">details</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_cache</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s">&quot;resp&quot;</span><span class="p">]:</span>
                <span class="n">filetype</span> <span class="o">=</span> <span class="s">&quot;RESP&quot;</span>
            <span class="k">elif</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_cache</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s">&quot;seed&quot;</span><span class="p">]:</span>
                <span class="n">filetype</span> <span class="o">=</span> <span class="s">&quot;SEED&quot;</span>
            <span class="k">elif</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_cache</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s">&quot;stationxml&quot;</span><span class="p">]:</span>
                <span class="n">filetype</span> <span class="o">=</span> <span class="s">&quot;STATIONXML&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># This really should not happen.</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="c"># Now assemble the final return string.</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="s">&quot;The {typ} file contains information about {c} channel{p}:</span><span class="se">\n</span><span class="s">&quot;</span>
                <span class="s">&quot;{channels}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">typ</span><span class="o">=</span><span class="n">filetype</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">details</span><span class="p">),</span>
                    <span class="n">p</span><span class="o">=</span><span class="s">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">details</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">channels</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                        <span class="s">&quot;</span><span class="se">\t</span><span class="s">{chan} | {start} - {end} | &quot;</span>
                        <span class="s">&quot;Lat/Lng/Ele/Dep: {lat}/{lng}/&quot;</span>
                        <span class="s">&quot;{ele}/{dep}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">chan</span><span class="o">=</span><span class="n">_i</span><span class="p">[</span><span class="s">&quot;channel_id&quot;</span><span class="p">],</span>
                            <span class="n">start</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">_i</span><span class="p">[</span><span class="s">&quot;start_date&quot;</span><span class="p">])),</span>
                            <span class="n">end</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">_i</span><span class="p">[</span><span class="s">&quot;end_date&quot;</span><span class="p">]))</span>
                            <span class="k">if</span> <span class="n">_i</span><span class="p">[</span><span class="s">&quot;end_date&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s">&quot;--&quot;</span><span class="p">,</span>
                            <span class="n">lat</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">_i</span><span class="p">[</span><span class="s">&quot;latitude&quot;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">_i</span><span class="p">[</span><span class="s">&quot;latitude&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="s">&quot;--&quot;</span><span class="p">,</span>
                            <span class="n">lng</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">_i</span><span class="p">[</span><span class="s">&quot;longitude&quot;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">_i</span><span class="p">[</span><span class="s">&quot;longitude&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="s">&quot;--&quot;</span><span class="p">,</span>
                            <span class="n">ele</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">_i</span><span class="p">[</span><span class="s">&quot;elevation_in_m&quot;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">_i</span><span class="p">[</span><span class="s">&quot;elevation_in_m&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="s">&quot;--&quot;</span><span class="p">,</span>
                            <span class="n">dep</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">_i</span><span class="p">[</span><span class="s">&quot;local_depth_in_m&quot;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">_i</span><span class="p">[</span><span class="s">&quot;local_depth_in_m&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="s">&quot;--&quot;</span><span class="p">,</span>
                        <span class="p">)</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">details</span><span class="p">])))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LASIFException</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Project.has_station_file"><a class="viewcode-back" href="../../project.html#lasif.project.Project.has_station_file">[docs]</a>    <span class="k">def</span> <span class="nf">has_station_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simple function returning True or False, if the channel specified with</span>
<span class="sd">        it&#39;s filename actually has a corresponding station file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_cache</span><span class="o">.</span><span class="n">station_info_available</span><span class="p">(</span><span class="n">channel_id</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Project._get_all_raw_waveform_files_for_iteration"><a class="viewcode-back" href="../../project.html#lasif.project.Project._get_all_raw_waveform_files_for_iteration">[docs]</a>    <span class="k">def</span> <span class="nf">_get_all_raw_waveform_files_for_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method returning a list of all raw waveform files for one</span>
<span class="sd">        iteration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">iteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_iteration</span><span class="p">(</span><span class="n">iteration_name</span><span class="p">)</span>
        <span class="n">all_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">iteration</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">waveforms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_waveform_cache_file</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">waveforms</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">stations</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s">&quot;stations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">all_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span><span class="n">_i</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">waveforms</span><span class="o">.</span><span class="n">get_values</span><span class="p">()</span>
                 <span class="k">if</span> <span class="p">(</span><span class="n">_i</span><span class="p">[</span><span class="s">&quot;network&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">_i</span><span class="p">[</span><span class="s">&quot;station&quot;</span><span class="p">])</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">all_files</span>
</div>
<div class="viewcode-block" id="Project._get_long_iteration_name"><a class="viewcode-back" href="../../project.html#lasif.project.Project._get_long_iteration_name">[docs]</a>    <span class="k">def</span> <span class="nf">_get_long_iteration_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_iteration_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function for creating a long iteration name.</span>

<span class="sd">        Used for filenames and folder structure. Very simple and just used for</span>
<span class="sd">        consistencies sake.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&quot;ITERATION_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">short_iteration_name</span>
</div>
<div class="viewcode-block" id="Project._get_synthetic_waveform_filenames"><a class="viewcode-back" href="../../project.html#lasif.project.Project._get_synthetic_waveform_filenames">[docs]</a>    <span class="k">def</span> <span class="nf">_get_synthetic_waveform_filenames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">iteration_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function finding all stations for one simulation, e.g. one event</span>
<span class="sd">        and iteration combination.</span>

<span class="sd">        Currently only uses the filenames for distinction as the current SES3D</span>
<span class="sd">        version does not write that information in the file. Will have to be</span>
<span class="sd">        updated in due time as new solver are incorporated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># First step is to get the folder.</span>
        <span class="n">folder_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s">&quot;synthetics&quot;</span><span class="p">],</span> <span class="n">event_name</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_get_long_iteration_name</span><span class="p">(</span>
                                       <span class="n">iteration_name</span><span class="p">))</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_name</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">component</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">_i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;File &#39;</span><span class="si">%s</span><span class="s">&#39; is not properly named. Will be skipped.&quot;</span> <span class="o">%</span> \
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">station_id</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">)</span>
            <span class="n">stations</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">station_id</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">stations</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">component</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> \
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stations</span>
</div>
<div class="viewcode-block" id="Project.get_iteration_status"><a class="viewcode-back" href="../../project.html#lasif.project.Project.get_iteration_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_iteration_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dictionary with information about the current status of an</span>
<span class="sd">        iteration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">iteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_iteration</span><span class="p">(</span><span class="n">iteration_name</span><span class="p">)</span>
        <span class="n">proc_tag</span> <span class="o">=</span> <span class="n">iteration</span><span class="o">.</span><span class="n">get_processing_tag</span><span class="p">()</span>

        <span class="c"># Dictionary collecting all the information.</span>
        <span class="n">status</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">status</span><span class="p">[</span><span class="s">&quot;channels_not_yet_preprocessed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">status</span><span class="p">[</span><span class="s">&quot;stations_in_iteration_that_do_not_exist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">status</span><span class="p">[</span><span class="s">&quot;synthetic_data_missing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># Now check which events and stations are supposed to be part of the</span>
        <span class="c"># iteration and try to find them and their corresponding preprocessed</span>
        <span class="c"># counterparts.</span>
        <span class="k">for</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">event_info</span> <span class="ow">in</span> <span class="n">iteration</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="c"># Events with a weight of 0 are not considered.</span>
            <span class="k">if</span> <span class="n">event_info</span><span class="p">[</span><span class="s">&quot;event_weight&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c"># Get the existing files. This command can potentially be called</span>
            <span class="c"># multiple times per instance with updates in-between. Thus caching</span>
            <span class="c"># should be disabled.</span>
            <span class="n">raw_waveforms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_waveform_cache_file</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">,</span>
                                                          <span class="n">use_cache</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">proc_waveforms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_waveform_cache_file</span><span class="p">(</span>
                <span class="n">event_name</span><span class="p">,</span> <span class="n">proc_tag</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="c"># Extract the channels if some exist.</span>
            <span class="n">raw_channels</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">raw_waveforms</span><span class="p">:</span>
                <span class="c"># Extract the channels.</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">_i</span><span class="p">[</span><span class="s">&quot;channel_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">raw_waveforms</span><span class="o">.</span><span class="n">get_values</span><span class="p">()]</span>
                <span class="c"># Create a dictionary of all the channels sorted by station.</span>
                <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>
                    <span class="n">station_id</span> <span class="o">=</span> <span class="s">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">raw_channels</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">station_id</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="n">raw_channels</span><span class="p">[</span><span class="n">station_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
            <span class="c"># Extract the processed channels if some exist.</span>
            <span class="k">if</span> <span class="n">proc_waveforms</span><span class="p">:</span>
                <span class="n">proc_channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">_i</span><span class="p">[</span><span class="s">&quot;channel_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span>
                                 <span class="n">proc_waveforms</span><span class="o">.</span><span class="n">get_values</span><span class="p">()]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">proc_channels</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c"># Get the synthetics.</span>
            <span class="n">synthetics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_synthetic_waveform_filenames</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span>
                                                                <span class="n">iteration_name</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">station_id</span><span class="p">,</span> <span class="n">station_info</span> \
                    <span class="ow">in</span> <span class="n">event_info</span><span class="p">[</span><span class="s">&quot;stations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="c"># Stations with a weight of zero are not considered.</span>
                <span class="k">if</span> <span class="n">station_info</span><span class="p">[</span><span class="s">&quot;station_weight&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c"># Get all raw channels that have the current station.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">current_chans</span> <span class="o">=</span> <span class="n">raw_channels</span><span class="p">[</span><span class="n">station_id</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">current_chans</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c"># There should be at least one, otherwise the iteration xml</span>
                <span class="c"># file is wrong.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">current_chans</span><span class="p">:</span>
                    <span class="n">status</span><span class="p">[</span><span class="s">&quot;stations_in_iteration_that_do_not_exist&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s">&quot;Event &#39;</span><span class="si">%s</span><span class="s">&#39;: &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">station_id</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">current_chans</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">proc_channels</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">status</span><span class="p">[</span><span class="s">&quot;channels_not_yet_preprocessed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s">&quot;Event &#39;</span><span class="si">%s</span><span class="s">&#39;: &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">chan</span><span class="p">))</span>

                <span class="c"># Each station requires all three synthetic components. This is</span>
                <span class="c"># necessary for rotations.</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">station_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">synthetics</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">synthetics</span><span class="p">[</span><span class="n">station_id</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">):</span>
                    <span class="n">status</span><span class="p">[</span><span class="s">&quot;synthetic_data_missing&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="n">status</span><span class="p">[</span><span class="s">&quot;synthetic_data_missing&quot;</span><span class="p">][</span><span class="n">event_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">station_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">status</span></div></div>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Lion Krischer &amp; Andreas Fichtner.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>