

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>13. Misfit and Adjoint Source Calculation &mdash; LASIF 0.1.x documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="14. Gradient Visualization" href="13_gradient_visualization.html" />
    <link rel="prev" title="12. Synthetics" href="11_synthetic_waveforms.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> LASIF
          

          
          </a>

          
            
            
              <div class="version">
                0.1.x
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../prerequisites.html">Installation, Testing &amp; DevInfo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorial.html">Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="00_interfaces.html">1. Interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="01_creating_a_new_project.html">2. Creating a New Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_seismic_events.html">3. Seismic Events</a></li>
<li class="toctree-l2"><a class="reference internal" href="03_station_data.html">4. Station Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="04_download_helpers.html">5. Download Helpers</a></li>
<li class="toctree-l2"><a class="reference internal" href="05_data_inspection.html">6. Data Inspection</a></li>
<li class="toctree-l2"><a class="reference internal" href="06_data_validation.html">7. Data Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="07_a_new_iteration.html">8. Defining a New Iteration</a></li>
<li class="toctree-l2"><a class="reference internal" href="08_data_processing.html">9. Data Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="09_model_handling.html">10. Earth Model Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="10_generating_input_files.html">11. Generating Input Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="11_synthetic_waveforms.html">12. Synthetics</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">13. Misfit and Adjoint Source Calculation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#weighting-scheme">13.1. Weighting Scheme</a></li>
<li class="toctree-l3"><a class="reference internal" href="#misfit-gui">13.2. Misfit GUI</a></li>
<li class="toctree-l3"><a class="reference internal" href="#window-selection">13.3. Window Selection</a></li>
<li class="toctree-l3"><a class="reference internal" href="#final-adjoint-source-calculation">13.4. Final Adjoint Source Calculation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="13_gradient_visualization.html">14. Gradient Visualization</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../cli.html">Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../meshing.html">Meshing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../webinterface.html">Web Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_doc.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQ</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">LASIF</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../tutorial.html">Tutorial</a> &raquo;</li>
        
      <li>13. Misfit and Adjoint Source Calculation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/tutorial/12_misfits_and_adjoint_sources.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p class="centered">
<strong>Last updated on <em>February 23rd 2018</em>.</strong></p><div class="section" id="misfit-and-adjoint-source-calculation">
<h1>13. Misfit and Adjoint Source Calculation<a class="headerlink" href="#misfit-and-adjoint-source-calculation" title="Permalink to this headline">¶</a></h1>
<p>In order to calculate sensitivity kernels (gradients) for a given combination
of model and data, one needs calculate the adjoint sources. An adjoint source
is usually dependent on the misfit between the synthetics and real data.</p>
<p>LASIF currently supports misfits in the time-frequency domain as defined by
<a class="reference external" href="https://doi.org/10.1111/j.1365-246X.2008.03923.x">Fichtner et al. (GJI 2008)</a> Great care has to be taken
to avoid cycle skips/phase jumps between synthetics and data. This is achieved
by careful windowing.</p>
<div class="section" id="weighting-scheme">
<h2>13.1. Weighting Scheme<a class="headerlink" href="#weighting-scheme" title="Permalink to this headline">¶</a></h2>
<p>You may notice that at various points it is possible to
distribute weights. These weights all contribute to the final adjoint source.
The inversion scheme requires one adjoint source per iteration, event, station,
and component.</p>
<p>We already described the <code class="docutils literal notranslate"><span class="pre">lasif</span> <span class="pre">compute_station_weights</span></code> function that
weighs stations up and down depending on the average distance to the other
stations. But it is also possible to weigh events up or down depending on
preference. Right now this is only possible to do manually but we might add
an automatic function that applies a similar scheme as the station weights.
If you have already computed station weights like we did in this tutorial
you can access the weights in the file <em>/SETS/WEIGHTS/WEIGHTS_A/WEIGHTS_A.TOML</em>.
In there you can manually modify the weights of the events which will in the
end influence the adjoint sources. If you have however not yet computed
station weights and you only want to modify event weights you can do so by
running <code class="docutils literal notranslate"><span class="pre">lasif</span> <span class="pre">create_weight_set</span> <span class="pre">A</span></code> and then modify the same file.</p>
<p>After we have computed windows, which we will do later we can modify the
weights of the windows but more on that later.</p>
<p>Assuming <span class="math notranslate nohighlight">\(N\)</span> windows in a given component, the corresponding
adjoint sources will be called <span class="math notranslate nohighlight">\(adj\_source_{1..N}\)</span> while their
weights are <span class="math notranslate nohighlight">\(w_{1..N}\)</span>. The final adjoint source for every component
will be calculated according to the following formula:</p>
<div class="math notranslate nohighlight">
\[adj\_source = w_{event} \cdot w_{station} \cdot \frac{1}{\sum_{i=1}^N w_i} \cdot \sum_{i=1}^N w_i \cdot ad\_src_i\]</div>
</div>
<div class="section" id="misfit-gui">
<h2>13.2. Misfit GUI<a class="headerlink" href="#misfit-gui" title="Permalink to this headline">¶</a></h2>
<p>LASIF comes with a graphical utility called the Misfit GUI, that helps to pick
correct windows. To launch it, simply type</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ lasif launch_misfit_gui
</pre></div>
</div>
<p>This will open a window that looks like the following:</p>
<a class="reference internal image-reference" href="../_images/misfit_gui_nowindows.png"><img alt="../_images/misfit_gui_nowindows.png" class="align-center" src="../_images/misfit_gui_nowindows.png" style="width: 90%;" /></a>
<p>In the top right part of the GUI, you can choose which iteration and which
event you want to see the synthetics of. The scroll menu shows all the stations
for which data are available, and you can go to the next station using either
mouse or keyboard up/down arrows. The map in the bottom right will show which
event-station combination is currently plotted.</p>
<p>With the <strong>Next</strong> and <strong>Prev</strong> button you can jump from one station to the
next. The <strong>Delete Windows</strong> button will remove all windows for the current
station. <strong>Autoselect</strong> will run the automatic window selection algorithm for
the currently selected station. It is possible to zoom into the waveforms
and then press <strong>Reset View</strong> to get back. If a station shows flawed data
and you do not want to use it, you can press <strong>Delete Station</strong> and it will
remove the station from the raw data for this event.</p>
<p>It is possible to display only the data and in that case it is possible to
experiment with processing parameters by processing the waveforms as they are
displayed.</p>
<p>To actually choose a window click twice - once for the start and once for the
end of a window. It will be saved and the adjoint source will be calculated.
You can then edit the window by dragging its endpoints.</p>
<p>Double clicking on an already existing window will delete it, <code class="docutils literal notranslate"><span class="pre">Alt</span></code> +
clicking will show the time frequency phase misfit as well as the calculated
adjoint source.</p>
<p>The windows are saved in a toml file in <em>SETS/WINDOWS/</em>. This is where you
can adjust the window weights.</p>
<p>The misfit GUI is still under development and we are on a constant quest to
improve it. If you have any idea on how it might be improved, please contact
the developers.</p>
</div>
<div class="section" id="window-selection">
<h2>13.3. Window Selection<a class="headerlink" href="#window-selection" title="Permalink to this headline">¶</a></h2>
<p>As an alternative to going through each event-station pair, you can tell LASIF
to select the windows automatically using. (Keep in mind that this can be quite
time consuming)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ mpirun -n <span class="m">4</span> lasif select_windows <span class="m">1</span> A
</pre></div>
</div>
<p>for all events, iteration 1 and weight set A. This currently only works with
mpi so you have to use that for the automatic window selection but modify the
number behind the -n to the amount of cores you can/want to use. If you only
want to select windows for a specific event you can specify the event name
as a last argument. <strong>Use these tools with caution and check their result!</strong></p>
<p>When the misfit GUI is opened again, it can display the windows from
each window set you have. Now it looks like this:</p>
<a class="reference internal image-reference" href="../_images/misfit_gui_withwindows.png"><img alt="../_images/misfit_gui_withwindows.png" class="align-center" src="../_images/misfit_gui_withwindows.png" style="width: 90%;" /></a>
<p>Here you can verify and modify your windows at will using the previously
described functionalities.
As well as looking at the windows in the GUI, LASIF comes with a number of
utilities to help judging the quality of the selected windows. Two of them
are: (Below is an example from another project.)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ lasif plot_windows EVENT_NAME WEIGHT_SET
$ lasif plot_window_statistics WEIGHT_SET EVENT_NAME
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/combined_selected_windows.png"><img alt="../_images/combined_selected_windows.png" class="align-center" src="../_images/combined_selected_windows.png" style="width: 90%;" /></a>
</div>
<div class="section" id="final-adjoint-source-calculation">
<h2>13.4. Final Adjoint Source Calculation<a class="headerlink" href="#final-adjoint-source-calculation" title="Permalink to this headline">¶</a></h2>
<p>To calculate the adjoint sources and store them you can run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ mpirun -n <span class="m">4</span> lasif calculate_adjoint_sources <span class="m">1</span> A
</pre></div>
</div>
<p>This currently only works with mpi and it can also work for one event at a time
by inputting the event name at the end. This will take each adjoint source
for each station with a window, combine them into one waveform and rotate
them to the correct frame of reference that Salvus expects.</p>
<p>If you change your windows or any weights you will need to calculate the
adjoint sources again.</p>
<p>Now that the adjoint sources are ready, you should be able to generate
input files for your adjoint simulation.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ lasif generate_input_files <span class="m">1</span> adjoint
</pre></div>
</div>
<p>Now everything should be ready to run your adjoint simulation and calculate
a gradient (sensitivity kernel).</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="13_gradient_visualization.html" class="btn btn-neutral float-right" title="14. Gradient Visualization" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="11_synthetic_waveforms.html" class="btn btn-neutral" title="12. Synthetics" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Lion Krischer &amp; Andreas Fichtner.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1.x',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>